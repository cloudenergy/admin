angular.module("app").controller("departmentInfo",["$scope","$timeout","$uibModal","$api","Auth","uiGridConstants","$q","UI","$rootScope","$filter","i18nService",function(e,t,n,i,a,o,l,r,c,s,d){d.add("zh-cn",{aggregation:{sum:"合计："}}),a.Check(e.operateStatus={create:{isEnable:!1,url:"/create"},delete:{isEnable:!1,url:"/delete"},edit:{isEnable:!1,url:"/update"}},function(){var a=EMAPP.Account._id+".department.info.pagesize",d=EMAPP.Account._id+".department.info.status";c=e,e.statusenum=[{id:0,title:"全部"},{id:1,title:"正常"},{id:2,title:"欠费"}],e.chargeAble="TENEMENTFINANCE"===EMAPP.Account.character._id,e.statusenum.selected=parseInt(localStorage.getItem(d)||e.statusenum[0].id),e.multiCheck=function(t){"all"===t?(e.multiCheck.all&&(e.showButton=!0),!e.multiCheck.all&&(e.showButton=!1),angular.forEach(e.listData,function(t){t.isSelected=e.multiCheck.all})):(e.multiCheck.all=!0,e.showButton=!1,angular.forEach(e.listData,function(t){t.isSelected||delete e.multiCheck.all,t.isSelected&&(e.showButton=!0)}))},e.multiIds=function(t){var n=[];return angular.forEach(e.listData,function(e){e.isSelected&&"delete"===t?n.push(e._id):e.isSelected&&"remindrecharge"===t&&e.account.billingAccount.cash<0&&n.push(e.account._id)}),n},e.paging={total:0,index:1,size:parseInt(localStorage.getItem(a)||10),items:[{key:10,title:"每页10条"},{key:15,title:"每页15条"},{key:30,title:"每页30条"},{key:50,title:"每页50条"},{key:100,title:"每页100条"}]},e.GetDepartment=function(){e.multiCheck.all=!1,e.showButton=!1,e.listData&&e.listData.loading||(e.listData&&(e.listData.loading=!0),i.department.info({project:e.Project.selected._id,keyreg:e.departmentKey,amount:e.filterAmount?parseFloat(e.filterAmount):void 0,arrear:{1:!1,2:!0}[e.statusenum.selected],pageindex:e.paging.index,pagesize:e.paging.size},function(t){t=t.result||{},t.detail=angular.isArray(t.detail)&&t.detail||t.detail&&[t.detail]||[],angular.forEach(t.detail,function(e){e.account&&e.account.billingAccount&&(e.account.billingAccount.cash<0?e.status="欠费":e.status="正常"),e.sensorAll=[],angular.forEach(e.sensors,function(t){e.sensorAll.push(t.title+"\n"),t.status.switch={EMC_ON:!0,EMC_OFF:!1}[t.status.switch]||!1}),e.sensorAll=e.sensorAll.join("")}),e.listData=t.detail,e.listData.index=(t.paging||{}).pageindex||1,e.listData.total=(t.paging||{}).count||0}))},e.$watch("Project.selected",function(){e.paging.index=1,e.GetDepartment()}),e.$watch("statusenum.selected",function(t){localStorage.setItem(d,t),e.paging.index=1,e.listData&&e.GetDepartment()}),e.$watch("paging.index",function(t){e.listData&&e.GetDepartment()}),e.$watch("paging.size",function(n){e.multiCheck.all=!1,localStorage.setItem(a,n),t(e.listData&&e.GetDepartment)}),e.DoRemove=function(){var t=e;n.open({size:"sm",templateUrl:"departmentDelete.html",controller:["$scope","$uibModalInstance","$api","md5",function(e,n,i,a){e.cancel=function(){n.dismiss()},e.ok=function(){n.dismiss(),i.department.delete({id:t.multiIds("delete")},function(e){t.GetDepartment()},function(e){r.AlertError(" ",e.data.message)})}}]})},e.switchControl=function(e){n.open({size:"sm",templateUrl:"switch_control.html",controller:["$scope","$uibModalInstance","$api",function(t,n,i){t.OnSubmit=function(){i.control.send({id:e.sid,uid:EMAPP.Account._id,project:e.project,ctrlcode:(new Hashes.SHA1).hex(t.password).toUpperCase(),command:"EMC_SWITCH",param:{mode:e.status.switch?"EMC_ON":"EMC_OFF"}},function(e){e.code?r.AlertError(" ",e.message):n.close()})},t.OnCancel=n.dismiss}]}).result.then(function(){},function(){e.status.switch=!e.status.switch})},e.amount=function(e,a,d){n.open({size:"md",windowClass:"amount",templateUrl:"amount.html",controller:["$scope","$uibModalInstance",function(u,p){u.title=e,u.account=a,u.amount=d,i.payment.channelinfo({type:"manual",project:u.Project.selected._id,flow:"EARNING"},function(e){u.channels=e.result}),u.OnChargeLog=function(e){n.open({size:"lg",templateUrl:"amount_list.html",controller:["$scope","$uibModalInstance",function(n,a){n.startDate=s("date")(new Date,"yyyy-MM-01"),n.endDate=s("date")(new Date,"yyyy-MM-dd"),i.account.info({id:e},function(e){n.listTitle=e.result.title,n.list()}),n.list=function(a){a&&n.gridOptions.paging&&n.gridOptions.paging.count<=n.gridOptions.paging.pageindex*n.gridOptions.paging.pagesize||i.business.recentchargelog({project:[{id:c.Project.selected._id,account:e}],from:n.startDate.replace(/-/g,""),to:n.endDate.replace(/-/g,""),pageindex:(a&&n.gridOptions.paging?n.gridOptions.paging.pageindex:0)+1,pagesize:50,status:"SUCCESS"},function(e){return e=e.result[c.Project.selected._id]||{},a?n.gridOptions.data=n.gridOptions.data.concat(e.detail||[]):(n.gridOptions.data=e.detail||[],n.gridOptions.data.length&&t(function(){n.gridApi.core.scrollTo(n.gridOptions.data[0],n.gridOptions.columnDefs[0])})),angular.forEach(n.gridOptions.data,function(e){e.timepaid=e.timepaid&&s("date")(1e3*e.timepaid,"yyyy年M月dd日 H:mm:ss")||""}),n.gridOptions.paging=e.paging,n.gridApi.grid.element.height("auto"),e})},n.gridOptions={showColumnFooter:!0,onRegisterApi:function(e){e.infiniteScroll.on.needLoadMoreData(n,function(){var t=l.defer(),i=function(){t.resolve()},a=function(){e.infiniteScroll.dataLoaded(),t.reject()};return function(t){t?t.then(function(){e.infiniteScroll.saveScrollPercentage(),e.infiniteScroll.dataLoaded(!1,!0).then(i,a)},a):a()}(n.list(!0)),t.promise}),n.gridApi=e},rowHeight:34,infiniteScrollDown:!0,enableColumnResizing:!0,exporterOlderExcelCompatibility:!0,enableSorting:!0,columnDefs:[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">序号</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"充值金额(元)",type:"number",name:"amount",width:"*",minWidth:200,aggregationType:o.aggregationTypes.sum,footerCellFilter:"number:2",enableColumnMenu:!1},{displayName:"充值方式",name:"channel",width:"*",minWidth:120},{displayName:"记账时间",name:"timepaid",type:"date",width:"*",minWidth:200}],exporterFieldCallback:function(e,t,n,i){return{title:!0,account:!0,timepaid:!0,timecreate:!0,departmentname:!0,departmentaccount:!0,arrearagetime:!0,consists:!0,timepoint:!0}[n.field]?'="'+(i||"")+'"':i}},n.cancel=function(){a.dismiss("cancel")}}]})},u.OnConsumeList=function(e){n.open({size:"lg",templateUrl:"consume_list.html",controller:["$scope","$uibModalInstance",function(n,a){n.startDate=s("date")(new Date,"yyyy-MM-01"),n.endDate=s("date")(new Date,"yyyy-MM-dd"),i.account.info({id:e},function(e){n.listTitle=e.result.title,n.list()}),n.list=function(a){if(!(a&&n.gridOptions.paging&&n.gridOptions.paging.count<=n.gridOptions.paging.pageindex*n.gridOptions.paging.pagesize))return i.business.departmentusage({from:n.startDate.replace(/-/g,""),to:n.endDate.replace(/-/g,""),pageindex:(a&&n.gridOptions.paging?n.gridOptions.paging.pageindex:0)+1,pagesize:50,project:[{id:c.Project.selected._id,account:e}]},function(e){return e=e.result[c.Project.selected._id]||{},a?n.gridOptions.data=n.gridOptions.data.concat(e.detail||[]):(n.gridOptions.data=e.detail||[],n.gridOptions.data.length&&t(function(){n.gridApi.core.scrollTo(n.gridOptions.data[0],n.gridOptions.columnDefs[0])})),angular.forEach(n.gridOptions.data,function(e){e.timepoint=e.timepoint&&s("date")(1e3*e.timepoint,"yyyy年M月dd日 H:mm:ss")||""}),n.gridOptions.paging=e.paging,n.gridApi.grid.element.height("auto"),e}).$promise},n.filter=function(){n.gridOptions.enableFiltering=!n.gridOptions.enableFiltering,n.gridApi.core.notifyDataChange(o.dataChange.COLUMN)},n.export=function(){n.gridOptions.exporterCsvFilename=c.Project.selected.title+"_户管理_消耗清单_"+n.listTitle+"_"+s("date")(new Date,"yyyyMMdd_HHmmss")+".csv",n.gridApi.exporter.csvExport("visible","visible",angular.element(document.querySelectorAll(".modal-body")))},n.gridOptions={showColumnFooter:!0,onRegisterApi:function(e){e.infiniteScroll.on.needLoadMoreData(n,function(){var t=l.defer(),i=function(){t.resolve()},a=function(){e.infiniteScroll.dataLoaded(),t.reject()};return function(t){t?t.then(function(){e.infiniteScroll.saveScrollPercentage(),e.infiniteScroll.dataLoaded(!1,!0).then(i,a)},a):a()}(n.list(!0)),t.promise}),n.gridApi=e},rowHeight:34,infiniteScrollDown:!0,enableColumnResizing:!0,exporterOlderExcelCompatibility:!0,enableSorting:!0,columnDefs:[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">序号</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"消费项目",name:"consists",width:"*",minWidth:200,enableColumnMenu:!1},{displayName:"消费金额(元)",type:"number",name:"cost",width:"*",aggregationType:o.aggregationTypes.sum,footerCellFilter:"number:2",minWidth:120},{displayName:"记账时间",name:"timepoint",type:"date",width:"*",minWidth:200}],exporterFieldCallback:function(e,t,n,i){return{title:!0,account:!0,timepaid:!0,timecreate:!0,departmentname:!0,departmentaccount:!0,arrearagetime:!0,consists:!0,timepoint:!0}[n.field]?'="'+(i||"")+'"':i}},n.cancel=function(){a.dismiss("cancel")}}],resolve:{ProjectID:function(){return u.Project.selected._id}}}).result.then(u.GetDepartment)},u.OnCharge=function(){return u.channels.selected?u.cash?void i.payment.charge({uid:a,channel:"Manual",amount:parseFloat(u.cash),channelaccountid:u.channels.selected,project:EMAPP.Project.selected._id,subject:"商户项目充值",body:"充值项目: "+EMAPP.Project.selected.title,metadata:{operator:EMAPP.Account._id}},function(e){p.dismiss("cancel"),0===e.code?(e.result.fn?n.open({size:"sm",windowClass:"downloadLink",templateUrl:"downloadLink.html",controller:["$scope","$uibModalInstance",function(t,n){t.downloadLink="/download/"+e.result.fn,window.open(t.downloadLink),t.cancel=function(){n.dismiss("cancel")}}]}):r.AlertSuccess("成功充值"+e.result.amount+"元当前账户余额"+e.result.balance+"元","充值成功"),c.GetDepartment()):r.AlertError(e.message)}):r.AlertWarning(" ","请输入充值金额"):r.AlertWarning(" ","请选择充值方式")},u.cancel=function(){p.dismiss("cancel")}}]})},e.OnImportDepartment=function(){n.open({size:"sm",templateUrl:"import_department.html",controller:["$scope","$uibModalInstance","UI","ProjectID",function(e,t,n,i){e.actionURL="/api/import/importdepartment",e.Character="54d032dd877012ac6d37063f",e.ProjectID=i,e.OnCancel=t.dismiss,e.OnUploadComplete=function(e){e.code?n.AlertError(e.result||" ",e.message):(n.AlertSuccess("导入成功"),t.close())}}],resolve:{ProjectID:function(){return e.Project.selected._id}}}).result.then(e.GetDepartment)},e.OnBatchRecharge=function(){n.open({size:"sm",templateUrl:"batch_recharge.html",controller:["$scope","$uibModalInstance","UI","ProjectID",function(e,t,n,i){e.actionURL="/api/import/importbatchrecharge",e.ProjectID=i,e.OnCancel=t.dismiss,e.OnUploadComplete=function(i){i.code?n.AlertError(i.result||" ",i.message):(n.AlertSuccess("导入成功"),e.OnCancel=t.close,i.result.fn&&(e.downloadLink="/download/"+i.result.fn,window.open(e.downloadLink)))}}],resolve:{ProjectID:function(){return e.Project.selected._id}}}).result.then(e.GetDepartment)},e.remindrecharge=function(t){i.message.remindrecharge({uid:t?t.account._id:e.multiIds("remindrecharge"),project:EMAPP.Project.selected._id},function(t){0===t.code&&(e.GetDepartment(),e.multiCheck.all&&delete e.multiCheck.all)})},e.OnExportAlertInfo=function(){}})}]);