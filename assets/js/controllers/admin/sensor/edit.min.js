angular.module("app").controller("SensorEdit",["$scope","$stateParams","$state","Sensor","Collector","Energy","Customer","Building","API","Auth","UI",function(e,n,t,s,o,r,i,l,c,u,a){u.Check(function(){function o(e,n,t){if(n){var s=[];return _.each(n,function(n){n.childrens?n.ischild=!1:n.ischild=!0,n.parent=e,n.level=t,n.nodes=o(n,n.childrens,t+1),s.push(n)}),s.sort(function(e,n){return e.title>n.title?1:-1}),s}}var i;e.submit=function(n){function o(){c.Query(s.update,r,function(e){e.err||t.go("admin.sensor.info")})}var r=angular.copy(e.sensor);r.project=e.sensor.building.project._id,r.building=e.sensor.building._id,i?(r.energy=c.RootEnergycategory(i.id),r.energyPath=i.id):(r.energy="",r.energyPath=""),e.sensor.sid!=r.sid?c.Query(s.info,{sids:[r.sid]},function(e){return e.result&&e.result.length>0?void alert("传感器标识已经存在"):void o()},function(e){console.log(e)}):o()},c.Query(s.channelinfo,{id:n.id},function(n){n.err||(e.sensor=n.result[0],c.Query(r.info,{project:e.sensor.project},function(n){if(!n.err){var t,s=n.result,r=s.energy;e.sensor.energyPath&&_.each(e.sensor.energyPath.split("|"),function(e){r&&(t?t+="|"+e:t=e,r=r[t],r&&(r&&!r.childrens?(r.isSelect=!0,i=r):r=r.childrens))}),s?e.viewOfEnergy=[{nodes:o(null,s.energy,1),title:"能耗分类",level:0}]:e.viewOfEnergy=[{nodes:[],title:"能耗分类",level:0}]}}))}),e.onChoice=function(e){e.isSelect=!e.isSelect;var n=function(e,t){e&&e.nodes&&e.nodes.length&&(_.each(e.nodes,function(e){n(e,t),e.isSelect=t}),e.isSelect=t)};n(e,e.isSelect)},e.onEnergyChoice=function(e){e.nodes||(i&&(i.isSelect=!1),i=e,i.isSelect=!0)},e.OnCollapsePayStatus=function(){e.sensor.paystatus&&"NONE"!=e.sensor.paystatus?e.sensor.paystatus="NONE":e.sensor.paystatus="BYSELF"},e.OnSelectPayMode=function(n,t){n.preventDefault(),e.sensor.paystatus=t}})}]);