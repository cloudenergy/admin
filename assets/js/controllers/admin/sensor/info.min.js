angular.module("app").controller("SensorIndex",["$scope","$q","$api","$uibModal","Building","API","Auth","UI",function(e,n,t,i,r,c,o,s){e.operateStatus={create:{isEnable:!1,url:"/create"},delete:{isEnable:!1,url:"/delete"},edit:{isEnable:!1,url:"/edit"},sync:{isEnable:!0,url:"/syncdata"},mask:{isEnable:!1,url:"/mask"}};var l=EMAPP.Account._id+"_sensor_index_search";o.Check(e.operateStatus,function(){function r(){return t.customer.info({project:e.Project.selected._id,onlynode:1},function(n){e.customer={enable:e.customer.enable,selected:"ROOT",core:{data:[{id:"ROOT",parent:"#",text:"全部社会属性",state:{selected:!0,opened:!0},icon:"glyphicon glyphicon-th-list"}]},conditionalselect:function(n,t){return e.customer.selected=n.id,e.OnSearch(),!0},plugins:["search","conditionalselect"]},function n(t,i){angular.forEach(t,function(t,r){t.parent=i,t.text=t.title,Object.keys(t.child).length?t.icon="glyphicon glyphicon-th-list":t.icon="glyphicon glyphicon-file",n(t.child,t.id),e.customer.core.data.push(t)})}(n.result,"ROOT")}).$promise}function o(){return t.building.info({project:e.Project.selected._id},function(n){var t="sensor.building",i=s.GetPageItem(t);e.buildings=[],angular.forEach(n.result,function(e){this.push(e)},e.buildings),e.buildings.select=function(){s.PutPageItem(t,e.buildings.selected),e.OnSearch()},angular.forEach(e.buildings,function(n){n._id===i&&(e.buildings.selected=n._id)}),e.buildings.selected=e.buildings.selected||(e.buildings[0]||{})._id}).$promise}function u(){return t.device.type({project:e.Project.selected._id},function(n){e.DeviceTypes=[{id:void 0,title:"全部设备"}],angular.forEach(n.result,function(e){this.push({id:e.id,title:e.name})},e.DeviceTypes),e.DeviceTypes.selected=e.DeviceTypes.selected||(e.DeviceTypes[0]||{}).id,e.DeviceTypes.select=function(){e.OnSearch()}}).$promise}function a(){t.business.monitor({devicetype:e.DeviceTypes.selected||void 0,building:!e.customer.enable&&e.buildings.selected||void 0,project:e.Project.selected._id,key:s.GetPageItem(l)||void 0,mode:"SENSOR",usesocity:e.customer.enable||void 0,socitynode:e.customer.enable&&e.customer.selected||void 0,pageindex:e.currentPage,pagesize:15},function(n){n=n.result[e.Project.selected._id],angular.forEach(n.detail,function(e){this.push(e)},e.viewOfSensor=[]),e.pageSize=n.paging.pagesize,e.itemsTotal=n.paging.count})}e.currentPage=s.GetPageIndex(),e.$watch("Project.selected",function(){e.customer=angular.isDefined(e.customer)?{enable:e.customer.enable}:{enable:!0},e.buildings=[],e.DeviceTypes=[],n.all([r(),o(),u()]).then(e.OnSearch)}),e.$watch("currentPage",function(n){return void 0==n?void(e.currentPage=s.GetPageIndex()):(s.PutPageIndex(void 0,e.currentPage),void(e.viewOfSensor&&e.OnSearch()))}),e.$watch("customer.enable",function(n){e.viewOfSensor&&e.OnSearch()}),e.OnSearch=function(){s.PutPageItem(l,e.searchKey),a()},e.OnMask=function(e){t.sensorchannel.update({id:e.id,mask:!e.mask},function(n){n.err||(e.mask=!e.mask)})},e.OnMaskAll=function(n){confirm("是否确定"+(n?"屏蔽":"启用")+"所有通道？")&&angular.forEach(e.viewOfSensor,function(e){angular.forEach(e.channels,function(e){t.sensorchannel.update({id:e.id,mask:n},function(){e.mask=n})})})},e.OnSync=function(n,t){n.title=t.title;var r=i.open({templateUrl:"sensorSync.html",controller:"SensorSync",size:"lg",resolve:{SensorIns:function(){return n}}});r.result.then(function(n){e.editUser.resource.sensor||(e.editUser.resource.sensor=[]),e.editUser.resource.sensor=_.difference(e.editUser.resource.sensor,n.unselect),e.editUser.resource.sensor=_.union(e.editUser.resource.sensor,n.select)},function(){})},e.OnSyncAll=function(){confirm("是否确定同步所有数据异常的传感器？")&&t.sensorchannel.syncdata({project:e.Project.selected._id},function(n){n.err?console.error(n):(alert("同步完成"),e.OnSearch())})},e.onRemove=function(e,n){t.sensorchannel.delete({id:e.id},function(t){delete n.channels[e.funcid]},function(e){s.AlertError(e.data.message)})},e.OnSensorAttribute=function(n){var t=i.open({templateUrl:"sensorAttribute.html",controller:"sensorAttribute",size:"lg",resolve:{SensorSUID:function(){var e=c.ParseSensorID(n.id);return e?e.buildingID+e.gatewayID+e.addrID+e.meterID:null},ProjectID:function(){return e.Project.selected._id}}});t.result.then(function(){},function(){})}}),e.importSensor=function(){var n=e,t=!1;i.open({templateUrl:"importSensor.html",size:"md",controller:["$scope","$timeout","$uibModalInstance","project","building","customer",function(e,i,r,c,o,l){e.actionURL="/api/import/importsensorchannel",e.project=c,e.building=o,e.customer=l,e.ok=function(){r.close(),t&&n.OnSearch()},e.OnUploadComplete=function(e){return e.code?s.AlertError(e.result,e.message):(t=!0,s.AlertSuccess("导入成功")),!1},e.cancel=r.dismiss}],resolve:{project:function(){return e.Project.selected._id},building:function(){return e.buildings.selected},customer:function(){return e.customer.selected}}})},e.AlertInfo=function(){s.AlertInfo.apply(s,arguments)}}]);