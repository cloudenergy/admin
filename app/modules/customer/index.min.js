"use strict";angular.module("app").component("customerIndex",{templateUrl:"app/modules/customer/index.html?rev=40b1b70832",controller:["$rootScope","$q","$api","$uibModal","SweetAlert",function(t,e,n,i,o){var d=this,r=function(t,e,n){var i=[];return e&&(angular.forEach(e,function(e){e.key&&(e.addrid=e.key.substring(12,24)),d.listOrigin&&angular.forEach(d.listOrigin[0].nodes,function(t){t.showChildren&&(t.id==e.id&&(e.showChildren=t.showChildren),t.nodes&&angular.forEach(t.nodes,function(t){t.showGrandchildren&&t.id==e.id&&(e.showGrandchildren=t.showGrandchildren)}))}),e.originid=e.id,e.origintitle=e.title,e.id=e.id,e.title=e.title,e.acreage=e.acreage||0,e.level=n,e.nodes=r(e,e.child,n+1),e.parent=t,i.push(e)}),i.sort(function(t,e){return t.index>e.index?1:-1})),i};d.$onInit=function(){return n.customer.info({project:t.Project.selected._id},function(t){d.listData=[{level:0,type:"NODE",title:"树形结构",nodes:r(null,t.result,1)}]},function(){d.listData=[{level:0,type:"NODE",title:"树形结构",nodes:[]}]}).$promise},d.addnode=function(t,e){"root"==t?d.listData[0].nodes.push({key:"",type:"NODE",title:""}):e.nodes.push({key:"",type:"NODE",title:"",parent:e})},d.save=function(e,i,r,a){if(!i.title)return o.info("请输入名称"),!1;n.customer.update({node:{id:i.id||void 0,title:i.title,type:a,parent:i.parent&&i.parent.id||void 0},method:r,project:t.Project.selected._id},function(t){d.listOrigin=angular.copy(d.listData),d.$onInit(),o.success(i.id?"更新成功":"添加成功")},function(){d.$onInit(),o.warning(i.id?"更新失败":"添加失败")})},d.add=function(e,i,r){n.customer.update({node:{title:e.title,type:"DEV",key:e.did,parent:r},method:"ADD",project:t.Project.selected._id},function(t){d.listOrigin=angular.copy(d.listData),d.$onInit(),o.success(e.id?"更新成功":"添加成功")},function(){d.$onInit(),o.warning(e.id?"更新失败":"添加失败")})},d.cancel=function(t,e){t.splice(e,1),d.listOrigin=angular.copy(d.listData),d.$onInit()},d.delete=function(e,i){n.customer.update({node:{id:e.id},method:"REMOVE",project:t.Project.selected._id},function(){d.listOrigin=angular.copy(d.listData),d.$onInit()},function(){d.$onInit(),o.warning("删除失败")})},d.empty=function(t){if(null==t||angular.equals({},t))return!0},d.changeSensor=function(e){i.open({backdrop:"static",component:"sensor",size:"lg",resolve:{projectid:function(){return t.Project.selected._id},selected:function(){return angular.equals(e.child,{})&&e||e.child}}}).result.then(function(i){d.addsensor=function(){1==i.removeItems.length&&1==i.addItems.length&&n.customer.update({node:{id:e.id||void 0,key:i.addItems[0].did,title:e.title,type:"DEV",parent:e.parent&&e.parent.id||void 0},method:"UPDATE",project:t.Project.selected._id},function(t){d.listOrigin=angular.copy(d.listData),d.$onInit(),o.success(e.id?"更新成功":"添加成功")},function(){d.listOrigin=angular.copy(d.listData),d.$onInit(),o.warning(e.id?"更新失败":"添加失败")})},i.addItems.length>=1&&1!=i.removeItems.length&&angular.forEach(i.addItems,function(t){d.add(t,t.title,e.id)}),i.removeItems.length>=1&&1!=i.addItems.length&&angular.forEach(i.removeItems,function(t){angular.forEach(e.child,function(e){e.key==t.did&&d.delete(e)})}),e.id&&d.addsensor(),!e.id&&d.save("child",e,"ADD","DEV")})}}]});