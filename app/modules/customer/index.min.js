"use strict";angular.module("app").component("customerIndex",{templateUrl:"app/modules/customer/index.html?rev=adc43d8404",controller:["$rootScope","$q","$api","$uibModal","SweetAlert",function(o,t,d,e,r){var a=this,l=function(t,e,n){var i=[];return e&&(angular.forEach(e,function(e){e.key&&(e.addrid=e.key.substring(12,24)),a.listOrigin&&angular.forEach(a.listOrigin[0].nodes,function(t){t.showChildren&&(t.id==e.id&&(e.showChildren=t.showChildren),t.nodes&&angular.forEach(t.nodes,function(t){t.showGrandchildren&&t.id==e.id&&(e.showGrandchildren=t.showGrandchildren)}))}),e.originid=e.id,e.origintitle=e.title,e.id=e.id,e.title=e.title,e.acreage=e.acreage||0,e.level=n,e.nodes=l(e,e.child,n+1),e.parent=t,i.push(e)}),i.sort(function(t,e){return t.index>e.index?1:-1})),i};a.$onInit=function(){return d.customer.info({project:o.Project.selected._id},function(t){a.listData=[{level:0,type:"NODE",title:"树形结构",nodes:l(null,t.result,1)}]},function(){a.listData=[{level:0,type:"NODE",title:"树形结构",nodes:[]}]}).$promise},a.addnode=function(t,e){"root"==t?a.listData[0].nodes.push({key:"",type:"NODE",title:""}):e.nodes.push({key:"",type:"NODE",title:"",parent:e})},a.save=function(t,e,n,i){if(!e.title)return r.info("请输入名称"),!1;d.customer.update({node:{id:e.id||void 0,title:e.title,type:i,parent:e.parent&&e.parent.id||void 0},method:n,project:o.Project.selected._id},function(t){a.listOrigin=angular.copy(a.listData),a.$onInit(),r.success(e.id?"更新成功":"添加成功")},function(){a.$onInit(),r.warning(e.id?"更新失败":"添加失败")})},a.add=function(e,t,n){d.customer.update({node:{title:e.title,type:"DEV",key:e.did,parent:n},method:"ADD",project:o.Project.selected._id},function(t){a.listOrigin=angular.copy(a.listData),a.$onInit(),r.success(e.id?"更新成功":"添加成功")},function(){a.$onInit(),r.warning(e.id?"更新失败":"添加失败")})},a.cancel=function(t,e){t.splice(e,1),a.listOrigin=angular.copy(a.listData),a.$onInit()},a.delete=function(t,e){d.customer.update({node:{id:t.id},method:"REMOVE",project:o.Project.selected._id},function(){a.listOrigin=angular.copy(a.listData),a.$onInit()},function(){a.$onInit(),r.warning("删除失败")})},a.empty=function(t){if(null==t||angular.equals({},t))return!0},a.changeSensor=function(n){e.open({backdrop:"static",component:"sensor",size:"lg",resolve:{projectid:function(){return o.Project.selected._id},selected:function(){return angular.equals(n.child,{})&&n||n.child}}}).result.then(function(t){a.addsensor=function(){1==t.removeItems.length&&1==t.addItems.length&&d.customer.update({node:{id:n.id||void 0,key:t.addItems[0].did,title:n.title,type:"DEV",parent:n.parent&&n.parent.id||void 0},method:"UPDATE",project:o.Project.selected._id},function(t){a.listOrigin=angular.copy(a.listData),a.$onInit(),r.success(n.id?"更新成功":"添加成功")},function(){a.listOrigin=angular.copy(a.listData),a.$onInit(),r.warning(n.id?"更新失败":"添加失败")})},1<=t.addItems.length&&1!=t.removeItems.length&&angular.forEach(t.addItems,function(t){a.add(t,t.title,n.id)}),1<=t.removeItems.length&&1!=t.addItems.length&&angular.forEach(t.removeItems,function(e){angular.forEach(n.child,function(t){t.key==e.did&&a.delete(t)})}),n.id&&a.addsensor(),n.id||a.save("child",n,"ADD","DEV")})}}]});