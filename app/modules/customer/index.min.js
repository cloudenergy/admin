"use strict";angular.module("app").component("customerIndex",{templateUrl:"app/modules/customer/index.html?rev=25cc2d8c2e",controller:["$rootScope","$scope","$q","$api","$uibModal","SweetAlert",function(e,t,i,n,o,r){function d(e,t,i){var n=[];return t&&(angular.forEach(t,function(t){t.originid=t.id,t.origintitle=t.title,t.id=t.id,t.title=t.title,t.acreage=t.acreage||0,t.level=i,t.nodes=d(t,t.child,i+1),t.parent=e,n.push(t)}),n.sort(function(e,t){return e.index>t.index?1:-1})),n}n.customer.info({project:e.Project.selected._id},function(e){t.viewOfCustomer=[{level:0,type:"NODE",title:"社会属性",nodes:d(null,e.result,1)}]},function(){t.viewOfCustomer=[{level:0,type:"NODE",title:"社会属性",nodes:[]}]}),t.newNode=function(e){e.nodes.push({enable:!0,editing:!0,title:"",origintitle:"",acreage:0,level:e.level+1,type:"NODE",parent:e,nodes:[]})},t.saveNode=function(t){if(!t.title)return r.info("请输入名称"),!1;delete t.editing,t.origintitle=t.originid?t.origintitle:t.title,n.customer.update({node:{id:t.id||void 0,title:t.title,type:t.id?t.type:"NODE",parent:t.parent.id},method:t.id?"UPDATE":"ADD",project:e.Project.selected._id},function(e){r.success(t.id?"更新成功":"添加成功"),t.id||(t.id=t.originid=e.result.id,t.origintitle=t.title)})},t.editNode=function(e){e.origintitle=e.title,e.editing=!0},t.cancelEdit=function(e){e.id?e.title=e.origintitle:angular.forEach(e.parent.nodes,function(t){t.$$hashKey!==e.$$hashKey&&this.push(t)},e.parent.nodes=[]),delete e.editing},t.deleteNode=function(t,i){n.customer.update({node:{id:t.id},method:"REMOVE",project:e.Project.selected._id},function(){r.success("删除成功"),i.remove()})},t.sensor=function(t){o.open({backdrop:"static",component:"customerSensor",resolve:{ProjectID:function(){return e.Project.selected._id},SelectKEY:function(){return function e(t,i){return angular.forEach(t,function(t){"DEV"===t.type?i[t.key]=1:e(t.nodes,i)}),i}(t.nodes,{})}}}).result.then(function(o){var r=[],d={};!function t(i){angular.forEach(i,function(i){"DEV"===i.type?0===o[i.key]&&r.push(n.customer.update({node:{id:i.id},method:"REMOVE",project:e.Project.selected._id},function(){d[i.id]=!0}).$promise):t(i.nodes)})}(t.nodes),angular.forEach(o,function(i,o){i&&angular.isString(i)&&r.push(n.customer.update({node:{type:"DEV",title:i,key:o,parent:t.id},method:"ADD",project:e.Project.selected._id},function(e){t.nodes.push({originid:e.result.id,origintitle:e.result.title,id:e.result.id,title:e.result.title,acreage:0,level:t.level+1,type:"DEV",key:e.result.key,parent:t,nodes:[]})}).$promise)}),i.all(r).then(function(){!function e(t){angular.forEach(t.nodes,function(t){!d[t.id]&&this.push(t),t.nodes.length&&e(t)},t.nodes=[])}(t)})})}}]});