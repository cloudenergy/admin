"use strict";angular.module("app").controller("departmentedit",["$rootScope","$scope","$state","$stateParams","$uibModal","$api","SweetAlert",function(r,d,a,n,t,i,o){var c=d;d.ondutyHour=["00","01","02","03","04","05","06","07","08","09","10","11","12","13","14","15","16","17","18","19","20","21","22","23"],d.ondutyMinute=["00","10","20","30","40","50"],d.offdutyHour=["00","01","02","03","04","05","06","07","08","09","10","11","12","13","14","15","16","17","18","19","20","21","22","23"],d.offdutyMinute=["00","10","20","30","40","50"],d.submit=function(e){if(d.departmentAccount<10)o.info("用户名不能低于10位");else if(d.department.passwd&&d.department.passwd!=d.repassword)o.info("两次输入的密码不一致");else{var t=d.department.project;d.department.resource={project:[t],sensor:[]},_.each(d.SelectSensors,function(e){d.department.resource.sensor.push(t+"."+e._id)}),d.department.message=Object.keys(d.warning).filter(function(e){return d.warning[e]?e:""}).join(","),d.department.onduty=d.ondutyHour.selected+":"+d.ondutyMinute.selected,d.department.offduty=d.offdutyHour.selected+":"+d.offdutyMinute.selected,d.department.account=d.departmentAccount,d.rechargeable||null!==d.department.rechargeable||delete d.department.rechargeable,i.department.update(d.department,function(){o.success("更新成功"),a.go("admin.department.info")},o.error)}},d.reset=function(e){i.department.reset({id:e})},d.OnSelectSensor=function(e){e.preventDefault(),t.open({templateUrl:"modal-channelselect.html",controller:"ChannelSelect",size:"lg",resolve:{ProjectID:function(){return d.department.project},SelectedSensors:function(){return d.SelectSensors||[]}}}).result.then(function(e){d.SelectSensors=e},function(){})},d.modalPackageplan=function(e){e.preventDefault(),t.open({templateUrl:"modal-packageplan.html",controller:["$scope","$uibModalInstance",function(t,e){i.packageplan.info({project:r.Project.selected._id,pageindex:1},function(e){t.dailyInfo=e.result.detail,t.pageindex=e.result.paging.pageindex,t.count=e.result.paging.count,t.pagesize=e.result.paging.pagesize,t.$watch("pageindex",function(){i.packageplan.info({project:r.Project.selected._id,pageindex:t.pageindex&&parseInt(t.pageindex)||1,pagesize:10},function(e){t.dailyInfo=e.result.detail,angular.forEach(t.dailyInfo,function(t){angular.forEach(c.packageplan,function(e){t.id===e.packageid?t.isSelected=!0:angular.isUndefined(t.isSelected)&&(t.isSelected=!1)})})})})}),t.planSelect=function(e,t){e.preventDefault(),t.isSelected?delete t.isSelected:t.isSelected=!0,t.isSelected?i.userpackage.add({packageid:t.id,uid:n.uid}):i.userpackage.delete({packageid:t.id.toString(),uid:n.uid})},t.Cancel=function(){i.userpackage.info({uid:n.uid,pageindex:1},function(e){10<(e=e.result).paging.count?t.userpackagePagesize=e.paging.count:c.packageplan=e.detail,t.userpackagePagesize&&i.userpackage.info({uid:n.uid,pageindex:1,pagesize:t.userpackagePagesize},function(e){e=e.result.detail,c.packageplan=e}),delete t.userpackagePagesize}),e.dismiss()}}],size:"lg"})},i.department.info({id:n.id},function(e){d.department=e.result,delete d.department.passwd,d.departmentAccount=e.result.account,d.SelectSensors=d.department.sensors||[],d.department.cash=e.result.cash,d.department.alerthreshold=e.result.alerthreshold,d.epayment=r.Project[d.department.project].epayment,d.warning={};var t=d.message?String.prototype.split.call(d.message||"",","):[];angular.forEach(t,function(e,t){d.warning[e]=!0});var a=moment(d.department.onduty,"HH:mm");d.department.onduty=a.format("HH:mm"),d.ondutyHour.selected=a.format("HH"),d.ondutyMinute.selected=a.format("mm");var n=moment(d.department.offduty,"HH:mm");d.department.offduty=n.format("HH:mm"),d.offdutyHour.selected=n.format("HH"),d.offdutyMinute.selected=n.format("mm")}),i.userpackage.info({uid:n.uid,pageindex:1},function(e){10<(e=e.result).paging.count?d.userpackagePagesize=e.paging.count:d.packageplan=e.detail,d.userpackagePagesize&&i.userpackage.info({uid:n.uid,pageindex:1,pagesize:d.userpackagePagesize},function(e){e=e.result.detail,d.packageplan=e}),delete d.userpackagePagesize}),d.OnSelectCharacter=function(e,t){e.preventDefault(),d.department.character=t}}]);