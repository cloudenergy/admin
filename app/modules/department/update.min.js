"use strict";angular.module("app").controller("departmentedit",["$rootScope","$scope","$state","$stateParams","$uibModal","$api","SweetAlert",function(e,t,a,n,c,r,o){var i=t;t.ondutyHour=["00","01","02","03","04","05","06","07","08","09","10","11","12","13","14","15","16","17","18","19","20","21","22","23"],t.ondutyMinute=["00","10","20","30","40","50"],t.offdutyHour=["00","01","02","03","04","05","06","07","08","09","10","11","12","13","14","15","16","17","18","19","20","21","22","23"],t.offdutyMinute=["00","10","20","30","40","50"],t.submit=function(e){if(t.department.passwd&&t.department.passwd!=t.repassword)return void o.info("两次输入的密码不一致");var n=t.department.project;t.department.resource={project:[n],sensor:[]},_.each(t.SelectSensors,function(e){t.department.resource.sensor.push(n+"."+e._id)}),t.department.message=Object.keys(t.warning).filter(function(e){return t.warning[e]?e:""}).join(","),t.department.onduty=t.ondutyHour.selected+":"+t.ondutyMinute.selected,t.department.offduty=t.offdutyHour.selected+":"+t.offdutyMinute.selected,t.department.account=t.departmentAccount,r.department.update(t.department,function(){o.success("更新成功"),a.go("admin.department.info")},o.error)},t.reset=function(e){r.department.reset({id:e})},t.OnSelectSensor=function(e){e.preventDefault(),c.open({templateUrl:"modal-channelselect.html",controller:"ChannelSelect",size:"lg",resolve:{ProjectID:function(){return t.department.project},SelectedSensors:function(){return t.SelectSensors||[]}}}).result.then(function(e){t.SelectSensors=e},function(){})},t.modalPackageplan=function(t){t.preventDefault(),c.open({templateUrl:"modal-packageplan.html",controller:["$scope","$uibModalInstance",function(t,a){r.packageplan.info({project:e.Project.selected._id,pageindex:1},function(a){t.dailyInfo=a.result.detail,t.pageindex=a.result.paging.pageindex,t.count=a.result.paging.count,t.pagesize=a.result.paging.pagesize,t.$watch("pageindex",function(){r.packageplan.info({project:e.Project.selected._id,pageindex:t.pageindex&&parseInt(t.pageindex)||1,pagesize:10},function(e){t.dailyInfo=e.result.detail,angular.forEach(t.dailyInfo,function(e){angular.forEach(i.packageplan,function(t){e.id===t.packageid?e.isSelected=!0:angular.isUndefined(e.isSelected)&&(e.isSelected=!1)})})})})}),t.planSelect=function(e,t){e.preventDefault(),t.isSelected?delete t.isSelected:t.isSelected=!0,t.isSelected?r.userpackage.add({packageid:t.id,uid:n.uid}):r.userpackage.delete({packageid:t.id.toString(),uid:n.uid})},t.Cancel=function(){r.userpackage.info({uid:n.uid,pageindex:1},function(e){(e=e.result).paging.count>10?t.userpackagePagesize=e.paging.count:i.packageplan=e.detail,t.userpackagePagesize&&r.userpackage.info({uid:n.uid,pageindex:1,pagesize:t.userpackagePagesize},function(e){e=e.result.detail,i.packageplan=e}),delete t.userpackagePagesize}),a.dismiss()}}],size:"lg"})},r.department.info({id:n.id},function(e){if(t.department=e.result,delete t.department.passwd,t.departmentAccount=e.result.account._id||e.result.account,t.SelectSensors=t.department.sensors||[],t.department.cash=e.result.account.billingAccount.cash,t.department.alerthreshold=e.result.account.billingAccount.alerthreshold,t.account=e.result.account,t.department.account=t.account._id,t.warning={},"object"==typeof t.account){t.department.mobile=t.account.mobile,t.department.email=t.account.email;var a=t.account.message?String.prototype.split.call(t.account.message||"",","):[];angular.forEach(a,function(e,a){t.warning[e]=!0})}var n=moment(t.department.onduty,"HH:mm");t.department.onduty=n.format("HH:mm"),t.ondutyHour.selected=n.format("HH"),t.ondutyMinute.selected=n.format("mm");var c=moment(t.department.offduty,"HH:mm");t.department.offduty=c.format("HH:mm"),t.offdutyHour.selected=c.format("HH"),t.offdutyMinute.selected=c.format("mm")}),r.userpackage.info({uid:n.uid,pageindex:1},function(e){(e=e.result).paging.count>10?t.userpackagePagesize=e.paging.count:t.packageplan=e.detail,t.userpackagePagesize&&r.userpackage.info({uid:n.uid,pageindex:1,pagesize:t.userpackagePagesize},function(e){e=e.result.detail,t.packageplan=e}),delete t.userpackagePagesize}),t.OnSelectCharacter=function(e,a){e.preventDefault(),t.department.character=a}}]);