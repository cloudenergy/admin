<<<<<<< HEAD
"use strict";angular.module("app").controller("departmentInfo",["$rootScope","$scope","$timeout","$uibModal","$api","uiGridConstants","$q","$filter","i18nService","$state","SweetAlert","ToFloat",function(r,a,i,o,s,c,l,d,e,t,u,n){e.add("zh-cn",{aggregation:{sum:"合计："}});var m="department_info_pagesize",p=a;"undefined"!=sessionStorage.departmentKey&&(a.departmentKey=sessionStorage.departmentKey),"undefined"!=sessionStorage.minAmount&&(a.minAmount=sessionStorage.minAmount),"undefined"!=sessionStorage.maxAmount&&(a.maxAmount=sessionStorage.maxAmount),a.tab="occupancy",a.statusenum=[{id:0,title:"全部"},{id:1,title:"正常"},{id:2,title:"欠费"}],a.statusenum.selected=a.statusenum[0].id,a.multiCheck=function(e){"all"===e?(a.multiCheck.all&&(a.showButton=!0),a.multiCheck.all||(a.showButton=!1),angular.forEach(a.listData,function(e){e.isSelected=a.multiCheck.all})):(a.multiCheck.all=!0,a.showButton=!1,angular.forEach(a.listData,function(e){e.isSelected||delete a.multiCheck.all,e.isSelected&&(a.showButton=!0)}))},a.OnSelectSensor=function(t,e){a.popIsOpen(),e.preventDefault(),a.SelectSensors=t.sensors||[],o.open({templateUrl:"modal-channelselect.html",controller:"ChannelSelect",size:"lg",resolve:{ProjectID:function(){return t.project},SelectedSensors:function(){return a.SelectSensors||[]}}}).result.then(function(e){a.SelectSensors=e,t.resource={project:[t.project],sensor:[]},angular.forEach(a.SelectSensors,function(e){t.resource.sensor.push(t.project+"."+e._id)}),s.department.update({id:t._id,resource:t.resource},function(){u.success("更新成功"),a.GetDepartment()},u.error)},function(){a.GetDepartment()})},a.multiIds=function(t){var n=[];return angular.forEach(a.listData,function(e){e.isSelected&&"delete"===t?n.push(e._id):e.isSelected&&"remindrecharge"===t&&e.cash<0&&n.push(e.account)}),n},a.paging={total:0,index:1,size:parseInt(sessionStorage[m]||10),items:[{key:10,title:"每页10条"},{key:15,title:"每页15条"},{key:30,title:"每页30条"},{key:50,title:"每页50条"},{key:100,title:"每页100条"}]},a.GetDepartment=function(){sessionStorage.departmentKey=a.departmentKey,sessionStorage.minAmount=a.minAmount,sessionStorage.maxAmount=a.maxAmount,a.multiCheck.all=!1,a.showButton=!1,a.listData&&a.listData.loading||(a.listData&&(a.listData.loading=!0),s.department.info({project:r.Project.selected._id,keyreg:a.departmentKey,minAmount:a.minAmount||void 0,maxAmount:a.maxAmount||void 0,arrear:{1:!1,2:!0}[a.statusenum.selected],status:"occupancy"==a.tab?1:0,pageindex:a.paging.index,pagesize:a.paging.size},function(e){e=e.result,a.statistic=e.statistic,e.detail=angular.isArray(e.detail)&&e.detail||e.detail&&[e.detail]||[],angular.forEach(e.detail,function(t){t.cash&&(t.cash=n(t.cash)),t.sensorAll=[],angular.forEach(t.sensors,function(e){t.sensorAll.push(e.title+"\n"),e.status.switch={EMC_ON:!0,EMC_OFF:!1}[e.status.switch]||!1}),t.sensorAll=t.sensorAll.join("")}),a.listData=e.detail,a.listData.count=(e.paging||{}).count||0,a.listData.index=(e.paging||{}).pageindex||1,a.listData.total=(e.paging||{}).count||0},function(){delete a.listData}))},a.arrearInfo=function(e,t,n,i){a.arrearShow=e,a.statusenum.selected=t,a.maxAmount=n,a.minAmount=i,a.GetDepartment()},a.rentAlready=function(){a.tab="occupancy",a.arrearShow=!1,a.statusenum.selected=void 0,a.maxAmount=void 0,a.minAmount=void 0,a.GetDepartment()},a.$watch("statusenum.selected",function(e){angular.isDefined(e)&&(sessionStorage.department_info_status=e),a.paging.index=1,a.GetDepartment()}),a.$watch("paging.index",function(){a.listData&&a.GetDepartment()}),a.$watch("paging.size",function(e){a.multiCheck.all=!1,angular.isDefined(e)&&(sessionStorage[m]=e),i(a.listData&&a.GetDepartment)}),a.DoRemove=function(){var n=!1;angular.forEach(a.multiIds("delete"),function(t){angular.forEach(a.listData,function(e){e._id==t&&0!=e.cash&&(n=!0)})}),n?u.error("所选商户中有商户余额不为 0 无法删除"):o.open({size:"sm",templateUrl:"departmentDelete.html",controller:["$scope","$uibModalInstance","$api",function(e,t,n){e.cancel=function(){t.dismiss()},e.ok=function(){t.dismiss(),n.department.delete({id:p.multiIds("delete")},function(){p.GetDepartment()},u.error)}}]})},a.changePercent=function(i){s.apportionment.info({cids:i},function(t){o.open({size:"md",templateUrl:"changePercent.html",controller:["$scope","$uibModalInstance",function(n,e){n.apportionmentPercent=t.result[0],angular.forEach(n.apportionmentPercent.share,function(t){s.department.info({id:t.tid},function(e){t.account=e.result.account})}),n.ok=function(){var t=[];n.execute=!0,angular.forEach(n.apportionmentPercent.share,function(e){0==e.percent&&(n.execute=!1),t.push({cid:i,tid:e.tid,percent:e.percent})}),n.execute||u.error("分摊不能为0"),n.execute&&s.apportionment.percent({projectid:r.Project.selected._id,binds:t},function(){u.success("修改成功"),e.dismiss("cancel"),p.GetDepartment()},function(e){var t;switch(e.code){case 20000003:t="参数不全";break;case 20000013:t="用户已经存在";break;case 20000030:t="此表分摊总百分比不等于100%";break;default:t="未知错误"}u.error(t)})},n.cancel=function(){e.dismiss("cancel")}}]})})},a.sensorChange=function(n,e){o.open({size:"sm",templateUrl:{mobile:"mobileChange.html",title:"titleChange.html",alerthreshold:"alerthresholdChange.html"}[e],controller:["$scope","$uibModalInstance",function(e,t){e.department=angular.copy(n),e.title=e.department.title,e.ok=function(){s.department.update(e.department,function(){angular.extend(n,e.department),u.success("更新成功")},u.error),e.OnCancel=t.dismiss("cancel")},e.cancel=function(){e.OnCancel=t.dismiss("cancel")}}]})},a.popIsOpen=function(){angular.forEach(a.listData,function(e){delete e.usertitleIsOpen,delete e.titleIsOpen,delete e.mobileIsOpen,delete e.accountIsOpen,delete e.alerthresholdIsOpen})},a.popover={url:{title:"titleChange.html",usertitle:"usertitleChange.html",mobile:"mobileChange.html",account:"accountChange.html",alerthreshold:"alerthresholdChange.html"},title:{title:"商户名称修改",usertitle:"租户名称修改",mobile:"商户手机号修改",account:"商户账户修改",alerthreshold:"报警阀值修改"},ok:function(e,t,n){"account"==t&&n.account.length<10?u.warning("商户账户至少为10位"):(e[t+"IsOpen"]=!1,a.department=angular.copy(e),a.department[t]=n[t],s.department.update({id:a.department._id,title:a.department.title,usertitle:a.department.usertitle,mobile:a.department.mobile,account:a.department.account,alerthreshold:a.department.alerthreshold},function(){e[t]=n[t],u.success("更新成功")},u.error))},cancel:function(e,t){e[t+"IsOpen"]=!1}},a.switchControl=function(i){o.open({size:"sm",templateUrl:"switch_control.html",controller:["$scope","$uibModalInstance","$api",function(e,t,n){e.OnSubmit=function(){n.control.send({id:i.sid,uid:r.Account._id,project:i.project,ctrlcode:(new Hashes.SHA1).hex(e.password).toUpperCase(),command:"EMC_SWITCH",param:{mode:i.status.switch?"EMC_ON":"EMC_OFF"}},function(){t.close()},u.error)},e.OnCancel=t.dismiss}]}).result.then(function(){},function(){i.status.switch=!i.status.switch})},a.OnChargeLog=function(n,t){o.open({size:"lg",templateUrl:"amount_list.html",controller:["$scope","$uibModalInstance",function(o,e){o.startDate=moment().subtract(30,"days").format("YYYY-MM-DD"),o.endDate=moment().format("YYYY-MM-DD"),o.listType="charge",o.listTitle=t,o.listChange=function(e){o.listType=e,o[e].list(),o.gridOptions.columnDefs=o[e].gridOptions.columnDefs},o.cancel=function(){e.dismiss("cancel")},o.charge={},o.charge.list=function(t){t&&o.gridOptions.paging&&o.gridOptions.paging.count<=o.gridOptions.paging.pageindex*o.gridOptions.paging.pagesize||s.business.recentchargelog({project:[{id:r.Project.selected._id,account:n}],from:o.startDate.replace(/-/g,""),to:o.endDate.replace(/-/g,""),pageindex:(t&&o.gridOptions.paging?o.gridOptions.paging.pageindex:0)+1,pagesize:50,status:"SUCCESS"},function(e){return e=e.result[r.Project.selected._id]||{},t?o.gridOptions.data=o.gridOptions.data.concat(e.detail||[]):(o.gridOptions.data=e.detail||[],o.gridOptions.data.length&&i(function(){o.gridApi.core.scrollTo(o.gridOptions.data[0],o.gridOptions.columnDefs[0])})),angular.forEach(o.gridOptions.data,function(e){e.timepaid=e.timepaid&&d("date")(1e3*e.timepaid,"yyyy年M月dd日 H:mm:ss")||""}),o.gridOptions.paging=e.paging,o.gridApi.grid.element.height("auto"),e})},o.gridOptions={showColumnFooter:!0,onRegisterApi:function(a){a.infiniteScroll.on.needLoadMoreData(o,function(){function e(){i.resolve()}function t(){a.infiniteScroll.dataLoaded(),i.reject()}var n,i=l.defer();return(n=o[o.listType].list(!0))?n.then(function(){a.infiniteScroll.saveScrollPercentage(),a.infiniteScroll.dataLoaded(!1,!0).then(e,t)},t):t(),i.promise}),o.gridApi=a},rowHeight:34,infiniteScrollDown:!0,enableColumnResizing:!0,exporterOlderExcelCompatibility:!0,enableSorting:!0,exporterFieldCallback:function(e,t,n,i){return{title:!0,account:!0,timepaid:!0,timecreate:!0,departmentname:!0,departmentaccount:!0,arrearagetime:!0,consists:!0,timepoint:!0}[n.field]?'="'+(i||"")+'"':i}},o.charge.gridOptions={},o.charge.gridOptions.columnDefs=[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">序号</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"充值金额(元)",type:"number",name:"amount",width:"*",minWidth:100,aggregationType:c.aggregationTypes.sum,footerCellFilter:"number:2",enableColumnMenu:!1},{displayName:"充值方式",name:"channel",width:"*",minWidth:100},{displayName:"本次余额",name:"balance",type:"number",width:"*",minWidth:100},{displayName:"操作帐号",name:"operator",type:"string",width:"*",minWidth:100},{displayName:"记账时间",name:"timepaid",type:"date",width:"*",minWidth:100}],o.consume={},o.consume.list=function(t){if(!(t&&o.gridOptions.paging&&o.gridOptions.paging.count<=o.gridOptions.paging.pageindex*o.gridOptions.paging.pagesize))return s.business.departmentusage({from:o.startDate.replace(/-/g,""),to:o.endDate.replace(/-/g,""),pageindex:(t&&o.gridOptions.paging?o.gridOptions.paging.pageindex:0)+1,pagesize:50,project:[{id:r.Project.selected._id,account:n}]},function(e){return e=e.result[r.Project.selected._id]||{},t?(angular.forEach(e.detail,function(e){e.timepoint=e.timepoint&&d("date")(1e3*e.timepoint,"yyyy年M月dd日 H:mm:ss")||e.timepoint}),o.gridOptions.data=o.gridOptions.data.concat(e.detail||[])):(o.gridOptions.data=e.detail||[],o.gridOptions.data.length&&i(function(){o.gridApi.core.scrollTo(o.gridOptions.data[0],o.gridOptions.columnDefs[0])}),angular.forEach(o.gridOptions.data,function(e){e.timepoint=e.timepoint&&d("date")(1e3*e.timepoint,"yyyy年M月dd日 H:mm:ss")||e.timepoint})),o.gridOptions.paging=e.paging,o.gridApi.grid.element.height("auto"),e}).$promise},o.filter=function(){o.gridOptions.enableFiltering=!o.gridOptions.enableFiltering,o.gridApi.core.notifyDataChange(c.dataChange.COLUMN)},o.export=function(){o.gridOptions.exporterCsvFilename=r.Project.selected.title+"_户管理_消耗清单_"+o.listTitle+"_"+d("date")(new Date,"yyyyMMdd_HHmmss")+".csv",o.gridApi.exporter.csvExport("visible","visible",angular.element(document.querySelectorAll(".modal-body")))},o.consume.gridOptions={},o.consume.gridOptions.columnDefs=[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">序号</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"消费项目",name:"consists",width:"*",minWidth:200,enableColumnMenu:!1},{displayName:"消费金额(元)",type:"number",name:"cost",width:"*",aggregationType:c.aggregationTypes.sum,footerCellFilter:"number:2",minWidth:120},{displayName:"剩余金额(元)",type:"number",name:"balance",width:"*",minWidth:120},{displayName:"记账时间",name:"timepoint",type:"date",width:"*",minWidth:200}],o.listChange("charge")}]})},a.amount=function(e,n,a){o.open({size:"md",windowClass:"amount",templateUrl:"amount.html",controller:["$scope","$uibModalInstance",function(t,i){t.title=e,t.account=n,t.amount=a,s.payment.channelinfo({type:"manual",project:r.Project.selected._id,flow:"EARNING"},function(e){t.channels=e.result,t.channels.selected=55}),t.OnCharge=function(){return t.channels.selected?t.cash?(t.ban=!0,void s.payment.charge({uid:n,channel:"Manual",amount:parseFloat(t.cash),channelaccountid:t.channels.selected,project:r.Project.selected._id,subject:"商户项目充值",description:t.description,metadata:{operator:r.Account._id}},function(n){i.dismiss("cancel"),n.result.fn?o.open({size:"sm",windowClass:"downloadLink",templateUrl:"downloadLink.html",controller:["$scope","$uibModalInstance",function(e,t){e.downloadLink="/download/"+n.result.fn,window.open(e.downloadLink),e.cancel=function(){t.dismiss("cancel")}}]}):u.success({html:"成功充值:"+n.result.amount+"元<br/>当前余额:"+n.result.balance+"元",title:"充值成功"}),p.GetDepartment()},function(e){i.dismiss("cancel"),u.error(e.message)})):u.info("请输入充值金额"):u.info("请选择充值方式")},t.cancel=function(){i.dismiss("cancel")}}]})},a.rent=function(i){o.open({size:"md",templateUrl:"rent.html",controller:["$scope","$uibModalInstance","$api",function(e,t,n){e.department=i,e.ok=function(){if(e.user){if(e.passwd)return e.user.length<10?void u.warning("帐号不能低于10位"):e.passwd.length<6?void u.warning("密码不能低于6位"):void n.department.rent({tid:i.tid,projectid:i.project,user:e.user,passwd:e.passwd,mobile:e.mobile,email:e.email},function(e){t.dismiss("cancel"),p.GetDepartment(),u.success(e.message)},function(e){u.error(e.message),t.dismiss("cancel")});u.warning("请填入密码")}else u.warning("请填入帐号")},e.cancel=function(){t.dismiss("cancel")}}]})},a.surrender=function(i){o.open({size:"md",templateUrl:"surrender.html",controller:["$scope","$uibModalInstance","$api",function(t,n,e){0<i.cash?t.amountName="退费":t.amountName="收费",e.payment.channelinfo({type:"manual",project:r.Project.selected._id,flow:"EARNING"},function(e){t.channels=e.result,t.channels.selected=55}),t.department=i,t.ok=function(){return 0!=i.cash&&Number(t.premium)!=Math.abs(i.cash)?void u.error("退费金额必须为"+Math.abs(i.cash)):0==-i.cash||t.channels.selected?void e.department.surrender({tid:i.tid,projectid:i.project,channelaccount:t.channels.selected,description:t.description},function(e){n.dismiss("cancel"),p.GetDepartment(),u.success(e.message)},function(e){t.message=e.message,u.error(e.message),n.dismiss("cancel")}):void u.error("请选择退费渠道")},t.cancel=function(){n.dismiss("cancel")}}]})},a.OnImportDepartment=function(){o.open({size:"sm",templateUrl:"import_department.html",controller:["$scope","$uibModalInstance","SweetAlert","ProjectID",function(e,t,n,i){e.actionURL="/api/import/importdepartment",e.Character="54d032dd877012ac6d37063f",e.ProjectID=i,e.OnCancel=t.dismiss,e.OnUploadComplete=function(e){e.code?n.error(e.result,e.message):(n.success("导入成功"),t.close())}}],resolve:{ProjectID:function(){return r.Project.selected._id}}}).result.then(a.GetDepartment)},a.exportDepartment=function(){delete a.downloadFile,s.export.departmentsinfo({projectid:r.Project.selected._id},function(e){e.result.fn&&(a.downloadFile=e.result.fn,a.downloadName=r.Project.selected.title+"_"+t.$current.data.title)})},a.OnBatchRecharge=function(){o.open({size:"sm",templateUrl:"batch_recharge.html",controller:["$scope","$uibModalInstance","SweetAlert","ProjectID",function(t,n,i,e){t.actionURL="/api/import/importbatchrecharge",t.ProjectID=e,t.OnCancel=n.dismiss,t.OnUploadComplete=function(e){e.code?i.error(e.result,e.message):(i.success("导入成功"),t.OnCancel=n.close,e.result.fn&&(t.downloadLink="/download/"+e.result.fn,window.open(t.downloadLink)))}}],resolve:{ProjectID:function(){return r.Project.selected._id}}}).result.then(a.GetDepartment)},a.remindrecharge=function(e){s.message.remindrecharge({uid:e?e.account:a.multiIds("remindrecharge"),project:r.Project.selected._id},function(){a.GetDepartment(),a.multiCheck.all&&delete a.multiCheck.all,u.success("催缴成功")})}}]);
=======
"use strict";angular.module("app").controller("departmentInfo",["$rootScope","$scope","$timeout","$uibModal","$api","uiGridConstants","$q","$filter","i18nService","$state","SweetAlert","ToFloat",function(e,t,n,i,a,o,r,s,c,l,d,u){c.add("zh-cn",{aggregation:{sum:"合计："}});var m=t;"undefined"!=sessionStorage.departmentKey&&(t.departmentKey=sessionStorage.departmentKey),"undefined"!=sessionStorage.minAmount&&(t.minAmount=sessionStorage.minAmount),"undefined"!=sessionStorage.maxAmount&&(t.maxAmount=sessionStorage.maxAmount),t.tab="occupancy",t.statusenum=[{id:0,title:"全部"},{id:1,title:"正常"},{id:2,title:"欠费"}],t.statusenum.selected=t.statusenum[0].id,t.multiCheck=function(e){"all"===e?(t.multiCheck.all&&(t.showButton=!0),!t.multiCheck.all&&(t.showButton=!1),angular.forEach(t.listData,function(e){e.isSelected=t.multiCheck.all})):(t.multiCheck.all=!0,t.showButton=!1,angular.forEach(t.listData,function(e){e.isSelected||delete t.multiCheck.all,e.isSelected&&(t.showButton=!0)}))},t.OnSelectSensor=function(e,n){t.popIsOpen(),n.preventDefault(),t.SelectSensors=e.sensors||[],i.open({templateUrl:"modal-channelselect.html",controller:"ChannelSelect",size:"lg",resolve:{ProjectID:function(){return e.project},SelectedSensors:function(){return t.SelectSensors||[]}}}).result.then(function(n){t.SelectSensors=n,e.resource={project:[e.project],sensor:[]},angular.forEach(t.SelectSensors,function(t){e.resource.sensor.push(e.project+"."+t._id)}),a.department.update({id:e._id,resource:e.resource},function(){d.success("更新成功"),t.GetDepartment()},d.error)},function(){t.GetDepartment()})},t.multiIds=function(e){var n=[];return angular.forEach(t.listData,function(t){t.isSelected&&"delete"===e?n.push(t._id):t.isSelected&&"remindrecharge"===e&&t.cash<0&&n.push(t.account)}),n},t.paging={total:0,index:1,size:parseInt(sessionStorage.department_info_pagesize||10),items:[{key:10,title:"每页10条"},{key:15,title:"每页15条"},{key:30,title:"每页30条"},{key:50,title:"每页50条"},{key:100,title:"每页100条"}]},t.GetDepartment=function(){sessionStorage.departmentKey=t.departmentKey,sessionStorage.minAmount=t.minAmount,sessionStorage.maxAmount=t.maxAmount,t.multiCheck.all=!1,t.showButton=!1,t.listData&&t.listData.loading||(t.listData&&(t.listData.loading=!0),a.department.info({project:e.Project.selected._id,keyreg:t.departmentKey,minAmount:t.minAmount||void 0,maxAmount:t.maxAmount||void 0,arrear:{1:!1,2:!0}[t.statusenum.selected],status:"occupancy"==t.tab&&1||0,pageindex:t.paging.index,pagesize:t.paging.size},function(e){e=e.result,t.statistic=e.statistic,e.detail=angular.isArray(e.detail)&&e.detail||e.detail&&[e.detail]||[],angular.forEach(e.detail,function(e){e.cash&&(e.cash=u(e.cash)),e.sensorAll=[],angular.forEach(e.sensors,function(t){e.sensorAll.push(t.title+"\n"),t.status.switch={EMC_ON:!0,EMC_OFF:!1}[t.status.switch]||!1}),e.sensorAll=e.sensorAll.join("")}),t.listData=e.detail,t.listData.count=(e.paging||{}).count||0,t.listData.index=(e.paging||{}).pageindex||1,t.listData.total=(e.paging||{}).count||0},function(){delete t.listData}))},t.arrearInfo=function(e,n,i,a){t.arrearShow=e,t.statusenum.selected=n,t.maxAmount=i,t.minAmount=a,t.GetDepartment()},t.rentAlready=function(){t.tab="occupancy",t.arrearShow=!1,t.statusenum.selected=void 0,t.maxAmount=void 0,t.minAmount=void 0,t.GetDepartment()},t.$watch("statusenum.selected",function(e){angular.isDefined(e)&&(sessionStorage.department_info_status=e),t.paging.index=1,t.GetDepartment()}),t.$watch("paging.index",function(){t.listData&&t.GetDepartment()}),t.$watch("paging.size",function(e){t.multiCheck.all=!1,angular.isDefined(e)&&(sessionStorage.department_info_pagesize=e),n(t.listData&&t.GetDepartment)}),t.DoRemove=function(){var e=!1;angular.forEach(t.multiIds("delete"),function(n){angular.forEach(t.listData,function(t){t._id==n&&0!=t.cash&&(e=!0)})}),e?d.error("所选商户中有商户余额不为 0 无法删除"):i.open({size:"sm",templateUrl:"departmentDelete.html",controller:["$scope","$uibModalInstance","$api",function(e,t,n){e.cancel=function(){t.dismiss()},e.ok=function(){t.dismiss(),n.department.delete({id:m.multiIds("delete")},function(){m.GetDepartment()},d.error)}}]})},t.changePercent=function(t){a.apportionment.info({cids:t},function(n){i.open({size:"md",templateUrl:"changePercent.html",controller:["$scope","$uibModalInstance",function(i,o){i.apportionmentPercent=n.result[0],angular.forEach(i.apportionmentPercent.share,function(e){a.department.info({id:e.tid},function(t){e.account=t.result.account})}),i.ok=function(){var n=[];i.execute=!0,angular.forEach(i.apportionmentPercent.share,function(e){0==e.percent&&(i.execute=!1),n.push({cid:t,tid:e.tid,percent:e.percent})}),!i.execute&&d.error("分摊不能为0"),i.execute&&a.apportionment.percent({projectid:e.Project.selected._id,binds:n},function(){d.success("修改成功"),o.dismiss("cancel"),m.GetDepartment()},function(e){var t;switch(e.code){case 20000003:t="参数不全";break;case 20000013:t="用户已经存在";break;case 20000030:t="此表分摊总百分比不等于100%";break;default:t="未知错误"}d.error(t)})},i.cancel=function(){o.dismiss("cancel")}}]})})},t.sensorChange=function(e,t){var n={mobile:"mobileChange.html",title:"titleChange.html",alerthreshold:"alerthresholdChange.html"};i.open({size:"sm",templateUrl:n[t],controller:["$scope","$uibModalInstance",function(t,n){t.department=angular.copy(e),t.title=t.department.title,t.ok=function(){a.department.update(t.department,function(){angular.extend(e,t.department),d.success("更新成功")},d.error),t.OnCancel=n.dismiss("cancel")},t.cancel=function(){t.OnCancel=n.dismiss("cancel")}}]})},t.popIsOpen=function(){angular.forEach(t.listData,function(e){delete e.usertitleIsOpen,delete e.titleIsOpen,delete e.mobileIsOpen,delete e.accountIsOpen,delete e.alerthresholdIsOpen})},t.popover={url:{title:"titleChange.html",usertitle:"usertitleChange.html",mobile:"mobileChange.html",account:"accountChange.html",alerthreshold:"alerthresholdChange.html"},title:{title:"商户名称修改",usertitle:"租户名称修改",mobile:"商户手机号修改",account:"商户账户修改",alerthreshold:"报警阀值修改"},ok:function(e,n,i){if("account"==n&&i.account.length<10)return void d.warning("商户账户至少为10位");e[n+"IsOpen"]=!1,t.department=angular.copy(e),t.department[n]=i[n],a.department.update({id:t.department._id,title:t.department.title,usertitle:t.department.usertitle,mobile:t.department.mobile,account:t.department.account,alerthreshold:t.department.alerthreshold},function(){e[n]=i[n],d.success("更新成功")},d.error)},cancel:function(e,t){e[t+"IsOpen"]=!1}},t.switchControl=function(t){i.open({size:"sm",templateUrl:"switch_control.html",controller:["$scope","$uibModalInstance","$api",function(n,i,a){n.OnSubmit=function(){a.control.send({id:t.sid,uid:e.Account._id,project:t.project,ctrlcode:(new Hashes.SHA1).hex(n.password).toUpperCase(),command:"EMC_SWITCH",param:{mode:t.status.switch?"EMC_ON":"EMC_OFF"}},function(){i.close()},d.error)},n.OnCancel=i.dismiss}]}).result.then(function(){},function(){t.status.switch=!t.status.switch})},t.OnChargeLog=function(t,c){i.open({size:"lg",templateUrl:"amount_list.html",controller:["$scope","$uibModalInstance",function(i,l){i.startDate=moment().subtract(30,"days").format("YYYY-MM-DD"),i.endDate=moment().format("YYYY-MM-DD"),i.listType="charge",i.listTitle=c,i.listChange=function(e){i.listType=e,i[e].list(),i.gridOptions.columnDefs=i[e].gridOptions.columnDefs},i.cancel=function(){l.dismiss("cancel")},i.charge={},i.charge.list=function(o){o&&i.gridOptions.paging&&i.gridOptions.paging.count<=i.gridOptions.paging.pageindex*i.gridOptions.paging.pagesize||a.business.recentchargelog({project:[{id:e.Project.selected._id,account:t}],from:i.startDate.replace(/-/g,""),to:i.endDate.replace(/-/g,""),pageindex:(o&&i.gridOptions.paging?i.gridOptions.paging.pageindex:0)+1,pagesize:50,status:"SUCCESS"},function(t){return t=t.result[e.Project.selected._id]||{},o?i.gridOptions.data=i.gridOptions.data.concat(t.detail||[]):(i.gridOptions.data=t.detail||[],i.gridOptions.data.length&&n(function(){i.gridApi.core.scrollTo(i.gridOptions.data[0],i.gridOptions.columnDefs[0])})),angular.forEach(i.gridOptions.data,function(e){e.timepaid=e.timepaid&&s("date")(1e3*e.timepaid,"yyyy年M月dd日 H:mm:ss")||""}),i.gridOptions.paging=t.paging,i.gridApi.grid.element.height("auto"),t})},i.gridOptions={showColumnFooter:!0,onRegisterApi:function(e){e.infiniteScroll.on.needLoadMoreData(i,function(){var t=r.defer(),n=function(){t.resolve()},a=function(){e.infiniteScroll.dataLoaded(),t.reject()};return function(t){t?t.then(function(){e.infiniteScroll.saveScrollPercentage(),e.infiniteScroll.dataLoaded(!1,!0).then(n,a)},a):a()}(i[i.listType].list(!0)),t.promise}),i.gridApi=e},rowHeight:34,infiniteScrollDown:!0,enableColumnResizing:!0,exporterOlderExcelCompatibility:!0,enableSorting:!0,exporterFieldCallback:function(e,t,n,i){return{title:!0,account:!0,timepaid:!0,timecreate:!0,departmentname:!0,departmentaccount:!0,arrearagetime:!0,consists:!0,timepoint:!0}[n.field]?'="'+(i||"")+'"':i}},i.charge.gridOptions={},i.charge.gridOptions.columnDefs=[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">序号</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"充值金额(元)",type:"number",name:"amount",width:"*",minWidth:100,aggregationType:o.aggregationTypes.sum,footerCellFilter:"number:2",enableColumnMenu:!1},{displayName:"充值方式",name:"channel",width:"*",minWidth:100},{displayName:"本次余额",name:"balance",type:"number",width:"*",minWidth:100},{displayName:"操作帐号",name:"operator",type:"string",width:"*",minWidth:100},{displayName:"记账时间",name:"timepaid",type:"date",width:"*",minWidth:100}],i.consume={},i.consume.list=function(o){if(!(o&&i.gridOptions.paging&&i.gridOptions.paging.count<=i.gridOptions.paging.pageindex*i.gridOptions.paging.pagesize))return a.business.departmentusage({from:i.startDate.replace(/-/g,""),to:i.endDate.replace(/-/g,""),pageindex:(o&&i.gridOptions.paging?i.gridOptions.paging.pageindex:0)+1,pagesize:50,project:[{id:e.Project.selected._id,account:t}]},function(t){return t=t.result[e.Project.selected._id]||{},o?(angular.forEach(t.detail,function(e){e.timepoint=e.timepoint&&s("date")(1e3*e.timepoint,"yyyy年M月dd日 H:mm:ss")||e.timepoint}),i.gridOptions.data=i.gridOptions.data.concat(t.detail||[])):(i.gridOptions.data=t.detail||[],i.gridOptions.data.length&&n(function(){i.gridApi.core.scrollTo(i.gridOptions.data[0],i.gridOptions.columnDefs[0])}),angular.forEach(i.gridOptions.data,function(e){e.timepoint=e.timepoint&&s("date")(1e3*e.timepoint,"yyyy年M月dd日 H:mm:ss")||e.timepoint})),i.gridOptions.paging=t.paging,i.gridApi.grid.element.height("auto"),t}).$promise},i.filter=function(){i.gridOptions.enableFiltering=!i.gridOptions.enableFiltering,i.gridApi.core.notifyDataChange(o.dataChange.COLUMN)},i.export=function(){i.gridOptions.exporterCsvFilename=e.Project.selected.title+"_户管理_消耗清单_"+i.listTitle+"_"+s("date")(new Date,"yyyyMMdd_HHmmss")+".csv",i.gridApi.exporter.csvExport("visible","visible",angular.element(document.querySelectorAll(".modal-body")))},i.consume.gridOptions={},i.consume.gridOptions.columnDefs=[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">序号</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"消费项目",name:"consists",width:"*",minWidth:200,enableColumnMenu:!1},{displayName:"消费金额(元)",type:"number",name:"cost",width:"*",aggregationType:o.aggregationTypes.sum,footerCellFilter:"number:2",minWidth:120},{displayName:"剩余金额(元)",type:"number",name:"balance",width:"*",minWidth:120},{displayName:"记账时间",name:"timepoint",type:"date",width:"*",minWidth:200}],i.listChange("charge")}]})},t.amount=function(t,n,o){i.open({size:"md",windowClass:"amount",templateUrl:"amount.html",controller:["$scope","$uibModalInstance",function(r,s){r.title=t,r.account=n,r.amount=o,a.payment.channelinfo({type:"manual",project:e.Project.selected._id,flow:"EARNING"},function(e){r.channels=e.result,r.channels.selected=55}),r.OnCharge=function(){return r.channels.selected?r.cash?(r.ban=!0,void a.payment.charge({uid:n,channel:"Manual",amount:parseFloat(r.cash),channelaccountid:r.channels.selected,project:e.Project.selected._id,subject:"商户项目充值",description:r.description,metadata:{operator:e.Account._id}},function(e){s.dismiss("cancel"),e.result.fn?i.open({size:"sm",windowClass:"downloadLink",templateUrl:"downloadLink.html",controller:["$scope","$uibModalInstance",function(t,n){t.downloadLink="/download/"+e.result.fn,window.open(t.downloadLink),t.cancel=function(){n.dismiss("cancel")}}]}):d.success({html:"成功充值:"+e.result.amount+"元<br/>当前余额:"+e.result.balance+"元",title:"充值成功"}),m.GetDepartment()},function(e){s.dismiss("cancel"),d.error(e.message)})):d.info("请输入充值金额"):d.info("请选择充值方式")},r.cancel=function(){s.dismiss("cancel")}}]})},t.rent=function(e){i.open({size:"md",templateUrl:"rent.html",controller:["$scope","$uibModalInstance","$api",function(t,n,i){t.department=e,t.ok=function(){return t.user?t.passwd?t.user.length<10?void d.warning("帐号不能低于10位"):t.passwd.length<6?void d.warning("密码不能低于6位"):void i.department.rent({tid:e.tid,projectid:e.project,user:t.user,passwd:t.passwd,mobile:t.mobile,email:t.email},function(e){n.dismiss("cancel"),m.GetDepartment(),d.success(e.message)},function(e){d.error(e.message),n.dismiss("cancel")}):void d.warning("请填入密码"):void d.warning("请填入帐号")},t.cancel=function(){n.dismiss("cancel")}}]})},t.surrender=function(t){i.open({size:"md",templateUrl:"surrender.html",controller:["$scope","$uibModalInstance","$api",function(n,i,a){t.cash>0?n.amountName="退费":n.amountName="收费",a.payment.channelinfo({type:"manual",project:e.Project.selected._id,flow:"EARNING"},function(e){n.channels=e.result,n.channels.selected=55}),n.department=t,n.ok=function(){return 0!=t.cash&&Number(n.premium)!=Math.abs(t.cash)?void d.error("退费金额必须为"+Math.abs(t.cash)):0==-t.cash||n.channels.selected?void a.department.surrender({tid:t.tid,projectid:t.project,channelaccount:n.channels.selected,description:n.description},function(e){i.dismiss("cancel"),m.GetDepartment(),d.success(e.message)},function(e){n.message=e.message,d.error(e.message),i.dismiss("cancel")}):void d.error("请选择退费渠道")},n.cancel=function(){i.dismiss("cancel")}}]})},t.OnImportDepartment=function(){i.open({size:"sm",templateUrl:"import_department.html",controller:["$scope","$uibModalInstance","SweetAlert","ProjectID",function(e,t,n,i){e.actionURL="/api/import/importdepartment",e.Character="54d032dd877012ac6d37063f",e.ProjectID=i,e.OnCancel=t.dismiss,e.OnUploadComplete=function(e){e.code?n.error(e.result,e.message):(n.success("导入成功"),t.close())}}],resolve:{ProjectID:function(){return e.Project.selected._id}}}).result.then(t.GetDepartment)},t.exportDepartment=function(){delete t.downloadFile,a.export.departmentsinfo({projectid:e.Project.selected._id},function(n){n.result.fn&&(t.downloadFile=n.result.fn,t.downloadName=e.Project.selected.title+"_"+l.$current.data.title)})},t.OnBatchRecharge=function(){i.open({size:"sm",templateUrl:"batch_recharge.html",controller:["$scope","$uibModalInstance","SweetAlert","ProjectID",function(e,t,n,i){e.actionURL="/api/import/importbatchrecharge",e.ProjectID=i,e.OnCancel=t.dismiss,e.OnUploadComplete=function(i){i.code?n.error(i.result,i.message):(n.success("导入成功"),e.OnCancel=t.close,i.result.fn&&(e.downloadLink="/download/"+i.result.fn,window.open(e.downloadLink)))}}],resolve:{ProjectID:function(){return e.Project.selected._id}}}).result.then(t.GetDepartment)},t.remindrecharge=function(n){a.message.remindrecharge({uid:n?n.account:t.multiIds("remindrecharge"),project:e.Project.selected._id},function(){t.GetDepartment(),t.multiCheck.all&&delete t.multiCheck.all,d.success("催缴成功")})}}]);
>>>>>>> 6e3d1a2aa57f97a11542dd09c3d02693cef0d7c3
