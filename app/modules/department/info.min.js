"use strict";angular.module("app").controller("departmentInfo",["$rootScope","$scope","$timeout","$uibModal","$localStorage","$api","uiGridConstants","$q","$filter","i18nService","$state","SweetAlert",function(e,t,n,i,a,o,l,r,c,s,d,u){s.add("zh-cn",{aggregation:{sum:"合计："}});var p=t;t.statusenum=[{id:0,title:"全部"},{id:1,title:"正常"},{id:2,title:"欠费"}],t.statusenum.selected=parseInt(a.department_info_status||t.statusenum[0].id),t.multiCheck=function(e){"all"===e?(t.multiCheck.all&&(t.showButton=!0),!t.multiCheck.all&&(t.showButton=!1),angular.forEach(t.listData,function(e){e.isSelected=t.multiCheck.all})):(t.multiCheck.all=!0,t.showButton=!1,angular.forEach(t.listData,function(e){e.isSelected||delete t.multiCheck.all,e.isSelected&&(t.showButton=!0)}))},t.OnSelectSensor=function(e,n){n.preventDefault(),t.SelectSensors=e.sensors||[],i.open({templateUrl:"modal-channelselect.html",controller:"ChannelSelect",size:"lg",resolve:{ProjectID:function(){return e.project},SelectedSensors:function(){return t.SelectSensors||[]}}}).result.then(function(n){t.SelectSensors=n,e.resource={project:[e.project],sensor:[]},angular.forEach(t.SelectSensors,function(t){e.resource.sensor.push(e.project+"."+t._id)}),o.department.update(e,function(){u.success("更新成功"),t.GetDepartment()},u.error)},function(){t.GetDepartment()})},t.multiIds=function(e){var n=[];return angular.forEach(t.listData,function(t){t.isSelected&&"delete"===e?n.push(t._id):t.isSelected&&"remindrecharge"===e&&t.account.billingAccount.cash<0&&n.push(t.account._id)}),n},t.paging={total:0,index:1,size:parseInt(a.department_info_pagesize||10),items:[{key:10,title:"每页10条"},{key:15,title:"每页15条"},{key:30,title:"每页30条"},{key:50,title:"每页50条"},{key:100,title:"每页100条"}]},t.GetDepartment=function(){t.multiCheck.all=!1,t.showButton=!1,t.listData&&t.listData.loading||(t.listData&&(t.listData.loading=!0),o.department.info({project:e.Project.selected._id,keyreg:t.departmentKey,amount:t.filterAmount?parseFloat(t.filterAmount):void 0,arrear:{1:!1,2:!0}[t.statusenum.selected],pageindex:t.paging.index,pagesize:t.paging.size},function(e){e=e.result,e.detail=angular.isArray(e.detail)&&e.detail||e.detail&&[e.detail]||[],angular.forEach(e.detail,function(e){e.account&&e.account.billingAccount&&(e.account.billingAccount.cash<0?e.status="欠费":e.status="正常"),e.sensorAll=[],angular.forEach(e.sensors,function(t){e.sensorAll.push(t.title+"\n"),t.status.switch={EMC_ON:!0,EMC_OFF:!1}[t.status.switch]||!1}),e.sensorAll=e.sensorAll.join("")}),t.listData=e.detail,t.listData.count=(e.paging||{}).count||0,t.listData.index=(e.paging||{}).pageindex||1,t.listData.total=(e.paging||{}).count||0},function(){delete t.listData}))},t.GetDepartment(),t.$watch("statusenum.selected",function(e){a.department_info_status=e,t.paging.index=1,t.GetDepartment()}),t.$watch("paging.index",function(){t.listData&&t.GetDepartment()}),t.$watch("paging.size",function(e){t.multiCheck.all=!1,a.department_info_pagesize=e,n(t.listData&&t.GetDepartment)}),t.DoRemove=function(){var e=!1;angular.forEach(t.multiIds("delete"),function(n){angular.forEach(t.listData,function(t){t._id==n&&0!=t.account.billingAccount.cash&&(e=!0)})}),e?u.error("所选商户中有商户余额不为 0 无法删除"):i.open({size:"sm",templateUrl:"departmentDelete.html",controller:["$scope","$uibModalInstance","$api",function(e,t,n){e.cancel=function(){t.dismiss()},e.ok=function(){t.dismiss(),n.department.delete({id:p.multiIds("delete")},function(){p.GetDepartment()},u.error)}}]})},t.sensorChange=function(e,t){var n={mobile:"mobileChange.html",title:"titleChange.html",alerthreshold:"alerthresholdChange.html"};i.open({size:"sm",templateUrl:n[t],controller:["$scope","$uibModalInstance",function(t,n){t.department=angular.copy(e),t.title=t.department.title,t.ok=function(){t.department.mobile=t.department.account.mobile,t.department.alerthreshold=t.department.account.billingAccount.alerthreshold,o.department.update(t.department,function(){angular.extend(e,t.department),u.success("更新成功")},u.error),t.OnCancel=n.dismiss("cancel")},t.cancel=function(){t.OnCancel=n.dismiss("cancel")}}]})},t.switchControl=function(t){i.open({size:"sm",templateUrl:"switch_control.html",controller:["$scope","$uibModalInstance","$api",function(n,i,a){n.OnSubmit=function(){a.control.send({id:t.sid,uid:e.Account._id,project:t.project,ctrlcode:(new Hashes.SHA1).hex(n.password).toUpperCase(),command:"EMC_SWITCH",param:{mode:t.status.switch?"EMC_ON":"EMC_OFF"}},function(){i.close()},u.error)},n.OnCancel=i.dismiss}]}).result.then(function(){},function(){t.status.switch=!t.status.switch})},t.OnChargeLog=function(t){console.log(t),i.open({size:"lg",templateUrl:"amount_list.html",controller:["$scope","$uibModalInstance",function(i,a){i.startDate=c("date")(new Date,"yyyy-MM-01"),i.endDate=c("date")(new Date,"yyyy-MM-dd"),i.listType="charge",o.account.info({id:t},function(e){i.listTitle=e.result.title,i.charge.list()}),i.listChange=function(e){i.listType=e,i[e].list(),i.gridOptions=i[e].gridOptions},i.cancel=function(){a.dismiss("cancel")},i.charge={},i.charge.list=function(a){a&&i.gridOptions.paging&&i.gridOptions.paging.count<=i.gridOptions.paging.pageindex*i.gridOptions.paging.pagesize||o.business.recentchargelog({project:[{id:e.Project.selected._id,account:t}],from:i.startDate.replace(/-/g,""),to:i.endDate.replace(/-/g,""),pageindex:(a&&i.gridOptions.paging?i.gridOptions.paging.pageindex:0)+1,pagesize:50,status:"SUCCESS"},function(t){return t=t.result[e.Project.selected._id]||{},a?i.gridOptions.data=i.gridOptions.data.concat(t.detail||[]):(i.gridOptions.data=t.detail||[],i.gridOptions.data.length&&n(function(){i.gridApi.core.scrollTo(i.gridOptions.data[0],i.gridOptions.columnDefs[0])})),angular.forEach(i.gridOptions.data,function(e){e.timepaid=e.timepaid&&c("date")(1e3*e.timepaid,"yyyy年M月dd日 H:mm:ss")||""}),i.gridOptions.paging=t.paging,i.gridApi.grid.element.height("auto"),t})},i.charge.gridOptions={showColumnFooter:!0,onRegisterApi:function(e){e.infiniteScroll.on.needLoadMoreData(i,function(){var t=r.defer(),n=function(){t.resolve()},a=function(){e.infiniteScroll.dataLoaded(),t.reject()};return function(t){t?t.then(function(){e.infiniteScroll.saveScrollPercentage(),e.infiniteScroll.dataLoaded(!1,!0).then(n,a)},a):a()}(i.charge.list(!0)),t.promise}),i.gridApi=e},rowHeight:34,infiniteScrollDown:!0,enableColumnResizing:!0,exporterOlderExcelCompatibility:!0,enableSorting:!0,columnDefs:[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">序号</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"充值金额(元)",type:"number",name:"amount",width:"*",minWidth:200,aggregationType:l.aggregationTypes.sum,footerCellFilter:"number:2",enableColumnMenu:!1},{displayName:"充值方式",name:"channel",width:"*",minWidth:120},{displayName:"记账时间",name:"timepaid",type:"date",width:"*",minWidth:200}],exporterFieldCallback:function(e,t,n,i){return{title:!0,account:!0,timepaid:!0,timecreate:!0,departmentname:!0,departmentaccount:!0,arrearagetime:!0,consists:!0,timepoint:!0}[n.field]?'="'+(i||"")+'"':i}},i.consume={},i.consume.list=function(a){if(!(a&&i.gridOptions.paging&&i.gridOptions.paging.count<=i.gridOptions.paging.pageindex*i.gridOptions.paging.pagesize))return o.business.departmentusage({from:i.startDate.replace(/-/g,""),to:i.endDate.replace(/-/g,""),pageindex:(a&&i.gridOptions.paging?i.gridOptions.paging.pageindex:0)+1,pagesize:50,project:[{id:e.Project.selected._id,account:t}]},function(t){return t=t.result[e.Project.selected._id]||{},a?i.gridOptions.data=i.gridOptions.data.concat(t.detail||[]):(i.gridOptions.data=t.detail||[],i.gridOptions.data.length&&n(function(){i.gridApi.core.scrollTo(i.gridOptions.data[0],i.gridOptions.columnDefs[0])})),angular.forEach(i.gridOptions.data,function(e){e.timepoint=e.timepoint&&c("date")(1e3*e.timepoint,"yyyy年M月dd日 H:mm:ss")||""}),i.gridOptions.paging=t.paging,i.gridApi.grid.element.height("auto"),t}).$promise},i.filter=function(){i.gridOptions.enableFiltering=!i.gridOptions.enableFiltering,i.gridApi.core.notifyDataChange(l.dataChange.COLUMN)},i.export=function(){i.gridOptions.exporterCsvFilename=e.Project.selected.title+"_户管理_消耗清单_"+i.listTitle+"_"+c("date")(new Date,"yyyyMMdd_HHmmss")+".csv",i.gridApi.exporter.csvExport("visible","visible",angular.element(document.querySelectorAll(".modal-body")))},i.consume.gridOptions={showColumnFooter:!0,onRegisterApi:function(e){e.infiniteScroll.on.needLoadMoreData(i,function(){var t=r.defer(),n=function(){t.resolve()},a=function(){e.infiniteScroll.dataLoaded(),t.reject()};return function(t){t?t.then(function(){e.infiniteScroll.saveScrollPercentage(),e.infiniteScroll.dataLoaded(!1,!0).then(n,a)},a):a()}(i.consume.list(!0)),t.promise}),i.gridApi=e},rowHeight:34,infiniteScrollDown:!0,enableColumnResizing:!0,exporterOlderExcelCompatibility:!0,enableSorting:!0,columnDefs:[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">序号</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"消费项目",name:"consists",width:"*",minWidth:200,enableColumnMenu:!1},{displayName:"消费金额(元)",type:"number",name:"cost",width:"*",aggregationType:l.aggregationTypes.sum,footerCellFilter:"number:2",minWidth:120},{displayName:"记账时间",name:"timepoint",type:"date",width:"*",minWidth:200}],exporterFieldCallback:function(e,t,n,i){return{title:!0,account:!0,timepaid:!0,timecreate:!0,departmentname:!0,departmentaccount:!0,arrearagetime:!0,consists:!0,timepoint:!0}[n.field]?'="'+(i||"")+'"':i}},i.listChange("charge")}]})},t.amount=function(t,n,a){i.open({size:"md",windowClass:"amount",templateUrl:"amount.html",controller:["$scope","$uibModalInstance",function(l,r){l.title=t,l.account=n,l.amount=a,o.payment.channelinfo({type:"manual",project:e.Project.selected._id,flow:"EARNING"},function(e){l.channels=e.result}),l.OnCharge=function(){return l.channels.selected?l.cash?(l.ban=!0,void o.payment.charge({uid:n,channel:"Manual",amount:parseFloat(l.cash),channelaccountid:l.channels.selected,project:e.Project.selected._id,subject:"商户项目充值",body:"充值项目: "+e.Project.selected.title,metadata:{operator:e.Account._id}},function(e){r.dismiss("cancel"),e.result.fn?i.open({size:"sm",windowClass:"downloadLink",templateUrl:"downloadLink.html",controller:["$scope","$uibModalInstance",function(t,n){t.downloadLink="/download/"+e.result.fn,window.open(t.downloadLink),t.cancel=function(){n.dismiss("cancel")}}]}):u.success("充值成功","成功充值"+e.result.amount+"元当前账户余额"+e.result.balance+"元"),p.GetDepartment()},function(e){r.dismiss("cancel"),u.error(e.message)})):u.warning("请输入充值金额"):u.warning("请选择充值方式")},l.cancel=function(){r.dismiss("cancel")}}]})},t.OnImportDepartment=function(){i.open({size:"sm",templateUrl:"import_department.html",controller:["$scope","$uibModalInstance","SweetAlert","ProjectID",function(e,t,n,i){e.actionURL="/api/import/importdepartment",e.Character="54d032dd877012ac6d37063f",e.ProjectID=i,e.OnCancel=t.dismiss,e.OnUploadComplete=function(e){e.code?n.error(e.result,e.message):(n.success("导入成功"),t.close())}}],resolve:{ProjectID:function(){return e.Project.selected._id}}}).result.then(t.GetDepartment)},t.exportDepartment=function(){delete t.downloadFile,o.export.departmentsinfo({projectid:e.Project.selected._id},function(n){n.result.fn&&(t.downloadFile=n.result.fn,t.downloadName=e.Project.selected.title+"_"+d.$current.data.title)})},t.OnBatchRecharge=function(){i.open({size:"sm",templateUrl:"batch_recharge.html",controller:["$scope","$uibModalInstance","SweetAlert","ProjectID",function(e,t,n,i){e.actionURL="/api/import/importbatchrecharge",e.ProjectID=i,e.OnCancel=t.dismiss,e.OnUploadComplete=function(i){i.code?n.error(i.result,i.message):(n.success("导入成功"),e.OnCancel=t.close,i.result.fn&&(e.downloadLink="/download/"+i.result.fn,window.open(e.downloadLink)))}}],resolve:{ProjectID:function(){return e.Project.selected._id}}}).result.then(t.GetDepartment)},t.remindrecharge=function(n){o.message.remindrecharge({uid:n?n.account._id:t.multiIds("remindrecharge"),project:e.Project.selected._id},function(){t.GetDepartment(),t.multiCheck.all&&delete t.multiCheck.all})}}]);