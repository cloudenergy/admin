"use strict";angular.module("app").component("billingUpdate",{templateUrl:"app/modules/billingservice/manage.html?rev=e68f19698e",controller:["$rootScope","$api","$state","UI","$uibModal","$scope","$timeout","$stateParams",function(e,n,o,r,i,t,s,a){var u=this;u.times=[],u.date=[],u.viewSensors=[],u.SelectedSensorsIDS=[],n.billingservice.info({id:o.params.id,verbose:!0},function(e){if(e=e.result,u.serviceTitle=e.title,e.rules){if(u.advanced=!0,e.rules.timequantumprice||e.rules.week||e.rules.day||(u.advanced=!1),e.rules.timequantumprice){var n={},o=0;angular.forEach(e.rules.timequantumprice,function(r,i){o++,n.price!==r?(angular.isUndefined(n.price)||(n.HourTo||(n.HourTo=n.HourFrom+1),u.times.push(n),n={}),n.HourFrom=i,n.price=r,o===e.rules.timequantumprice.length&&(n.HourTo=i+1,24==n.HourTo&&(n.HourTo=0),u.times.push(n))):(n.HourTo=i+1,24==n.HourTo&&(n.HourTo=0),o===e.rules.timequantumprice.length&&u.times.push(n))})}else u.times=[{HourFrom:void 0,HourTo:void 0,price:void 0},{HourFrom:void 0,HourTo:void 0,price:void 0}],u.fixprice=e.rules.fixprice;u.equipments=e.equipments,angular.forEach(u.equipments,function(e){u.viewSensors.push(e)}),s(function(){u.setSelectChecked()},100)}}),u.hours=[];for(var l=0;l<24;l++)u.hours.push(l);u.addTime=function(){u.times.push({HourFrom:void 0,HourTo:void 0,price:void 0})},u.removeTime=function(e){u.times.splice(e,1)},u.submit=function(){var i=document.getElementsByClassName("hourFrom"),s=document.getElementsByClassName("hourTo"),l={},c=!0;if(angular.forEach(i,function(e){Number(e.value)||0==e.value||(c=!1)}),angular.forEach(s,function(e){Number(e.value)||0==e.value||(c=!1)}),!c)return r.AlertWarning("请选择日期"),!1;u.advanced?(l.timequantumprice=[void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0],angular.forEach(u.times,function(e){if(Number(e.HourFrom)<Number(e.HourTo))for(var n=Number(e.HourFrom);n<Number(e.HourTo);n++)l.timequantumprice[n]=e.price}),angular.forEach(l.timequantumprice,function(e,n){void 0===e&&(l.timequantumprice[n]=0)})):l.fixprice=u.fixprice,t.OnSelectSensor=function(e){e.preventDefault()},n.billingservice.update({id:a.id,title:u.serviceTitle,projectid:e.Project.selected._id,rules:l},function(){r.AlertSuccess("保存成功"),o.go("admin.billingservice.info")},r.AlertError)},u.setSelectChecked=function(){var e=document.getElementsByClassName("hourFrom"),n=document.getElementsByClassName("hourTo");angular.forEach(e,function(e,n){for(var o=0;o<e.options.length;o++)if(String(e.options[o].innerHTML)==String(u.times[n].HourFrom)){e.options[o].selected=!0;break}}),angular.forEach(n,function(e,n){for(var o=0;o<e.options.length;o++)if(String(e.options[o].innerHTML)==String(u.times[n].HourTo)){e.options[o].selected=!0;break}})},u.OnSelectSensor=function(n){n.preventDefault(),i.open({templateUrl:"modal-channelselectUpdate.html",controller:"ChannelSelectUpdate",size:"lg",resolve:{ProjectID:function(){return e.Project.selected._id},ViewSensors:function(){return u.viewSensors||[]},DeleteIDS:function(){return u.DeleteIDS||[]},SelectedSensors:function(){return t.SelectSensors||[]},SelectedSensorsIDS:function(){return u.SelectedSensorsIDS||[]}}}).result.then(function(e){u.DeleteIDS=e.DeleteIDS,u.SelectSensors=e.SelectedSensors,u.SelectedSensorsIDS=e.SelectedSensorsIDS},function(){})}}]}),angular.module("app").controller("ChannelSelectUpdate",["$scope","$rootScope","$uibModal","$uibModalInstance","$api","ProjectID","SelectedSensors","SelectedSensorsIDS","DeleteIDS","ViewSensors","$stateParams","$state","UI",function(e,n,o,r,i,t,s,a,u,l,c,d,f){var S;e.currentPage=1,e.project=t,e.popPageSize=8,e.UpdateAffirm=function(){o.open({templateUrl:"UpdateAffirm.html",size:"md",resolve:{DeleteIDS:function(){return u||[]},SelectedSensorsIDS:function(){return a||[]},removeSensor:function(){return e.removeSensor||[]},addSensor:function(){return e.addSensor||[]}},controller:["DeleteIDS","SelectedSensorsIDS","$scope","$uibModalInstance","removeSensor","addSensor",function(e,o,r,t,s,a){r.addSensor=a,r.removeSensor=s,r.DeleteIDS=e,r.SelectedSensorsIDS=o,r.Ok=function(){t.dismiss("cancel"),i.billingservice.update({id:c.id,projectid:n.Project.selected._id,removeChannels:e||void 0,addChannels:o||void 0},function(){f.AlertSuccess("修改计费仪表成功"),d.go("admin.billingservice.manage",{id:c.id},{reload:!0})},f.AlertError)},r.Cancel=function(){t.dismiss("cancel")}}]}).result.then(function(e){},function(){})},e.Ok=function(){u=[],a=[],e.addSensor=[],e.removeSensor=[],angular.forEach(e.viewOfSensors,function(n){n.isEnable!=n.preIsEnable&&(1==n.preIsEnable?(u.push(n.id),e.removeSensor.push(n)):(a.push(n.id),e.addSensor.push(n)))}),(u.length||a.length)&&e.UpdateAffirm(),r.dismiss("cancel")},e.Cancel=function(){r.dismiss("cancel")},e.SwitchSensor=function(n,o){n.preventDefault(),s=[],o.isEnable=!o.isEnable,angular.forEach(e.viewOfSensors,function(e,n){1==e.isEnable&&s.push(e)})},e.onSearchSensor=function(n){n.preventDefault(),e.UpdateViewOfSensors(e.sensorSearchKey)},e.OnSelectAll=function(n){n.preventDefault(),angular.forEach(e.viewOfSensors,function(e){e.isEnable=!0,s.push(e)})},angular.forEach(l,function(e){e.isEnable=!0,e.preIsEnable=e.isEnable}),e.UpdateViewOfSensors=function(n){e.viewOfSensors=[],n?_.each(e.operableSensors,function(o){o.title.match(n)?e.viewOfSensors.push(o):o.addrid&&o.addrid.match(n)&&e.viewOfSensors.push(o)}):e.viewOfSensors=_.union(e.viewOfSensors,e.operableSensors)},i.billingservice.equipments({projectid:t},function(n){S=n.result.detail,angular.forEach(S,function(e){e.isEnable=!1,e.preIsEnable=e.isEnable}),e.operableSensors=[],e.operableSensors=_.union(e.operableSensors,l),angular.forEach(S,function(n){e.operableSensors.push(n)}),angular.forEach(e.operableSensors,function(e){u.length&&angular.forEach(u,function(n){e.id==n&&(e.isEnable=!1)}),a.length&&angular.forEach(a,function(n){e.id==n&&(e.isEnable=!0)})}),e.UpdateViewOfSensors()}.bind(this),function(n){S=[],angular.forEach(S,function(e){e.isEnable=!1,e.preIsEnable=e.isEnable}),e.operableSensors=[],e.operableSensors=_.union(e.operableSensors,l),angular.forEach(S,function(n){e.operableSensors.push(n)}),angular.forEach(e.operableSensors,function(e){u.length&&angular.forEach(u,function(n){e.id==n&&(e.isEnable=!1)}),a.length&&angular.forEach(a,function(n){e.id==n&&(e.isEnable=!0)})}),e.UpdateViewOfSensors()}.bind(this))}]);