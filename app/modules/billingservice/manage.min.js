"use strict";angular.module("app").component("billingUpdate",{templateUrl:"app/modules/billingservice/manage.html?rev=c8b85993c1",controller:["$rootScope","$api","$state","UI","$uibModal","$scope","$timeout",function(e,i,n,t,o,r,s){var a=this;a.times=[],a.date=[],a.viewSensors=[],a.SelectedSensorsIDS=[],i.billingservice.info({id:n.params.id,verbose:!0},function(e){if(e=e.result,a.serviceTitle=e.title,e.rules){if(a.advanced=!0,e.rules.timequantumprice||e.rules.week||e.rules.day||(a.advanced=!1),e.rules.timequantumprice){a.timePrice=!0;var i={},n=0;angular.forEach(e.rules.timequantumprice,function(t,o){n++,i.price!==t?(angular.isUndefined(i.price)||(a.times.push(i),i={}),i.HourFrom=o,i.price=t,n===e.rules.timequantumprice.length&&(i.HourTo=o+1,a.times.push(i))):(i.HourTo=o+1,24==i.HourTo&&(i.HourTo=0),n===e.rules.timequantumprice.length&&a.times.push(i))})}else a.times=[{HourFrom:void 0,HourTo:void 0,price:void 0},{HourFrom:void 0,HourTo:void 0,price:void 0}],a.timePrice=!1,a.fixprice=e.rules.fixprice;e.rules.week&&(a.week=!0,a.selectWeeks=e.rules.week),e.rules.day?(a.day=!0,angular.forEach(e.rules.day,function(e){var i=e.split(""),n={};n.month=String(i[0])+String(i[1]),n.day=String(i[2])+String(i[3]),a.date.push(n)})):(a.week=!0,a.date=[{month:void 0,day:void 0}]),a.equipments=e.equipments,angular.forEach(a.equipments,function(e){a.viewSensors.push(e),a.SelectedSensorsIDS.push(e.id)}),s(function(){a.setSelectChecked()},100)}}),a.months=["01","02","03","04","05","06","07","08","09","10","11","12"],a.days=[];for(var c=1;c<=31;c++)if(c<10){var d="0"+String(c);a.days.push(d)}else a.days.push(String(c));a.weeks=[{index:1,title:"一"},{index:2,title:"二"},{index:3,title:"三"},{index:4,title:"四"},{index:5,title:"五"},{index:6,title:"六"},{index:7,title:"日"}],a.hours=[];for(var c=0;c<24;c++)a.hours.push(c);a.addTime=function(){a.times.push({HourFrom:void 0,HourTo:void 0,price:void 0})},a.removeTime=function(e){a.times.splice(e,1)},a.addDate=function(){a.date.push({month:void 0,day:void 0})},a.removeDate=function(e){a.date.splice(e,1)},a.SelectWeek=function(e,i){e.preventDefault(),a.selectWeeks&&a.selectWeeks.length||(a.selectWeeks=[0,0,0,0,0,0,0]),a.selectWeeks[i]?a.selectWeeks[i]=0:a.selectWeeks[i]=i+1},a.submit=function(){var o={};a.advanced&&a.day&&(o.day=[],angular.forEach(a.date,function(e){var i=String(e.month)+String(e.day);o.day.push(i)})),a.advanced&&a.week&&(o.week=a.selectWeeks),a.timePrice&&(o.timequantumprice=[void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0],angular.forEach(a.times,function(e){if(Number(e.HourFrom)<Number(e.HourTo))for(var i=Number(e.HourFrom);i<Number(e.HourTo);i++)o.timequantumprice[i]=e.price;else for(var i=0;i<24;i++)void 0===o.timequantumprice[i]&&(o.timequantumprice[i]=e.price);angular.forEach(o.timequantumprice,function(e){void 0===e&&(e=0)})})),a.timePrice||(o.fixprice=a.fixprice),r.OnSelectSensor=function(e){e.preventDefault()},i.billingservice.update({id:n.params.id,title:a.serviceTitle,projectid:e.Project.selected._id,removeChannels:!a.add&&a.DeleteIDS||void 0,addChannels:a.add&&a.SelectedSensorsIDS||void 0,rules:o},function(){t.AlertSuccess("保存成功"),n.go("admin.billingservice.info")},t.AlertError)},a.setSelectChecked=function(){var e=document.getElementsByClassName("hourFrom"),i=document.getElementsByClassName("hourTo"),n=document.getElementsByClassName("month"),t=document.getElementsByClassName("day");angular.forEach(e,function(e,i){for(var n=0;n<e.options.length;n++)if(String(e.options[n].innerHTML)==String(a.times[i].HourFrom)){e.options[n].selected=!0;break}}),angular.forEach(i,function(e,i){for(var n=0;n<e.options.length;n++)if(String(e.options[n].innerHTML)==String(a.times[i].HourTo)){e.options[n].selected=!0;break}}),angular.forEach(n,function(e,i){for(var n=0;n<e.options.length;n++)if(String(e.options[n].innerHTML)==String(a.date[i].month)){e.options[n].selected=!0;break}}),angular.forEach(t,function(e,i){for(var n=0;n<e.options.length;n++)if(String(e.options[n].innerHTML)==String(a.date[i].day)){e.options[n].selected=!0;break}})},a.OnSelectSensor=function(i){i.preventDefault(),o.open({templateUrl:"modal-channelselect.html",controller:"ChannelSelect",size:"lg",resolve:{ProjectID:function(){return e.Project.selected._id},ViewSensors:function(){return a.viewSensors},DeleteIDS:function(){return a.DeleteIDS||[]},SelectedSensors:function(){return r.SelectSensors||[]},SelectedSensorsIDS:function(){return a.SelectedSensorsIDS||[]}}}).result.then(function(e){e.add&&(a.add=!0)||(a.add=void 0),a.DeleteIDS=e.DeleteIDS,a.SelectSensors=e.SelectedSensors,a.SelectedSensorsIDS=e.SelectedSensorsIDS},function(){})}}]}),angular.module("app").controller("ChannelSelect",["$scope","$rootScope","$uibModalInstance","$api","ProjectID","SelectedSensors","SelectedSensorsIDS","ViewSensors","$state","DeleteIDS",function(e,i,n,t,o,r,s,a,c,d){var u;e.currentPage=1,e.project=o,e.popPageSize=8,e.Ok=function(){s=[],angular.forEach(r,function(i){e.add?s.push(i._id||i.id):d.push(i._id||i.id)}),n.close({DeleteIDS:d,SelectedSensors:r,SelectedSensorsIDS:s,add:e.add})},e.Cancel=function(){n.dismiss("cancel")},e.SwitchSensor=function(i,n){i.preventDefault(),r=[],n.isEnable=!n.isEnable,angular.forEach(e.viewOfSensors,function(e,i){1==e.isEnable&&r.push(e)})},e.onSearchSensor=function(i){i.preventDefault(),e.UpdateViewOfSensors(e.sensorSearchKey)},e.OnSelectAll=function(i){i.preventDefault(),angular.forEach(e.viewOfSensors,function(e){e.isEnable=!0,r.push(e)})},e.UpdateViewOfSensors=function(i,n){e.viewOfSensors=[],i?_.each(u,function(n){n.title.match(i)?e.viewOfSensors.push(n):n.addrid&&n.addrid.match(i)&&e.viewOfSensors.push(n)}):"add"===n?(e.add=!0,e.delete=void 0,t.billingservice.equipments({projectid:o},function(i){i=i.result.detail,e.viewOfSensors=i})):(e.add=void 0,e.delete=!0,e.viewOfSensors=_.union(e.viewOfSensors,a)),angular.forEach(e.viewOfSensors,function(e){angular.forEach(s,function(i){i==e._id&&(e.isEnable=!0)})})},t.sensorchannel.info({project:o},function(i){u=i.result,e.UpdateViewOfSensors()}.bind(this))}]);