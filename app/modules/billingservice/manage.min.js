"use strict";angular.module("app").component("billingUpdate",{templateUrl:"app/modules/billingservice/manage.html?rev=468891a4d5",controller:["$rootScope","$api","$state","SweetAlert","$uibModal","$scope","$timeout","$stateParams",function(e,n,o,i,r,t,s,u){var c=this;c.times=[],c.date=[],c.viewSensors=[],c.SelectedSensorsIDS=[],n.billingservice.info({id:o.params.id,verbose:!0},function(e){if(e=e.result,c.serviceTitle=e.title,e.rules){if(c.advanced=!0,e.rules.timequantumprice||e.rules.week||e.rules.day||(c.advanced=!1),e.rules.timequantumprice){var n={},o=0;angular.forEach(e.rules.timequantumprice,function(i,r){o++,n.price!==i?(angular.isUndefined(n.price)||(n.HourTo||(n.HourTo=n.HourFrom+1),c.times.push(n),n={}),n.HourFrom=r,n.price=i,o===e.rules.timequantumprice.length&&(n.HourTo=r+1,24==n.HourTo&&(n.HourTo=0),c.times.push(n))):(n.HourTo=r+1,24==n.HourTo&&(n.HourTo=0),o===e.rules.timequantumprice.length&&c.times.push(n))})}else c.times=[{HourFrom:void 0,HourTo:void 0,price:void 0},{HourFrom:void 0,HourTo:void 0,price:void 0}],c.fixprice=e.rules.fixprice;c.equipments=e.equipments,s(function(){c.setSelectChecked()},100)}}),c.hours=[];for(var a=0;a<24;a++)c.hours.push(a);c.addTime=function(){c.times.push({HourFrom:void 0,HourTo:void 0,price:void 0})},c.removeTime=function(e){c.times.splice(e,1)},c.submit=function(){var r=document.getElementsByClassName("hourFrom"),t=document.getElementsByClassName("hourTo"),s={},a=!0;if(angular.forEach(r,function(e){Number(e.value)||0==e.value||(a=!1)}),angular.forEach(t,function(e){Number(e.value)||0==e.value||(a=!1)}),!a)return i.info("请选择日期"),!1;c.advanced?(s.timequantumprice=[void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0],angular.forEach(c.times,function(e){if(Number(e.HourFrom)<Number(e.HourTo))for(var n=Number(e.HourFrom);n<Number(e.HourTo);n++)s.timequantumprice[n]=e.price}),angular.forEach(s.timequantumprice,function(e,n){void 0===e&&(s.timequantumprice[n]=0)})):s.fixprice=c.fixprice,n.billingservice.update({id:u.id,title:c.serviceTitle,projectid:e.Project.selected._id,rules:s},function(){i.success("保存成功"),o.go("admin.billingservice.info")},i.error)},c.setSelectChecked=function(){var e=document.getElementsByClassName("hourFrom"),n=document.getElementsByClassName("hourTo");angular.forEach(e,function(e,n){for(var o=0;o<e.options.length;o++)if(String(e.options[o].innerHTML)==String(c.times[n].HourFrom)){e.options[o].selected=!0;break}}),angular.forEach(n,function(e,n){for(var o=0;o<e.options.length;o++)if(String(e.options[o].innerHTML)==String(c.times[n].HourTo)){e.options[o].selected=!0;break}})},c.OnSelectSensor=function(n){n.preventDefault(),r.open({templateUrl:"modal-channelselectUpdate.html",controller:"ChannelSelectUpdate",size:"lg",resolve:{ProjectID:function(){return e.Project.selected._id},DeleteIDS:function(){return c.DeleteIDS||[]},DeleteSensors:function(){return c.DeleteSensors||[]},SelectedSensors:function(){return c.SelectSensors||[]},SelectedSensorsIDS:function(){return c.SelectedSensorsIDS||[]}}})}}]}),angular.module("app").controller("ChannelSelectUpdate",["$scope","$rootScope","$uibModal","$uibModalInstance","$api","ProjectID","SelectedSensors","SelectedSensorsIDS","DeleteIDS","DeleteSensors","$stateParams","$state","SweetAlert",function(e,n,o,i,r,t,s,u,c,a,l,d,m){var f;e.currentPage=1,e.project=t,e.popPageSize=8,e.UpdateAffirm=function(){o.open({templateUrl:"UpdateAffirm.html",size:"md",resolve:{DeleteIDS:function(){return c||[]},SelectedSensorsIDS:function(){return u||[]},removeSensor:function(){return a||[]},addSensor:function(){return s||[]}},controller:["DeleteIDS","SelectedSensorsIDS","$scope","$uibModalInstance","removeSensor","addSensor",function(e,o,i,t,s,u){i.addSensor=u,i.removeSensor=s,i.DeleteIDS=e,i.SelectedSensorsIDS=o,i.Ok=function(){t.dismiss("cancel"),r.billingservice.update({id:l.id,projectid:n.Project.selected._id,removeChannels:e||void 0,addChannels:o||void 0},function(){m.success("修改计费仪表成功"),d.go("admin.billingservice.manage",{id:l.id},{reload:!0})},m.error)},i.Cancel=function(){t.dismiss("cancel")}}]}).result.then(function(e){},function(){})},e.Ok=function(){angular.forEach(f,function(e){e.preEnable!=e.isEnable&&(e.isEnable?(s.push(e),u.push(e.id)):(c.push(e.id),a.push(e)))}),(c.length||u.length)&&e.UpdateAffirm(),i.dismiss("cancel")},e.Cancel=function(){i.dismiss("cancel")},e.SwitchSensor=function(e,n){e.preventDefault(),n.isEnable=!n.isEnable},e.onSearchSensor=function(n){n.preventDefault(),e.UpdateViewOfSensors(e.sensorSearchKey)},e.OnSelectAll=function(n){n.preventDefault(),angular.forEach(e.viewOfSensors,function(e){e.isEnable=!0})},e.UpdateViewOfSensors=function(n){e.viewOfSensors=[],n?angular.forEach(f,function(o){o.title.match(n)||o.addrid.match(n)?e.viewOfSensors.push(o):o.channel&&o.channel.match(n)?e.viewOfSensors.push(o):o.channelname&&o.channelname.match(n)&&e.viewOfSensors.push(o)}):e.viewOfSensors=_.union(e.viewOfSensors,f)},e.$watch("devicetype.selected",function(n){e.viewOfSensors=[],angular.forEach(f,function(o){o.devicetype.match(n.id)&&e.viewOfSensors.push(o)})}),r.billingservice.equipments({project:t,strategyid:l.id,SHOWALL:!0},function(n){f=n.result,angular.forEach(f,function(e){e.isEnable=e.selected,e.preEnable=e.selected}),e.UpdateViewOfSensors()}.bind(this)),r.device.type({project:t},function(n){e.devicetype=n.result})}]);