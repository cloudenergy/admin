"use strict";angular.module("app").controller("EnergyIndex",["$rootScope","$scope","$q","$uibModal","$api","SweetAlert","base64",function(o,i,e,n,l,c,t){var d={},a={};function r(e){return t.encode(e)}function u(e){var n=e.split("|");return _.isArray(n)&&n[0]||e}function g(){d={},a={},e.all([l.energy.info({project:o.Project.selected._id},function(e){i.energyData=angular.isObject(e.result)&&e.result.energy},function(e){delete i.energyData,c.error(e)}).$promise,l.energycategory.info(function(e){i.energycategory=e.result},function(){delete i.energycategory}).$promise]).then(function(){angular.isObject(i.energyData)&&(angular.forEach(i.energycategory,function(e){i.energyData[e._id]||(i.energyData[e._id]={id:e._id,childrens:[],ischild:!1});var n=i.energyData[e._id];n.unit=e.unit,n.standcol=e.standcol,n.title=e.title}),i.energycategory&&i.energycategory.sort(function(e,n){return e.title>n.title?1:-1}),i.viewOfEnergy=[{nodes:function n(t,e,i){if(e){var r=[];return _.each(e,function(e){e.childrens?e.ischild=!1:e.ischild=!0,e.originid=e.id,e.origintitle=e.title,e.parent=t,e.level=i,e.nodes=n(e,e.childrens,i+1),r.push(e)}),r.sort(function(e,n){return e.title>n.title?1:-1}),r}}(null,i.energyData,1),title:"能耗分类",level:0}])},function(){i.viewOfEnergy=[{nodes:[],title:"能耗分类",level:0}]})}i.doSaveEnergy=function(e){e.preventDefault();var r=function(e,n){var i={};return _.each(n,function(e){var n={id:e.id,title:e.title};e.originid&&e.originid!=e.id&&(a[e.originid]=e.id);var t=r(n,e.nodes);_.isEmpty(t)||(n.childrens=t),i[n.id]=n}),i},n=r(null,i.viewOfEnergy[0].nodes),t={};_.each(n,function(e){e.childrens&&(t[e.id]=e)}),n=t,l.energy.update({energy:n,_id:o.Project.selected._id},function(){_.each(d,function(e){var n={query:{energyPath:e.id},queryoperate:{set:{energy:"",energyPath:""}}};l.sensorchannel.update(n)}),_.map(a,function(e,n){var t={energy:u(n),energyPath:n,project:o.Project.selected._id},i={set:{energy:u(e),energyPath:e}};l.sensorchannel.update({query:t,queryoperate:i})}),g(),c.success("保存成功")},c.error)},g(),i.deleteNode=function(e,n){var t=function(n){n&&(_.each(n.nodes,function(e){t(e),n.originid&&(d[e.originid]=e)}),n.originid&&(d[n.originid]=n))};t(n),e.remove()},i.enable=function(e){e.enable=!e.enable},i.toggle=function(e){e.toggle()},i.newSubItem=function(e,n){var t=e.node;t.nodes||(t.nodes=[]),t.nodes.push({id:"",enable:!0,editing:!0,title:"",origintitle:"",level:t.level+1,parent:n,nodes:[]})},i.edit=function(e){e.editing=!0},i.cancelEditing=function(e,n){n.title.length||n.origintitle.length?(n.editing=!1,n.title=n.origintitle):i.deleteNode(e,n)},i.save=function(n){if(!n.title.length)return c.info("请输入分类名称"),!1;if(n.parent&&_.find(n.parent.nodes,function(e){if(e.id&&e.id.length&&!e.editing)return e.title==n.title&&(c.info("已有相同名称，请确认"),!0)}))return!1;n.editing=!1,n.originid||(n.origintitle=n.title),function n(e){e.id=function(e,n){return e&&e.id&&e.id.length?e.id+"|"+r(n):r(n)}(e.parent,e.title),d[e.id]&&(d[e.id]=null),_.each(e.nodes,function(e){n(e)})}(n)},i.sensor=function(e){n.open({templateUrl:"sensorSelect.html",controller:"SensorSelect",size:"lg",resolve:{ProjectID:function(){return o.Project.selected._id},EnergycategoryID:function(){return e.id}}}).result.then(function(e){},function(){})},i.switchUnitPriceType=function(e){e.unitprice.isnormal=!e.unitprice.isnormal}}]);