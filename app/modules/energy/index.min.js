"use strict";angular.module("app").controller("EnergyIndex",["$rootScope","$scope","$q","$uibModal","$api","UI","base64",function(e,n,t,i,r,o,l){function c(e){return l.encode(e)}function a(e,n){return e&&e.id&&e.id.length?e.id+"|"+c(n):c(n)}function d(e){var n=e.split("|");return _.isArray(n)?n[0]||e:e}function u(e,n,t){if(n){var i=[];return _.each(n,function(n){n.childrens?n.ischild=!1:n.ischild=!0,n.originid=n.id,n.origintitle=n.title,n.parent=e,n.level=t,n.nodes=u(n,n.childrens,t+1),i.push(n)}),i.sort(function(e,n){return e.title>n.title?1:-1}),i}}function g(){s={},f={},t.all([r.energy.info({project:e.Project.selected._id},function(e){n.energyData=angular.isObject(e.result)&&e.result.energy},o.AlertError).$promise,r.energycategory.info(function(e){n.energycategory=e.result}).$promise]).then(function(){angular.isObject(n.energyData)&&(angular.forEach(n.energycategory,function(e){n.energyData[e._id]||(n.energyData[e._id]={id:e._id,childrens:[],ischild:!1});var t=n.energyData[e._id];t.unit=e.unit,t.standcol=e.standcol,t.title=e.title}),n.energycategory&&n.energycategory.sort(function(e,n){return e.title>n.title?1:-1}),n.viewOfEnergy=[{nodes:u(null,n.energyData,1),title:"能耗分类",level:0}])})}var s={},f={};n.doSaveEnergy=function(t){t.preventDefault();var i=function(e,n){var t={};return _.each(n,function(e){var n={id:e.id,title:e.title};e.originid&&e.originid!=e.id&&(f[e.originid]=e.id);var r=i(n,e.nodes);_.isEmpty(r)||(n.childrens=r),t[n.id]=n}),t},l=i(null,n.viewOfEnergy[0].nodes),c={};_.each(l,function(e){e.childrens&&(c[e.id]=e)}),l=c,r.energy.update({energy:l,_id:e.Project.selected._id},function(){_.each(s,function(e){var n={query:{energyPath:e.id},queryoperate:{set:{energy:"",energyPath:""}}};r.sensorchannel.update(n)}),_.map(f,function(n,t){var i={energy:d(t),energyPath:t,project:e.Project.selected._id},o={set:{energy:d(n),energyPath:n}};r.sensorchannel.update({query:i,queryoperate:o})}),g(),o.AlertSuccess("保存成功")},o.AlertError)},n.$watch("$root.Project.selected",g),n.deleteNode=function(e,n){var t=function(e){e&&(_.each(e.nodes,function(n){t(n),e.originid&&(s[n.originid]=n)}),e.originid&&(s[e.originid]=e))};t(n),e.remove()},n.enable=function(e){e.enable=!e.enable},n.toggle=function(e){e.toggle()},n.newSubItem=function(e,n){var t=e.node;t.nodes||(t.nodes=[]),t.nodes.push({id:"",enable:!0,editing:!0,title:"",origintitle:"",level:t.level+1,parent:n,nodes:[]})},n.edit=function(e){e.editing=!0},n.cancelEditing=function(e,t){t.title.length||t.origintitle.length?(t.editing=!1,t.title=t.origintitle):n.deleteNode(e,t)},n.save=function(e){if(!e.title.length)return o.AlertWarning("请输入分类名称"),!1;if(e.parent){var n=_.find(e.parent.nodes,function(n){if(n.id&&n.id.length&&!n.editing)return n.title==e.title&&(o.AlertWarning("已有相同名称，请确认"),!0)});if(n)return!1}e.editing=!1,e.originid||(e.origintitle=e.title),function e(n){n.id=a(n.parent,n.title),s[n.id]&&(s[n.id]=null),_.each(n.nodes,function(n){e(n)})}(e)},n.sensor=function(n){var t=i.open({templateUrl:"sensorSelect.html",controller:"SensorSelect",size:"lg",resolve:{ProjectID:function(){return e.Project.selected._id},EnergycategoryID:function(){return n.id}}});t.result.then(function(e){},function(){})},n.switchUnitPriceType=function(e){e.unitprice.isnormal=!e.unitprice.isnormal}}]);