"use strict";angular.module("app").controller("Finance.record.in",["$rootScope","$scope","$filter","$templateCache","$timeout","$api","$q","$state","$stateParams","uiGridConstants",function(e,t,n,i,a,r,o,d,c,l){var s=this;new Date;s.projectid=c.projectid,s.paneHeight=90.01,s.searchText="",s.startDate=moment(new Date).subtract(30,"days").format("YYYY-MM-DD"),s.endDate=moment(new Date).format("YYYY-MM-DD"),$("#start_date").bind("dp.change",function(e){a(function(){e.date&&e.oldDate&&s.list()})}),$("#end_date").bind("dp.change",function(e){a(function(){e.date&&e.oldDate&&s.list()})}),s.filter=function(){s.gridOptions.enableFiltering=!s.gridOptions.enableFiltering,s.gridApi.core.notifyDataChange(l.dataChange.COLUMN)},s.export=function(){s.gridOptions.exporterCsvFilename="平台财务_收入_"+(s.projectname?s.projectname+"_":"")+s.startDate.replace(/\-/g,"")+"_"+s.endDate.replace(/\-/g,"")+".csv",s.gridApi.exporter.csvExport("visible","visible",angular.element(document.querySelectorAll(".subContent")))},s.projectid&&(d.$current.data.title=s.projectname=e.Project[s.projectid].title,r.business.accountbalance({project:s.projectid},function(e){s.accountbalance=e.result,s.accountbalance.total=n("number")(s.accountbalance.cash+s.accountbalance.frozen,2).replace(/\,/g,""),s.accountbalance.cash=n("number")(s.accountbalance.cash,2).replace(/\,/g,""),s.accountbalance.frozen=n("number")(s.accountbalance.frozen,2).replace(/\,/g,"")})),s.placeholder=s.projectid&&"商户名称"||"项目名称",s.list=function(e){if(!(e&&s.gridOptions.paging&&s.gridOptions.paging.count<=s.gridOptions.paging.pageindex*s.gridOptions.paging.pagesize))return r.business.pltfundflow({projectid:s.projectid||void 0,key:s.searchText||void 0,from:s.startDate.replace(/\-/g,""),to:s.endDate.replace(/\-/g,""),flow:"EARNING",pageindex:(e&&s.gridOptions.paging?s.gridOptions.paging.pageindex:0)+1,pagesize:100},function(t){return t=t.result,angular.forEach(t.detail,function(e){e.timepaid=e.timepaid&&n("date")(1e3*e.timepaid,"yyyy-M-dd H:mm:ss")||""}),e?s.gridOptions.data=s.gridOptions.data.concat(t.detail||[]):(s.gridOptions.data=t.detail||[],s.gridOptions.data.length&&a(function(){s.gridApi.core.scrollTo(s.gridOptions.data[0],s.gridOptions.columnDefs[0])})),s.gridOptions.paging=t.paging,a(function(){s.paneHeight=90}),s.gridApi.grid.element.height("auto"),t}).$promise},s.list(),s.gridRowChanged=function(){s.sum={amount:0,balance:0},angular.forEach(s.gridApi.core.getVisibleRows(s.gridApi.grid),function(e){"SUCCESS"===e.entity.status&&(s.sum.amount=parseFloat(n("number")(s.sum.amount+e.entity.amount,2).replace(/\,/g,"")),s.sum.balance=parseFloat(n("number")(s.sum.balance+e.entity.balance,2).replace(/\,/g,"")))})},s.gridOptions={onRegisterApi:function(e){e.core.on.rowsRendered(t,s.gridRowChanged),e.infiniteScroll.on.needLoadMoreData(t,function(){var t=o.defer(),n=t.resolve,i=function(){e.infiniteScroll.dataLoaded(),t.reject()};return function(t){t?t.then(function(){e.infiniteScroll.saveScrollPercentage(),e.infiniteScroll.dataLoaded(!1,!0).then(n,i)},i):i()}(s.list(!0)),t.promise}),s.gridApi=e},infiniteScrollDown:!0,enableColumnResizing:!0,exporterOlderExcelCompatibility:!0,exporterFieldCallback:function(e,t,n,i){return 0===i?0:'="'+(i||"")+'"'},columnDefs:[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">序号</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"项目名称",name:"projectname",width:"*",minWidth:120,visible:!s.projectid,enableColumnMenu:!1,cellTemplate:'<div class="ui-grid-cell-contents text-primary"><a ui-sref="admin.finance.record.in.project({projectid:row.entity.project})" ng-bind="COL_FIELD"></a></div>'},{displayName:"充值商户",name:"from",width:"*",minWidth:120,enableColumnMenu:!1},{displayName:"充值金额 ¥",name:"amount",width:"*",minWidth:120,headerCellTemplate:function(){return i.get("ui-grid/uiGridHeaderCell").replace('</sub></span></div><div role="button" tabindex="0"','</sub></span><div class="text-info">合计：{{grid.appScope.self.sum.amount}}</div></div><div role="button" tabindex="0"')}},{displayName:"充值后余额 ¥",name:"balance",width:"*",minWidth:120,enableColumnMenu:!1},{displayName:"到账时间",name:"timepaid",width:"*",minWidth:130}]}}]);