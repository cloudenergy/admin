"use strict";angular.module("app").controller("Finance.record.in",["$rootScope","$scope","$filter","$templateCache","$timeout","$api","$q","$state","$stateParams","uiGridConstants",function(e,t,n,i,a,r,o,d,l,c){var p=this,s=new Date;p.projectid=l.projectid,p.paneHeight=90.01,p.searchText="",p.startDate=n("date")(s,"yyyy-MM-01"),p.endDate=n("date")(s,"yyyy-MM-dd"),$("#start_date").bind("dp.change",function(e){a(function(){e.date&&e.oldDate&&p.list()})}),$("#end_date").bind("dp.change",function(e){a(function(){e.date&&e.oldDate&&p.list()})}),p.filter=function(){p.gridOptions.enableFiltering=!p.gridOptions.enableFiltering,p.gridApi.core.notifyDataChange(c.dataChange.COLUMN)},p.export=function(){p.gridOptions.exporterCsvFilename="平台财务_收入_"+(p.projectname?p.projectname+"_":"")+p.startDate.replace(/\-/g,"")+"_"+p.endDate.replace(/\-/g,"")+".csv",p.gridApi.exporter.csvExport("visible","visible",angular.element(document.querySelectorAll(".subContent")))},p.projectid&&(d.$current.data.title=p.projectname=e.Project[p.projectid].title,r.business.accountbalance({project:p.projectid},function(e){p.accountbalance=e.result,p.accountbalance.total=n("number")(p.accountbalance.cash+p.accountbalance.frozen,2).replace(/\,/g,""),p.accountbalance.cash=n("number")(p.accountbalance.cash,2).replace(/\,/g,""),p.accountbalance.frozen=n("number")(p.accountbalance.frozen,2).replace(/\,/g,"")})),p.placeholder=p.projectid&&"商户名称"||"项目名称",p.list=function(e){if(!(e&&p.gridOptions.paging&&p.gridOptions.paging.count<=p.gridOptions.paging.pageindex*p.gridOptions.paging.pagesize))return r.business.pltfundflow({projectid:p.projectid||void 0,key:p.searchText||void 0,from:p.startDate.replace(/\-/g,""),to:p.endDate.replace(/\-/g,""),flow:"EARNING",pageindex:(e&&p.gridOptions.paging?p.gridOptions.paging.pageindex:0)+1,pagesize:100},function(t){return t=t.result,angular.forEach(t.detail,function(e){e.timepaid=e.timepaid&&n("date")(1e3*e.timepaid,"yyyy-M-dd H:mm:ss")||""}),e?p.gridOptions.data=p.gridOptions.data.concat(t.detail||[]):(p.gridOptions.data=t.detail||[],p.gridOptions.data.length&&a(function(){p.gridApi.core.scrollTo(p.gridOptions.data[0],p.gridOptions.columnDefs[0])})),p.gridOptions.paging=t.paging,a(function(){p.paneHeight=90}),p.gridApi.grid.element.height("auto"),t}).$promise},p.list(),p.gridRowChanged=function(){p.sum={amount:0,balance:0},angular.forEach(p.gridApi.core.getVisibleRows(p.gridApi.grid),function(e){"SUCCESS"===e.entity.status&&(p.sum.amount=parseFloat(n("number")(p.sum.amount+e.entity.amount,2).replace(/\,/g,"")),p.sum.balance=parseFloat(n("number")(p.sum.balance+e.entity.balance,2).replace(/\,/g,"")))})},p.gridOptions={onRegisterApi:function(e){e.core.on.rowsRendered(t,p.gridRowChanged),e.infiniteScroll.on.needLoadMoreData(t,function(){var t=o.defer(),n=t.resolve,i=function(){e.infiniteScroll.dataLoaded(),t.reject()};return function(t){t?t.then(function(){e.infiniteScroll.saveScrollPercentage(),e.infiniteScroll.dataLoaded(!1,!0).then(n,i)},i):i()}(p.list(!0)),t.promise}),p.gridApi=e},infiniteScrollDown:!0,enableColumnResizing:!0,exporterOlderExcelCompatibility:!0,exporterFieldCallback:function(e,t,n,i){return 0===i?0:'="'+(i||"")+'"'},columnDefs:[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">序号</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"项目名称",name:"projectname",width:"*",minWidth:120,visible:!p.projectid,enableColumnMenu:!1,cellTemplate:'<div class="ui-grid-cell-contents text-primary"><a ui-sref="admin.finance.record.in.project({projectid:row.entity.project})" ng-bind="COL_FIELD"></a></div>'},{displayName:"充值商户",name:"from",width:"*",minWidth:120,enableColumnMenu:!1},{displayName:"充值金额 ¥",name:"amount",width:"*",minWidth:120,headerCellTemplate:function(){return i.get("ui-grid/uiGridHeaderCell").replace('</sub></span></div><div role="button" tabindex="0"','</sub></span><div class="text-info">合计：{{grid.appScope.self.sum.amount}}</div></div><div role="button" tabindex="0"')}},{displayName:"充值后余额 ¥",name:"balance",width:"*",minWidth:120,enableColumnMenu:!1},{displayName:"到账时间",name:"timepaid",width:"*",minWidth:130}]}}]);