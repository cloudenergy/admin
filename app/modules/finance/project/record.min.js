"use strict";angular.module("app").controller("Finance.project.record",["$rootScope","$scope","$api","$filter","$state","$stateParams","$timeout","$q","uiGridConstants",function(e,t,i,a,n,l,s,d,r){var o=this;new Date;o.tab=l.tab||"all",o.projectid=l.projectid,o.searchText="",o.startDate=moment().subtract(30,"days").format("YYYY-MM-DD"),o.endDate=moment().format("YYYY-MM-DD"),$("#start_date").bind("dp.change",function(e){s(function(){e.date&&e.oldDate&&o.list()})}),$("#end_date").bind("dp.change",function(e){s(function(){e.date&&e.oldDate&&o.list()})}),o.status=[{key:"CHECKING",title:"等待审核",class:"primary"},{key:"CHECKFAILED",title:"审核失败",class:"warning"},{key:"PROCESSING",title:"正在处理",class:"info"},{key:"FAILED",title:"处理失败",class:"danger"},{key:"SUCCESS",title:"成功",class:"success"}],angular.forEach(o.status,function(e){this[e.key]={title:e.title,class:e.class}},o.status),o.projectname=n.$current.parent.data.title=e.Project[o.projectid].title,o.filter=function(){o.gridOptions.enableFiltering=!o.gridOptions.enableFiltering,o.gridApi.core.notifyDataChange(r.dataChange.COLUMN)},o.export=function(){o.gridOptions.exporterCsvFilename=(o.projectname?o.projectname+"_":"")+{all:"收支明细",in:"收入",out:"提现"}[o.tab]+"_"+o.startDate.replace(/\-/g,"")+"_"+o.endDate.replace(/\-/g,"")+".csv",o.gridApi.exporter.csvExport("visible","visible",angular.element(document.querySelectorAll(".subContent")))},o.list=function(e){if(!(e&&o.gridOptions.paging&&o.gridOptions.paging.count<=o.gridOptions.paging.pageindex*o.gridOptions.paging.pagesize)){var t={project:o.projectid||void 0,key:o.searchText||void 0,from:o.startDate.replace(/\-/g,""),to:o.endDate.replace(/\-/g,""),pageindex:(e&&o.gridOptions.paging?o.gridOptions.paging.pageindex:0)+1,pagesize:100};return"in"==o.tab&&(t.flow="EARNING",o.gridOptions.columnDefs=p),"all"==o.tab&&(o.gridOptions.columnDefs=p),"out"==o.tab&&(t.flow="EXPENSE",o.gridOptions.columnDefs=c),o.status.selected&&(t.status=o.status.selected),i.business.fundflow(t,function(t){return t=t.result,angular.forEach(t.detail,function(e){e.timecreate=e.timecreate&&a("date")(1e3*e.timecreate,"yyyy-M-dd H:mm:ss")||"",e.timepaid=e.timepaid&&a("date")(1e3*e.timepaid,"yyyy-M-dd H:mm:ss")||""}),e?o.gridOptions.data=o.gridOptions.data.concat(t.detail||[]):(o.gridOptions.data=t.detail||[],o.gridOptions.data.length&&s(function(){o.gridApi.core.scrollTo(o.gridOptions.data[0],o.gridOptions.columnDefs[0])})),o.gridOptions.paging=t.paging,s(function(){o.paneHeight=90}),o.gridApi.grid.element.height("auto"),t}).$promise}};var c=[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">序号</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"交易金额 ¥",name:"amount",width:"*",minWidth:120,cellTemplate:'<div class="ui-grid-cell-contents" ng-class="{\'text-danger\': COL_FIELD>0, \'text-success\': COL_FIELD<0}" ng-if="COL_FIELD" ng-bind="COL_FIELD"></div>'},{displayName:"交易类型",name:"category",width:"*",minWidth:100,enableColumnMenu:!1},{displayName:"交易状态",name:"status",width:"*",minWidth:100,enableColumnMenu:!1,cellTemplate:'<div class="ui-grid-cell-contents text-{{grid.appScope.self.status[COL_FIELD].class}}" ng-bind="grid.appScope.self.status[COL_FIELD].title"></div>'},{displayName:"到账时间",name:"timepaid",width:"*",minWidth:130},{displayName:"操作帐号",name:"operator",minWidth:200},{displayName:"操作后余额",name:"balance",minWidth:100},{displayName:"提交时间",name:"timecreate",width:"*",minWidth:130,enableColumnMenu:!1},{displayName:"跟踪",name:"operation",minWidth:80,cellTemplate:'<div class="ui-grid-cell-contents text-primary"><a class="text-primary" href="javascript:void(0)">查看详情</a></div>'}],p=[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">序号</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"交易金额 ¥",name:"amount",width:"*",minWidth:120,cellTemplate:'<div class="ui-grid-cell-contents" ng-class="{\'text-danger\': COL_FIELD<0, \'text-success\': COL_FIELD>0}" ng-if="COL_FIELD" ng-bind="COL_FIELD"></div>'},{displayName:"交易类型",name:"category",width:"*",minWidth:100,enableColumnMenu:!1},{displayName:"交易状态",name:"status",width:"*",minWidth:100,enableColumnMenu:!1,cellTemplate:'<div class="ui-grid-cell-contents text-{{grid.appScope.self.status[COL_FIELD].class}}" ng-bind="grid.appScope.self.status[COL_FIELD].title"></div>'},{displayName:"操作后余额",name:"balance",minWidth:100},{displayName:"提交时间",name:"timecreate",width:"*",minWidth:130,enableColumnMenu:!1}];o.gridOptions={onRegisterApi:function(e){e.infiniteScroll.on.needLoadMoreData(t,function(){var t=d.defer(),i=t.resolve,a=function(){e.infiniteScroll.dataLoaded(),t.reject()};return function(t){t?t.then(function(){e.infiniteScroll.saveScrollPercentage(),e.infiniteScroll.dataLoaded(!1,!0).then(i,a)},a):a()}(o.list(!0)),t.promise}),o.gridApi=e},infiniteScrollDown:!0,enableColumnResizing:!0,exporterOlderExcelCompatibility:!0,exporterFieldCallback:function(e,t,i,a){return/status/.test(i.field)&&(a=o.status[a]&&o.status[a].title||""),0===a?0:'="'+(a||"")+'"'},columnDefs:c},o.list()}]);