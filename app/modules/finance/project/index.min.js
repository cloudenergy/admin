"use strict";angular.module("app").controller("Finance.project.index",["$rootScope","$filter","$api","$state","$stateParams","$uibModal","EFUNDFLOW","SweetAlert","$timeout","$scope",function(e,t,a,n,i,l,r,o,c,d){var u=this;u.projectid=i.projectid,u.efundflow=r,a.pltfinance.billinginfo({projectid:u.projectid},function(e){e=e.result,u.epayment=e.epayment,u.payment=e.payment,u.prepayment=e.prepayment,u.thirdpartbill=e.thirdpartbill,u.efundflow.selected=e.efundflow||"PLT",u.withdraw=e.withdraw,u.EWP=e.EWP,u.ZFT=e.ZFT,u.alipay=e.alipay,u.wx=e.wx,u.wx_pub=e.wx_pub}),u.reload=function(){n.go("admin.finance.project.info",{},{reload:!0})},u.save=function(e,t){o.swal({title:"确认修改此项属性？",type:"info",showCancelButton:!0,cancelButtonText:"取消",confirmButtonText:"确认"}).then(function(){var n={projectid:u.projectid,payment:u.payment,prepayment:u.prepayment,thirdpartbill:u.thirdpartbill,epayment:u.epayment};if("efundflow"!=e){if("PRJ"==u.efundflow.selected&&u.alipay&&u.alipay.enable&&u.alipay.share){if(Number(u.alipay.share.PRJ)+Number(u.alipay.share.USR)!=100)return void o.info("支付宝双方费率承担之和必须为100")}else if("PRJ"==u.efundflow.selected&&u.alipay&&u.alipay.enable)return void o.info("请填写支付宝费率承担");if("PRJ"==u.efundflow.selected&&u.wx&&u.wx.enable&&u.wx.share){if(Number(u.wx.share.PRJ)+Number(u.wx.share.USR)!=100)return void o.info("微信双方费率承担之和必须为100")}else if("PRJ"==u.efundflow.selected&&u.wx&&u.wx.enable)return void o.info("请填写微信费率承担");if("PRJ"==u.efundflow.selected&&u.wx_pub&&u.wx_pub.enable&&u.wx_pub.share){if(Number(u.wx_pub.share.PRJ)+Number(u.wx_pub.share.USR)!=100)return void o.info("微信公众号双方费率承担之和必须为100")}else if("PRJ"==u.efundflow.selected&&u.wx_pub&&u.wx_pub.enable)return void o.info("请填写微信公众号费率承担");if("PRJ"==u.efundflow.selected&&u.ZFT&&u.ZFT.enable&&u.ZFT.wx&&u.ZFT.wx.enable&&u.ZFT.wx.share){if(Number(u.ZFT.wx.share.PRJ)+Number(u.ZFT.wx.share.USR)!=100)return void o.info("租付通APP微信支付双方费率承担之和必须为100")}else if("PRJ"==u.efundflow.selected&&u.ZFT&&u.ZFT.enable&&u.ZFT.wx&&u.ZFT.wx.enable)return void o.info("请填写租付通APP微信支付费率承担");if("PRJ"==u.efundflow.selected&&u.EWP&&u.EWP.enable&&u.EWP.wx_pub&&u.EWP.wx_pub.enable&&u.EWP.wx_pub.share){if(Number(u.EWP.wx_pub.share.PRJ)+Number(u.EWP.wx_pub.share.USR)!=100)return void o.info("公众号微信支付双方费率承担之和必须为100")}else if("PRJ"==u.efundflow.selected&&u.EWP&&u.EWP.enable&&u.EWP.wx_pub&&u.EWP.wx_pub.enable)return void o.info("请填写公众号微信支付费率承担");if("PRJ"==u.efundflow.selected&&u.ZFT&&u.ZFT.enable&&u.ZFT.alipay&&u.ZFT.alipay.enable&&u.ZFT.alipay.share){if(Number(u.ZFT.alipay.share.PRJ)+Number(u.ZFT.alipay.share.USR)!=100)return void o.info("支付宝支付双方费率承担之和必须为100")}else if("PRJ"==u.efundflow.selected&&u.ZFT&&u.ZFT.enable&&u.ZFT.alipay&&u.ZFT.alipay.enable)return void o.info("请填写支付宝支付费率承担")}"ZFT.wx"==e?(n.ZFT={},n.ZFT.enable=u.ZFT.enable,n.ZFT.wx=t.wx):"ZFT.alipay"==e?(n.ZFT={},n.ZFT.enable=u.ZFT.enable,n.ZFT.alipay=t.alipay):n[e]=t,a.pltfinance.billingupdate(n,function(){},function(e){o.warning(e.message).then(function(){u.reload()})})},function(){u.reload()})},u.getCardList=function(){a.channelaccount.info({project:u.projectid,all:!0,flow:"EXPENSE"},function(e){u.cardData=e.result})},u.getCard=function(e){a.bank.info(function(t){l.open({templateUrl:"modal-finance-project-card.html",controllerAs:"self",controller:["$api","$uibModalInstance",function(a,n){this.bankData=t.result,this.card=e||{},this.card.locate=angular.isString(this.card.locate)&&JSON.parse(this.card.locate||null)||this.card.locate||{province:"浙江省",city:"杭州市",district:"西湖区"},console.log(this.card),angular.forEach(this.bankData,$.proxy(function(e){this.bankData[e.id]=e,this.card.origin===e.title&&(this.card.origin=e.id)},this)),this.submit=function(){a.channelaccount.add({id:this.card.id||void 0,flow:this.card.flow||"EXPENSE",belongto:this.card.belongto?void 0:u.projectid,name:this.card.name,account:this.card.account,origin:this.bankData[this.card.origin].title,subbranch:this.card.subbranch,locate:this.card.locate},n.close,u.reload)},this.cancel=function(){n.dismiss("cancel")}}]}).result.then(u.getCardList)})},u.removeCard=function(e){swal({title:"确认删除此项吗？",text:"卡号："+e.account,type:"warning",showCancelButton:!0,cancelButtonText:"取消",confirmButtonText:"确认",confirmButtonColor:"#ec6c62"}).then(function(){a.channelaccount.delete({id:e.id},u.getCardList)})},u.project=e.Project[u.projectid],n.$current.data.title=u.project.title,u.getCardList()}]);