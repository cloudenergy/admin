"use strict";angular.module("app").controller("Finance.project.index",["$rootScope","$filter","$api","$state","$stateParams","$uibModal","EFUNDFLOW","SweetAlert","$timeout","$scope",function(e,n,t,a,i,r,l,o,c,u){var d=this;d.projectid=i.projectid,d.efundflow=l,t.pltfinance.billinginfo({projectid:d.projectid},function(e){e=e.result,d.epayment=e.epayment,d.payment=e.payment,d.prepayment=e.prepayment,d.thirdpartbill=e.thirdpartbill,d.efundflow.selected=e.efundflow||"PLT",d.withdraw=e.withdraw,d.EWP=e.EWP,d.ZFT=e.ZFT,d.alipay=e.alipay,d.wx=e.wx,d.wx_pub=e.wx_pub}),d.reload=function(e){a.go("admin.finance.project.info",{type:e},{reload:!0})},d.save=function(e,n){o.swal({title:"确认修改此项属性？",type:"info",showCancelButton:!0,cancelButtonText:"取消",confirmButtonText:"确认"}).then(function(){var a={projectid:d.projectid,payment:d.payment,prepayment:d.prepayment,thirdpartbill:d.thirdpartbill,epayment:d.epayment};if("efundflow"!=e){if("PRJ"==d.efundflow.selected&&d.alipay&&d.alipay.enable&&d.alipay.share){if(Number(d.alipay.share.PRJ)+Number(d.alipay.share.USR)!=100)return void o.info("支付宝双方费率承担之和必须为100")}else if("PRJ"==d.efundflow.selected&&d.alipay&&d.alipay.enable)return void o.info("请填写支付宝费率承担");if("PRJ"==d.efundflow.selected&&d.wx&&d.wx.enable&&d.wx.share){if(Number(d.wx.share.PRJ)+Number(d.wx.share.USR)!=100)return void o.info("微信双方费率承担之和必须为100")}else if("PRJ"==d.efundflow.selected&&d.wx&&d.wx.enable)return void o.info("请填写微信费率承担");if("PRJ"==d.efundflow.selected&&d.wx_pub&&d.wx_pub.enable&&d.wx_pub.share){if(Number(d.wx_pub.share.PRJ)+Number(d.wx_pub.share.USR)!=100)return void o.info("微信公众号双方费率承担之和必须为100")}else if("PRJ"==d.efundflow.selected&&d.wx_pub&&d.wx_pub.enable)return void o.info("请填写微信公众号费率承担");if("PRJ"==d.efundflow.selected&&d.ZFT&&d.ZFT.enable&&d.ZFT.wx&&d.ZFT.wx.enable&&d.ZFT.wx.share){if(Number(d.ZFT.wx.share.PRJ)+Number(d.ZFT.wx.share.USR)!=100)return void o.info("租付通APP微信支付双方费率承担之和必须为100")}else if("PRJ"==d.efundflow.selected&&d.ZFT&&d.ZFT.enable&&d.ZFT.wx&&d.ZFT.wx.enable)return void o.info("请填写租付通APP微信支付费率承担");if("PRJ"==d.efundflow.selected&&d.EWP&&d.EWP.enable&&d.EWP.wx_pub&&d.EWP.wx_pub.enable&&d.EWP.wx_pub.share){if(Number(d.EWP.wx_pub.share.PRJ)+Number(d.EWP.wx_pub.share.USR)!=100)return void o.info("公众号微信支付双方费率承担之和必须为100")}else if("PRJ"==d.efundflow.selected&&d.EWP&&d.EWP.enable&&d.EWP.wx_pub&&d.EWP.wx_pub.enable)return void o.info("请填写公众号微信支付费率承担");if("PRJ"==d.efundflow.selected&&d.ZFT&&d.ZFT.enable&&d.ZFT.alipay&&d.ZFT.alipay.enable&&d.ZFT.alipay.share){if(Number(d.ZFT.alipay.share.PRJ)+Number(d.ZFT.alipay.share.USR)!=100)return void o.info("支付宝支付双方费率承担之和必须为100")}else if("PRJ"==d.efundflow.selected&&d.ZFT&&d.ZFT.enable&&d.ZFT.alipay&&d.ZFT.alipay.enable)return void o.info("请填写支付宝支付费率承担")}"ZFT.wx"==e?(a.ZFT={},a.ZFT.enable=d.ZFT.enable,a.ZFT.wx=n.wx):"ZFT.alipay"==e?(a.ZFT={},a.ZFT.enable=d.ZFT.enable,a.ZFT.alipay=n.alipay):a[e]=n,t.pltfinance.billingupdate(a,function(){d.reminder("Success")},function(){d.reload("Warning")})},function(){d.reload("Warning")})},d.reminder=function(e){var n="request"+e;d[n]=!0;var t=c(function(){d[n]=!1,t.cancel()},3e3)},i.type&&d.reminder(i.type),d.getCardList=function(){t.channelaccount.info({project:d.projectid,all:!0,flow:"EXPENSE"},function(e){d.cardData=e.result})},d.getCard=function(e){t.bank.info(function(n){r.open({templateUrl:"modal-finance-project-card.html",controllerAs:"self",controller:["$api","$uibModalInstance",function(t,a){this.bankData=n.result,this.card=e||{},this.card.locate=angular.isString(this.card.locate)&&JSON.parse(this.card.locate||null)||this.card.locate||{province:"浙江省",city:"杭州市",district:"西湖区"},angular.forEach(this.bankData,$.proxy(function(e){this.bankData[e.id]=e,this.card.origin===e.title&&(this.card.origin=e.id)},this)),this.submit=function(){t.channelaccount.add({id:this.card.id||void 0,flow:this.card.flow||"EXPENSE",belongto:this.card.belongto?void 0:d.projectid,name:this.card.name,account:this.card.account,origin:this.bankData[this.card.origin].title,subbranch:this.card.subbranch,locate:this.card.locate},function(){d.reminder("Success"),a.close()},function(){d.reload("Warning")})},this.cancel=function(){a.dismiss("cancel")}}]}).result.then(d.getCardList)})},d.removeCard=function(e){swal({title:"确认删除此项吗？",text:"卡号："+e.account,type:"warning",showCancelButton:!0,cancelButtonText:"取消",confirmButtonText:"确认",confirmButtonColor:"#ec6c62"}).then(function(){t.channelaccount.delete({id:e.id},function(){d.reminder("Success"),d.getCardList()},function(){d.reminder("Warning")})})},d.project=e.Project[d.projectid],a.$current.data.title=d.project.title,d.getCardList()}]);