"use strict";angular.module("app").controller("Finance.project.index",["$rootScope","$filter","$api","$state","$stateParams","$uibModal","EFUNDFLOW","SweetAlert","$timeout","$scope",function(e,n,t,a,i,r,l,o,c,u){var s=this;s.projectid=i.projectid,s.efundflow=l,t.pltfinance.billinginfo({projectid:s.projectid},function(e){e=e.result,s.epayment=e.epayment,s.payment=e.payment,s.prepayment=e.prepayment,s.thirdpartbill=e.thirdpartbill,s.efundflow.selected=e.efundflow||"PLT",s.withdraw=e.withdraw,s.EWP=e.EWP,s.ZFT=e.ZFT,s.alipay=e.alipay,s.wx=e.wx,s.wx_pub=e.wx_pub}),s.reload=function(){a.go("admin.finance.project.info",{},{reload:!0})},s.save=function(e,n){o.swal({title:"确认修改此项属性？",type:"info",showCancelButton:!0,cancelButtonText:"取消",confirmButtonText:"确认"}).then(function(){var a={projectid:s.projectid,payment:s.payment,prepayment:s.prepayment,thirdpartbill:s.thirdpartbill,epayment:s.epayment};if("efundflow"!=e){if("PRJ"==s.efundflow.selected&&s.alipay&&s.alipay.enable&&s.alipay.share){if(Number(s.alipay.share.PRJ)+Number(s.alipay.share.USR)!=100)return void o.info("支付宝双方费率承担之和必须为100")}else if("PRJ"==s.efundflow.selected&&s.alipay&&s.alipay.enable)return void o.info("请填写支付宝费率承担");if("PRJ"==s.efundflow.selected&&s.wx&&s.wx.enable&&s.wx.share){if(Number(s.wx.share.PRJ)+Number(s.wx.share.USR)!=100)return void o.info("微信双方费率承担之和必须为100")}else if("PRJ"==s.efundflow.selected&&s.wx&&s.wx.enable)return void o.info("请填写微信费率承担");if("PRJ"==s.efundflow.selected&&s.wx_pub&&s.wx_pub.enable&&s.wx_pub.share){if(Number(s.wx_pub.share.PRJ)+Number(s.wx_pub.share.USR)!=100)return void o.info("微信公众号双方费率承担之和必须为100")}else if("PRJ"==s.efundflow.selected&&s.wx_pub&&s.wx_pub.enable)return void o.info("请填写微信公众号费率承担");if("PRJ"==s.efundflow.selected&&s.ZFT&&s.ZFT.enable&&s.ZFT.wx&&s.ZFT.wx.enable&&s.ZFT.wx.share){if(Number(s.ZFT.wx.share.PRJ)+Number(s.ZFT.wx.share.USR)!=100)return void o.info("租付通APP微信支付双方费率承担之和必须为100")}else if("PRJ"==s.efundflow.selected&&s.ZFT&&s.ZFT.enable&&s.ZFT.wx&&s.ZFT.wx.enable)return void o.info("请填写租付通APP微信支付费率承担");if("PRJ"==s.efundflow.selected&&s.EWP&&s.EWP.enable&&s.EWP.wx_pub&&s.EWP.wx_pub.enable&&s.EWP.wx_pub.share){if(Number(s.EWP.wx_pub.share.PRJ)+Number(s.EWP.wx_pub.share.USR)!=100)return void o.info("公众号微信支付双方费率承担之和必须为100")}else if("PRJ"==s.efundflow.selected&&s.EWP&&s.EWP.enable&&s.EWP.wx_pub&&s.EWP.wx_pub.enable)return void o.info("请填写公众号微信支付费率承担");if("PRJ"==s.efundflow.selected&&s.ZFT&&s.ZFT.enable&&s.ZFT.alipay&&s.ZFT.alipay.enable&&s.ZFT.alipay.share){if(Number(s.ZFT.alipay.share.PRJ)+Number(s.ZFT.alipay.share.USR)!=100)return void o.info("支付宝支付双方费率承担之和必须为100")}else if("PRJ"==s.efundflow.selected&&s.ZFT&&s.ZFT.enable&&s.ZFT.alipay&&s.ZFT.alipay.enable)return void o.info("请填写支付宝支付费率承担")}"ZFT.wx"==e?(a.ZFT={},a.ZFT.enable=s.ZFT.enable,a.ZFT.wx=n.wx):"ZFT.alipay"==e?(a.ZFT={},a.ZFT.enable=s.ZFT.enable,a.ZFT.alipay=n.alipay):a[e]=n,t.pltfinance.billingupdate(a,function(){s.requestSuccess=!0;var e=c(function(){s.requestSuccess=!1,e.cancel()},3e3)},function(e){o.warning(e.message).then(function(){s.requestWarning=!0;var e=c(function(){s.requestWarning=!1,e.cancel()},3e3);s.reload()})})},function(){s.reload()})},s.getCardList=function(){t.channelaccount.info({project:s.projectid,all:!0,flow:"EXPENSE"},function(e){s.cardData=e.result})},s.getCard=function(e){t.bank.info(function(n){r.open({templateUrl:"modal-finance-project-card.html",controllerAs:"self",controller:["$api","$uibModalInstance",function(t,a){this.bankData=n.result,this.card=e||{},this.card.locate=angular.isString(this.card.locate)&&JSON.parse(this.card.locate||null)||this.card.locate||{province:"浙江省",city:"杭州市",district:"西湖区"},angular.forEach(this.bankData,$.proxy(function(e){this.bankData[e.id]=e,this.card.origin===e.title&&(this.card.origin=e.id)},this)),this.submit=function(){t.channelaccount.add({id:this.card.id||void 0,flow:this.card.flow||"EXPENSE",belongto:this.card.belongto?void 0:s.projectid,name:this.card.name,account:this.card.account,origin:this.bankData[this.card.origin].title,subbranch:this.card.subbranch,locate:this.card.locate},function(){s.requestSuccess=!0;var e=c(function(){s.requestSuccess=!1,e.cancel()},3e3);a.close()},function(){s.requestWarning=!0;var e=c(function(){s.requestWarning=!1,e.cancel()},3e3);s.reload()})},this.cancel=function(){a.dismiss("cancel")}}]}).result.then(s.getCardList)})},s.removeCard=function(e){swal({title:"确认删除此项吗？",text:"卡号："+e.account,type:"warning",showCancelButton:!0,cancelButtonText:"取消",confirmButtonText:"确认",confirmButtonColor:"#ec6c62"}).then(function(){t.channelaccount.delete({id:e.id},function(){s.requestSuccess=!0;var e=c(function(){s.requestSuccess=!1,e.cancel()},3e3);s.getCardList()},function(){s.requestWarning=!0;var e=c(function(){s.requestWarning=!1,e.cancel()},3e3)})})},s.project=e.Project[s.projectid],a.$current.data.title=s.project.title,s.getCardList()}]);