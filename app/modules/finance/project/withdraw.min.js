"use strict";angular.module("app").controller("Finance.project.withdraw",["$scope","$api","$state","$stateParams","$uibModal",function(t,a,n,c,e){var o=this;o.projectid=c.projectid,o.cardSelected=null,o.project=EMAPP.Project[o.projectid],n.$current.parent.data.title=o.project.title,a.business.accountbalance({project:o.projectid},function(t){o.accountbalance=t.result,o.accountbalance.total=Math.round(100*(o.accountbalance.cash+o.accountbalance.frozen))/100,o.accountbalance.cash=Math.round(100*o.accountbalance.cash)/100,o.accountbalance.frozen=Math.round(100*o.accountbalance.frozen)/100,o.accountbalance.earning=Math.round(100*o.accountbalance.earning)/100,o.accountbalance.withdraw=Math.round(100*o.accountbalance.withdraw)/100}),o.queryFee=function(){return o.amount&&(o.amount=Math.round(100*o.amount)/100),!(!o.cardSelected||!o.amount)&&void a.payment.handlingcharge({channelaccount:o.cardSelected.id,amount:o.amount},function(t){o.fee=t.result.PRJ})},t.$watch(function(){return o.cardSelected},function(t){t&&o.queryFee()}),o.getCardList=function(){a.channelaccount.info({project:o.projectid,all:!0,flow:"EXPENSE",status:"SUCCESS"},function(t){o.cardData=t.result})},o.getCardList(),o.inject=function(){e.open({templateUrl:"withdraw_request_confirmation.html",controllerAs:"self",controller:["$uibModalInstance","data",function(t,a){this.submit=function(){t.close(this.detail)},this.cancel=function(){t.dismiss("cancel")},this.detail=a,this.detail.timecreate=moment().unix(),this.detail.applicant=EMAPP.Account._id}],resolve:{data:function(){return{card:o.cardSelected,amount:o.amount,fee:o.fee,project:o.projectid}}},size:"md"}).result.then(function(t){a.withdraw.apply({project:t.project,amount:t.amount,channelaccount:t.card.id},function(){swal("成功","已提交成功","success"),n.go(n.current.name,{projectid:o.projectid},{reload:!0})},function(t){swal("错误",t.message,"error")})})}}]);