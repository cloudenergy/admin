"use strict";angular.module("app").controller("Finance.record.out",["$rootScope","$scope","$filter","$timeout","$api","$q","$state","$stateParams","uiGridConstants",function(e,t,n,i,a,o,r,c,l){var d=this;new Date;d.projectid=c.projectid,d.paneHeight=90.01,d.searchText="",d.startDate=moment(new Date).subtract(30,"days").format("YYYY-MM-DD"),d.endDate=moment(new Date).format("YYYY-MM-DD"),d.types=[{title:"全部类型"},{key:"RECHARGING",title:"充值"},{key:"WITHDRAW",title:"提现"},{key:"PAYFEES",title:"缴费"},{key:"HANDLINGCHARGE",title:"服务费"}],angular.forEach(d.types,function(e){d.types[e.key]=e.title},d.types),d.status=[{title:"全部状态"},{key:"CHECKING",title:"等待审核"},{key:"CHECKFAILED",title:"审核失败"},{key:"PROCESSING",title:"正在处理"},{key:"FAILED",title:"处理失败"},{key:"SUCCESS",title:"完成"}],angular.forEach(d.status,function(e){d.status[e.key]=e.title},d.status),d.operation={color:{CHECKING:"text-primary",PROCESSING:"text-warning",CHECKFAILED:"text-danger",FAILED:"text-danger",SUCCESS:"text-success"},text:{CHECKING:"审核",PROCESSING:"状态",CHECKFAILED:"查看明细",FAILED:"查看明细",SUCCESS:"查看明细"}},$("#start_date").bind("dp.change",function(e){i(function(){e.date&&e.oldDate&&d.list()})}),$("#end_date").bind("dp.change",function(e){i(function(){e.date&&e.oldDate&&d.list()})}),d.filter=function(){d.gridOptions.enableFiltering=!d.gridOptions.enableFiltering,d.gridApi.core.notifyDataChange(l.dataChange.COLUMN)},d.export=function(){d.gridOptions.exporterCsvFilename="平台财务_支出_"+(d.projectname?d.projectname+"_":"")+d.startDate.replace(/\-/g,"")+"_"+d.endDate.replace(/\-/g,"")+".csv",d.gridApi.exporter.csvExport("visible","visible",angular.element(document.querySelectorAll(".subContent")))},d.projectid&&(r.$current.data.title=d.projectname=e.Project[d.projectid].title,a.business.accountbalance({project:d.projectid},function(e){d.accountbalance=e.result,d.accountbalance.total=n("number")(d.accountbalance.cash+d.accountbalance.frozen,2).replace(/\,/g,""),d.accountbalance.cash=n("number")(d.accountbalance.cash,2).replace(/\,/g,""),d.accountbalance.frozen=n("number")(d.accountbalance.frozen,2).replace(/\,/g,"")})),d.placeholder=d.projectid&&"商户名称"||"项目名称",d.list=function(e){if(!(e&&d.gridOptions.paging&&d.gridOptions.paging.count<=d.gridOptions.paging.pageindex*d.gridOptions.paging.pagesize))return a.business.pltfundflow({projectid:d.projectid||void 0,key:d.searchText||void 0,from:d.startDate.replace(/\-/g,""),to:d.endDate.replace(/\-/g,""),flow:"EXPENSE",category:d.types.selected||void 0,status:d.status.selected||void 0,pageindex:(e&&d.gridOptions.paging?d.gridOptions.paging.pageindex:0)+1,pagesize:100},function(t){return t=t.result,angular.forEach(t.detail,function(e){e.timecreate=e.timecreate&&n("date")(1e3*e.timecreate,"yyyy-M-dd H:mm:ss")||"";var t=[];e.channelaccount.name&&t.push(e.channelaccount.name),e.channelaccount.origin&&t.push(e.channelaccount.origin),e.channelaccount.account&&t.push("尾号: "+e.channelaccount.account.substr(e.channelaccount.account.length-4)),e.channelaccount=t.join(" | ")||"关联账户不存在"}),e?d.gridOptions.data=d.gridOptions.data.concat(t.detail||[]):(d.gridOptions.data=t.detail||[],d.gridOptions.data.length&&i(function(){d.gridApi.core.scrollTo(d.gridOptions.data[0],d.gridOptions.columnDefs[0])})),d.gridOptions.paging=t.paging,i(function(){d.paneHeight=90}),d.gridApi.grid.element.height("auto"),t}).$promise},d.list(),d.gridOptions={onRegisterApi:function(e){e.infiniteScroll.on.needLoadMoreData(t,function(){var t=o.defer(),n=t.resolve,i=function(){e.infiniteScroll.dataLoaded(),t.reject()};return function(t){t?t.then(function(){e.infiniteScroll.saveScrollPercentage(),e.infiniteScroll.dataLoaded(!1,!0).then(n,i)},i):i()}(d.list(!0)),t.promise}),d.gridApi=e},infiniteScrollDown:!0,enableColumnResizing:!0,exporterOlderExcelCompatibility:!0,exporterFieldCallback:function(e,t,n,i){return/status/.test(n.field)&&(i=d.status[i]||""),0===i?0:'="'+(i||"")+'"'},columnDefs:[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">序号</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"项目名称",name:"projectname",width:"*",minWidth:120,visible:!d.projectid,enableColumnMenu:!1,cellTemplate:'<div class="ui-grid-cell-contents text-primary"><a ui-sref="admin.finance.record.out.project({projectid:row.entity.project})" ng-bind="COL_FIELD"></a></div>'},{displayName:"交易帐户",name:"channelaccount",width:"*",minWidth:220,enableColumnMenu:!1},{displayName:"提现金额 ¥",name:"amount",width:"*",minWidth:120},{displayName:"操作后余额 ¥",name:"balance",width:"*",minWidth:120,enableColumnMenu:!1},{displayName:"交易类型",name:"category",width:"*",minWidth:100,enableColumnMenu:!1},{displayName:"交易状态",name:"status",width:"*",minWidth:100,enableColumnMenu:!1,cellTemplate:'<div class="ui-grid-cell-contents" ng-class="grid.appScope.self.operation.color[row.entity.status]" ng-bind="grid.appScope.self.status[COL_FIELD]"></div>'},{displayName:"提交时间",name:"timecreate",width:"*",minWidth:130},{displayName:"操作",name:"operation",width:"*",minWidth:80,enableColumnMenu:!1,exporterSuppressExport:!0,cellTemplate:'<div class="ui-grid-cell-contents text-primary"><a class="text-primary" ui-sref="admin.finance.record.out.project.detail({projectid:row.entity.project,orderno:row.entity.orderno})" ng-bind="grid.appScope.self.operation.text[row.entity.status]"></a></div>'}]}}]);