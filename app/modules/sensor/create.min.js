"use strict";angular.module("app").controller("SensorCreate",["$rootScope","$scope","$state","$stateParams","$api","UI",function(e,n,i,t,s,o){function r(e){var n=e.split("|");return _.isArray(n)?n[0]||e:e}function c(e,n,i){if(n){var t=[];return _.each(n,function(n){n.childrens?n.ischild=!1:n.ischild=!0,n.parent=e,n.level=i,n.nodes=c(n,n.childrens,i+1),t.push(n)}),t.sort(function(e,n){return e.title>n.title?1:-1}),t}}n.sensor={mask:!1,comi:"d*1"},n.buildingID=t.building;var l;n.submit=function(t){var c=angular.copy(n.sensor);if(!l)return void o.AlertWarning("请选择智能仪表能耗类型");c.project=e.Project.selected._id,c.building=n.buildingID,l&&(c.energy=r(l.id),c.energyPath=l.id),s.sensorchannel.add(c,function(){i.go("admin.sensor.info")},o.AlertError)},s.building.info({id:n.buildingID,project:e.Project.selected._id},function(i){n.building=i.result,n.building&&(n.sensor.building=n.building),s.energy.info({project:e.Project.selected._id},function(e){n.viewOfEnergy=[{nodes:c(null,e.result.energy,1),title:"能耗分类",level:0}]},function(){n.viewOfEnergy=[{nodes:[],title:"能耗分类",level:0}]})},function(e){n.alertError(e.message)}),n.addSocity=function(e){n.socities=_.reject(n.socities,function(n){return n._id==e._id}),n.sensorsocities.push(e)},n.removeSocity=function(e){n.sensorsocities=_.reject(n.sensorsocities,function(n){return n._id==e._id}),n.socities.push(e)},n.SwitchSocity=function(e,n){e.preventDefault(),n.isEnable=!n.isEnable,n.isEnable?n.isEnable=!1:n.isEnable=!0},n.sensorsocities=[],n.onChoice=function(e){e.isSelect=!e.isSelect;var n=function(e,i){e&&e.nodes&&e.nodes.length&&(_.each(e.nodes,function(e){n(e,i),e.isSelect=i}),e.isSelect=i)};n(e,e.isSelect)},n.onEnergyChoice=function(e){e.nodes||(l&&(l.isSelect=!1),l=e,l.isSelect=!0)},n.OnCollapsePayStatus=function(){n.sensor.paystatus&&"NONE"!=n.sensor.paystatus?n.sensor.paystatus="NONE":n.sensor.paystatus="BYSELF"},n.OnSelectPayMode=function(e,i){e.preventDefault(),n.sensor.paystatus=i}}]);