"use strict";angular.module("app").controller("SensorEdit",["$scope","$stateParams","$state","$api","Auth","UI",function(e,n,s,t,i,o){i.Check(function(){function i(e){var n=e.split("|");return _.isArray(n)?n[0]||e:e}function r(e,n,s){if(n){var t=[];return _.each(n,function(n){n.childrens?n.ischild=!1:n.ischild=!0,n.parent=e,n.level=s,n.nodes=r(n,n.childrens,s+1),t.push(n)}),t.sort(function(e,n){return e.title>n.title?1:-1}),t}}var c;e.submit=function(n){function r(){t.sensorchannel.update(l,function(){s.go("admin.sensor.info")})}var l=angular.copy(e.sensor);l.project=e.sensor.project,l.building=e.sensor.building&&e.sensor.building._id,c?(l.energy=i(c.id),l.energyPath=c.id):(l.energy="",l.energyPath=""),e.sensor.sid!=l.sid?t.sensor.info({sids:[l.sid]},function(){o.AlertWarning("传感器标识已经存在")},r):r()},t.sensorchannel.info({id:n.id},function(n){e.sensor=n.result[0],t.energy.info({project:e.sensor.project},function(n){var s,t=n.result.energy;e.viewOfEnergy=[{nodes:r(null,n.result.energy,1),title:"能耗分类",level:0}],e.sensor.energyPath&&_.each(e.sensor.energyPath.split("|"),function(e){t&&(s?s+="|"+e:s=e,t=t[s],t&&(t&&!t.childrens?(t.isSelect=!0,c=t):t=t.childrens))})},function(){e.viewOfEnergy=[{nodes:[],title:"能耗分类",level:0}]})}),e.onChoice=function(e){e.isSelect=!e.isSelect;var n=function(e,s){e&&e.nodes&&e.nodes.length&&(_.each(e.nodes,function(e){n(e,s),e.isSelect=s}),e.isSelect=s)};n(e,e.isSelect)},e.onEnergyChoice=function(e){e.nodes||(c&&(c.isSelect=!1),c=e,c.isSelect=!0)},e.OnCollapsePayStatus=function(){e.sensor.paystatus&&"NONE"!=e.sensor.paystatus?e.sensor.paystatus="NONE":e.sensor.paystatus="BYSELF"},e.OnSelectPayMode=function(n,s){n.preventDefault(),e.sensor.paystatus=s}})}]);