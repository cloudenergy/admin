"use strict";angular.module("app").controller("sensorAttribute",["$scope","$uibModalInstance","$q","$api","SensorSUID","ProjectID",function(e,r,i,t,n,d){function s(){return e.DriverCompany.selected.id&&e.DriverName.selected.id&&e.DriverVersion.selected.id?e.DriverCompany.selected.id+"/"+e.DriverName.selected.id+"/"+e.DriverVersion.selected.id:""}function v(r,i){var s={command:"EMC_VIEW_ADAPTDEVICE",sid:n,driver:r,projectid:d};t.control.send(s,function(r){e.AdaptDevice=[],_.each(r.result,function(r){e.AdaptDevice.push(r)}),i?e.adaptDeviceSelected=i:e.AdaptDevice.length&&(e.adaptDeviceSelected=e.AdaptDevice[0].code)})}e.Ok=function(){var i=s();if(!i.length)return void r.close();var v={_id:n,driver:i,project:d,ext:e.SensorAttrib.ext||{}};v.ext.adaptdevice=e.extDevice||"",t.sensorattrib.update(v,function(){r.close()})},e.Cancel=function(){r.dismiss("cancel")},e.$watch("DriverCompany.selected",function(r){if(r){if(e.AdaptDevice&&(e.AdaptDevice=[]),e.devicedrive&&(e.devicedrive=!1),e.DriverNames=e.Drivers[r.id].driver,!e.DriverNames)return;e.DriverName=[],_.map(e.DriverNames,function(r,i){e.DriverName.push({id:i})});var i=e.SensorAttrib.driver&&e.SensorAttrib.driver.split("/");e.DriverName?e.DriverName.selected={id:i&&i[1]}:""}}),e.$watch("DriverName.selected",function(r){if(r){if(e.DriverNames[r.id]&&(e.DriverVersions=e.DriverNames[r.id].driver),!e.DriverVersions)return;e.DriverVersion=[],_.map(e.DriverVersions,function(r,i){e.DriverVersion.push({id:i})});var i=e.SensorAttrib.driver&&e.SensorAttrib.driver.split("/");e.DriverVersion?e.DriverVersion.selected={id:i&&i[2]}:""}}),e.$watch("DriverVersion.selected",function(r){if(r){var i=s(),n=e.DriverCompany.selected.id+"/"+e.DriverName.selected.id+"/"+e.DriverVersion.selected.id;if(t.control.driverinfo({driver:n},function(r){r.result&&r.result.adaptdevice?(e.devicedrive=!0,e.AdaptDevice=[],angular.forEach(r.result.adaptdevice,function(r){e.AdaptDevice.push(r)})):e.devicedrive=!1}),!i.length)return;v(i)}}),e.$watch("AdaptDevice.selected",function(r){r&&(e.extDevice=r.code)}),i.all([t.driver.enum().$promise,t.sensorattrib.info({sensor:n}).$promise]).then(function(r){if(e.Drivers=r[0].result,e.DriverCompany=[],_.map(e.Drivers,function(r,i){e.DriverCompany.push({id:i})}),e.SensorAttrib=r[1].result,e.SensorAttrib){if(e.SensorAttrib.driver){var i=e.SensorAttrib.driver.split("/");e.DriverCompany.selected={id:i[0]},e.DriverName.selected={id:i[1]},e.DriverVersion.selected={id:i[2]}}var t=null;t=e.SensorAttrib.ext&&e.SensorAttrib.ext.adaptdevice,v(e.SensorAttrib.driver,t)}})}]);