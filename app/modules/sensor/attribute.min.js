"use strict";angular.module("app").controller("sensorAttribute",["$scope","$uibModalInstance","$q","$api","SensorSUID","ProjectID",function(e,r,i,s,t,n){function o(){return e.DriverCompany.selected&&e.DriverName.selected&&e.DriverVersion.selected?e.DriverCompany.selected.id+"/"+e.DriverName.selected.id+"/"+e.DriverVersion.selected.id:""}e.else=2,e.Ok=function(){var i=o(),d={did:t,driver:i,projectid:n,ext:e.SensorAttrib.ext||{},title:e.sensorInfo.title,tag:e.sensorInfo.tag,freq:e.sensorInfo.freq,comi:e.sensorInfo.comi,areaid:e.sensorInfo.areaid,addrid:e.sensorInfo.addrid,meterid:e.sensorInfo.meterid};d.ext.adaptdevice=e.extDevice||"",s.sensor.update(d,function(){r.close()})},e.Cancel=function(){r.dismiss("cancel")},e.$watch("DriverCompany.selected",function(r){if(r){if(e.AdaptDevice&&(e.AdaptDevice=[]),e.devicedrive&&(e.devicedrive=!1),e.DriverNames=e.Drivers[r.id].driver,!e.DriverNames)return;e.DriverName=[],_.map(e.DriverNames,function(r,i){e.DriverName.push({id:i})});var i=e.SensorAttrib.driver&&e.SensorAttrib.driver.split("/");e.DriverName&&(e.DriverName.selected={id:i&&i[1]})}}),e.$watch("DriverName.selected",function(r){if(r){if(e.DriverNames[r.id]&&(e.DriverVersions=e.DriverNames[r.id].driver),!e.DriverVersions)return;e.DriverVersion=[],_.map(e.DriverVersions,function(r,i){e.DriverVersion.push({id:i})});var i=e.SensorAttrib.driver&&e.SensorAttrib.driver.split("/");e.DriverVersion&&(e.DriverVersion.selected={id:i&&i[2]})}}),e.$watch("DriverVersion.selected",function(r){if(r){var i=o(),t=e.DriverCompany.selected.id+"/"+e.DriverName.selected.id+"/"+e.DriverVersion.selected.id;if(s.control.driverinfo({driver:t},function(r){r.result&&r.result.adaptdevice?(e.devicedrive=!0,e.AdaptDevice=[],angular.forEach(r.result.adaptdevice,function(r){e.AdaptDevice.push(r)})):e.devicedrive=!1}),!i.length)return}}),e.$watch("AdaptDevice.selected",function(r){r&&(e.extDevice=r.code)}),i.all([s.driver.enum().$promise,s.sensor.info({project:n,did:t}).$promise]).then(function(r){if(e.Drivers=r[0].result,e.DriverCompany=[],_.map(e.Drivers,function(r,i){e.DriverCompany.push({id:i})}),e.SensorAttrib=r[1].result,e.sensorInfo={},e.sensorInfo.title=r[1].result.title,e.sensorInfo.tag=r[1].result.tag,e.sensorInfo.freq=r[1].result.freq,e.sensorInfo.comi=r[1].result.comi,e.sensorInfo.areaid=r[1].result.areaid,e.sensorInfo.addrid=r[1].result.addrid,e.sensorInfo.meterid=r[1].result.meterid,e.SensorAttrib&&e.SensorAttrib.driver){var i=e.SensorAttrib.driver.split("/");e.DriverCompany&&(e.DriverCompany.selected={id:i[0]}),e.DriverName&&(e.DriverName.selected={id:i[1]}),e.DriverVersion&&(e.DriverVersion.selected={id:i[2]})}})}]);