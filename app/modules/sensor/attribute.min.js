"use strict";angular.module("app").controller("sensorAttribute",["$scope","$uibModalInstance","$q","$api","SensorSUID","ProjectID",function(e,r,i,t,n,s){function o(){return e.DriverCompany.selected&&e.DriverName.selected&&e.DriverVersion.selected?e.DriverCompany.selected.id+"/"+e.DriverName.selected.id+"/"+e.DriverVersion.selected.id:""}function d(r,i){t.control.send({command:"EMC_VIEW_ADAPTDEVICE",sid:n,driver:r,projectid:s},function(r){e.AdaptDevice=[],_.each(r.result,function(r){e.AdaptDevice.push(r)}),i?e.adaptDeviceSelected=i:e.AdaptDevice.length&&(e.adaptDeviceSelected=e.AdaptDevice[0].code)})}e.else=2,e.Ok=function(){var i=o(),d={did:n,driver:i,projectid:s,ext:e.SensorAttrib.ext||{},title:e.sensorInfo.title,tag:e.sensorInfo.tag,freq:e.sensorInfo.freq,comi:e.sensorInfo.comi,areaid:e.sensorInfo.areaid,addrid:e.sensorInfo.addrid,meterid:e.sensorInfo.meterid};d.ext.adaptdevice=e.extDevice||"",t.sensor.update(d,function(){r.close()})},e.Cancel=function(){r.dismiss("cancel")},e.$watch("DriverCompany.selected",function(r){if(console.log(1),r){if(e.AdaptDevice&&(e.AdaptDevice=[]),e.devicedrive&&(e.devicedrive=!1),e.DriverNames=e.Drivers[r.id].driver,!e.DriverNames)return;e.DriverName=[],_.map(e.DriverNames,function(r,i){e.DriverName.push({id:i})});var i=e.SensorAttrib.driver&&e.SensorAttrib.driver.split("/");e.DriverName&&(e.DriverName.selected={id:i&&i[1]})}}),e.$watch("DriverName.selected",function(r){if(console.log(2),r){if(e.DriverNames[r.id]&&(e.DriverVersions=e.DriverNames[r.id].driver),!e.DriverVersions)return;e.DriverVersion=[],_.map(e.DriverVersions,function(r,i){e.DriverVersion.push({id:i})});var i=e.SensorAttrib.driver&&e.SensorAttrib.driver.split("/");e.DriverVersion&&(e.DriverVersion.selected={id:i&&i[2]})}}),e.$watch("DriverVersion.selected",function(r){if(r){var i=o(),n=e.DriverCompany.selected.id+"/"+e.DriverName.selected.id+"/"+e.DriverVersion.selected.id;if(t.control.driverinfo({driver:n},function(r){console.log(3),r.result&&r.result.adaptdevice?(e.devicedrive=!0,e.AdaptDevice=[],angular.forEach(r.result.adaptdevice,function(r){e.AdaptDevice.push(r),console.log(e.AdaptDevice)})):e.devicedrive=!1}),!i.length)return;d(i)}}),e.$watch("AdaptDevice.selected",function(r){r&&(e.extDevice=r.code)}),i.all([t.driver.enum().$promise,t.sensor.info({project:s,did:n}).$promise]).then(function(r){if(e.Drivers=r[0].result,e.DriverCompany=[],_.map(e.Drivers,function(r,i){e.DriverCompany.push({id:i})}),e.SensorAttrib=r[1].result,e.sensorInfo={},e.sensorInfo.title=r[1].result.title,e.sensorInfo.tag=r[1].result.tag,e.sensorInfo.freq=r[1].result.freq,e.sensorInfo.comi=r[1].result.comi,e.sensorInfo.areaid=r[1].result.areaid,e.sensorInfo.addrid=r[1].result.addrid,e.sensorInfo.meterid=r[1].result.meterid,e.SensorAttrib){if(e.SensorAttrib.driver){var i=e.SensorAttrib.driver.split("/");e.DriverCompany&&(e.DriverCompany.selected={id:i[0]}),e.DriverName&&(e.DriverName.selected={id:i[1]}),e.DriverVersion&&(e.DriverVersion.selected={id:i[2]})}var t=null;t=e.SensorAttrib.ext&&e.SensorAttrib.ext.adaptdevice,d(e.SensorAttrib.driver,t)}})}]);