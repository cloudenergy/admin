"use strict";angular.module("app").controller("SensorIndex",["$rootScope","$scope","$q","$api","$uibModal","SweetAlert","$state",function(e,n,t,o,i,c,s){function r(e){if(!e||!e.length)return null;var n={};return _.map({buildingID:10,gatewayID:2,addrID:12,meterID:3,funcID:2},function(t,o){n[o]=e.substr(0,t),e=e.substr(t)}),n}var l="sensor_building_selected";n.OnSearch=function(){o.business.monitor({devicetype:n.DeviceTypes.selected||void 0,building:!n.customer.enable&&n.buildings.selected||void 0,project:e.Project.selected._id,key:n.searchKey||void 0,mode:"SENSOR",usesocity:n.customer.enable||void 0,socitynode:n.customer.enable&&n.customer.selected||void 0,pageindex:n.currentPage||1,pagesize:n.pageSize},function(t){t=t.result[e.Project.selected._id],angular.forEach(t.detail,function(e){this.push(e)},n.viewOfSensor=[]),n.itemsTotal=t.paging.count})},n.currentPage=1,n.pageSize=15,n.searchKey=localStorage.sensor_index_search,n.customer={enable:!angular.isDefined(n.customer)||n.customer.enable},t.all([function(){return o.customer.info({project:e.Project.selected._id,onlynode:1},function(e){n.customer={enable:n.customer.enable,selected:"ROOT",core:{data:[{id:"ROOT",parent:"#",text:"全部社会属性",state:{selected:!0,opened:!0},icon:"glyphicon glyphicon-th-list"}]},conditionalselect:function(e){return n.customer.selected=e.id,n.OnSearch(),!0},plugins:["search","conditionalselect"]},function e(t,o){angular.forEach(t,function(t){t.parent=o,t.text=t.title,Object.keys(t.child).length?t.icon="glyphicon glyphicon-th-list":t.icon="glyphicon glyphicon-file",e(t.child,t.id),n.customer.core.data.push(t)})}(e.result,"ROOT")},function(){n.customer={enable:n.customer.enable,selected:"ROOT",core:{data:[{id:"ROOT",parent:"#",text:"全部社会属性",state:{selected:!0,opened:!0},icon:"glyphicon glyphicon-th-list"}]},plugins:["search","conditionalselect"]}}).$promise}(),function(){return o.building.info({project:e.Project.selected._id},function(e){var t=localStorage[l];n.buildings=[],angular.forEach(e.result.detail,function(e){this.push(e)},n.buildings),n.buildings.select=function(){localStorage[l]=n.buildings.selected,n.OnSearch()},angular.forEach(n.buildings,function(e){e.id===t&&(n.buildings.selected=e.id)}),n.buildings.selected=n.buildings.selected||(n.buildings[0]||{}).id},function(){n.buildings=[]}).$promise}(),function(){return o.device.type({project:e.Project.selected._id},function(e){n.DeviceTypes=[{id:void 0,title:"全部设备"}],angular.forEach(e.result,function(e){this.push({id:e.id,title:e.name})},n.DeviceTypes),n.DeviceTypes.selected=n.DeviceTypes.selected||(n.DeviceTypes[0]||{}).id,n.DeviceTypes.select=function(){n.OnSearch()}},function(){n.DeviceTypes=[{id:void 0,title:"全部设备"}]}).$promise}()]).then(n.OnSearch,function(){n.viewOfSensor=[],n.itemsTotal=0}),n.$watch("currentPage",function(){n.viewOfSensor&&n.OnSearch()}),n.$watch("customer.enable",function(){n.viewOfSensor&&n.OnSearch()}),n.$watch("searchKey",function(e){angular.isDefined(e)&&(localStorage.sensor_index_search=e)}),n.OnMask=function(e){o.sensorchannel.update({id:e.id,mask:!e.mask},function(){e.mask=!e.mask})},n.OnMaskAll=function(e){confirm("是否确定"+(e?"屏蔽":"启用")+"所有通道？")&&angular.forEach(n.viewOfSensor,function(n){angular.forEach(n.channels,function(n){o.sensorchannel.update({id:n.id,mask:e},function(){n.mask=e})})})},n.OnSyncAll=function(){confirm("是否确定同步所有数据异常的智能仪表？")&&o.sensorchannel.syncdata({project:e.Project.selected._id},function(){c.success("同步完成"),n.OnSearch()})},n.onRemove=function(e){o.sensorchannel.delete({id:e.id},function(){n.OnSearch()},c.error)},n.OnSensorAttribute=function(n){i.open({templateUrl:"sensorAttribute.html",controller:"sensorAttribute",size:"lg",resolve:{SensorSUID:function(){var e=r(n.id);return e?e.buildingID+e.gatewayID+e.addrID+e.meterID:null},ProjectID:function(){return e.Project.selected._id}}}).result.then(function(){},function(){})},n.importSensor=function(){var t=n,o=!1;i.open({templateUrl:"importSensor.html",size:"md",controller:["$scope","$timeout","$uibModalInstance","project","building","customer",function(e,n,i,s,r,l){e.actionURL=window.APIORIGIN+"/api/import/equipments",e.project=s,e.building=r,e.customer=l,e.ok=function(){i.close(),o&&t.OnSearch()},e.OnUploadComplete=function(e){return e.code?c.error(e.result,e.message):(o=!0,c.success("导入成功")),!1},e.cancel=i.dismiss}],resolve:{project:function(){return e.Project.selected._id},building:function(){return n.buildings.selected},customer:function(){return n.customer.selected}}})},n.exportSensor=function(){delete n.downloadFile,o.export.equipments({projectid:e.Project.selected._id},function(t){t.result.fn&&(n.downloadFile=t.result.fn,n.downloadName=e.Project.selected.title+"_"+s.$current.data.title)})},n.accountChange=function(n,t){var s={title:"titleChange.html",tag:"tagChange.html",comi:"comiChange.html"};i.open({size:"sm",templateUrl:s[t],controller:["$scope","$uibModalInstance",function(t,i){t.sensor=angular.copy(n),t.sensor.did=t.sensor.id,t.title=t.sensor.title,t.tag=t.sensor.tag,t.comi=t.sensor.comi,t.ok=function(){t.sensor.projectid=e.Project.selected._id,o.sensor.update(t.sensor,function(){angular.extend(n,t.sensor),c.success("更新成功")},c.error),t.OnCancel=i.dismiss("cancel")},t.cancel=function(){t.OnCancel=i.dismiss("cancel")}}]})},n.popIsOpen=function(){angular.forEach(n.viewOfSensor,function(e){delete e.titleIsOpen,delete e.tagIsOpen,delete e.comiIsOpen})},n.popover={url:{title:"titleChange.html",tag:"tagChange.html",comi:"comiChange.html"},title:{title:"仪表名称修改",tag:"仪表编码修改",comi:"倍率修改"},ok:function(t,i,s){t[i+"IsOpen"]=!1,n.sensor=angular.copy(t),n.sensor.projectid=e.Project.selected._id,n.sensor.did=n.sensor.id,n.sensor[i]=s[i],o.sensor.update(n.sensor,function(){t[i]=s[i],c.success("更新成功")},c.error)},cancel:function(e,n){e[n+"IsOpen"]=!1}}}]);