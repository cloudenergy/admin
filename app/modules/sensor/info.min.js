"use strict";angular.module("app").controller("SensorIndex",["$rootScope","$scope","$q","$api","$uibModal","SweetAlert","$state",function(e,n,t,i,o,s,c){function r(e){if(!e||!e.length)return null;var n={};return _.map({buildingID:10,gatewayID:2,addrID:12,meterID:3,funcID:2},function(t,i){n[i]=e.substr(0,t),e=e.substr(t)}),n}var l="sensor_building_selected";n.OnSearch=function(){i.business.monitor({devicetype:n.DeviceTypes.selected||void 0,building:!n.customer.enable&&n.buildings.selected||void 0,project:e.Project.selected._id,key:n.searchKey||void 0,mode:"SENSOR",usesocity:n.customer.enable||void 0,socitynode:n.customer.enable&&n.customer.selected||void 0,pageindex:n.currentPage||1,pagesize:n.pageSize},function(t){t=t.result[e.Project.selected._id],angular.forEach(t.detail,function(e){this.push(e)},n.viewOfSensor=[]),n.itemsTotal=t.paging.count})},n.currentPage=1,n.pageSize=15,n.searchKey=sessionStorage.sensor_index_search,n.customer={enable:!angular.isDefined(n.customer)||n.customer.enable},t.all([function(){return i.customer.info({project:e.Project.selected._id,onlynode:1},function(e){n.customer={enable:n.customer.enable,selected:"ROOT",core:{data:[{id:"ROOT",parent:"#",text:"全部树形结构",state:{selected:!0,opened:!0},icon:"glyphicon glyphicon-th-list"}]},conditionalselect:function(e){return n.customer.selected=e.id,n.OnSearch(),!0},plugins:["search","conditionalselect"]},function e(t,i){angular.forEach(t,function(t){t.parent=i,t.text=t.title,Object.keys(t.child).length?t.icon="glyphicon glyphicon-th-list":t.icon="glyphicon glyphicon-file",e(t.child,t.id),n.customer.core.data.push(t)})}(e.result,"ROOT")},function(){n.customer={enable:n.customer.enable,selected:"ROOT",core:{data:[{id:"ROOT",parent:"#",text:"全部树形结构",state:{selected:!0,opened:!0},icon:"glyphicon glyphicon-th-list"}]},plugins:["search","conditionalselect"]}}).$promise}(),function(){return i.building.info({project:e.Project.selected._id},function(e){var t=sessionStorage[l];n.buildings=[],angular.forEach(e.result.detail,function(e){this.push(e)},n.buildings),n.buildings.select=function(){sessionStorage[l]=n.buildings.selected,n.OnSearch()},angular.forEach(n.buildings,function(e){e.id===t&&(n.buildings.selected=e.id)}),n.buildings.selected=n.buildings.selected||(n.buildings[0]||{}).id},function(){n.buildings=[]}).$promise}(),function(){return i.device.type({project:e.Project.selected._id},function(e){n.DeviceTypes=[{id:void 0,title:"全部设备"}],angular.forEach(e.result,function(e){this.push({id:e.id,title:e.name})},n.DeviceTypes),n.DeviceTypes.selected=n.DeviceTypes.selected||(n.DeviceTypes[0]||{}).id,n.DeviceTypes.select=function(){n.OnSearch()}},function(){n.DeviceTypes=[{id:void 0,title:"全部设备"}]}).$promise}()]).then(n.OnSearch,function(){n.viewOfSensor=[],n.itemsTotal=0}),n.$watch("currentPage",function(){n.viewOfSensor&&n.OnSearch()}),n.$watch("customer.enable",function(){n.viewOfSensor&&n.OnSearch()}),n.$watch("searchKey",function(e){angular.isDefined(e)&&(sessionStorage.sensor_index_search=e)}),n.OnMask=function(e){i.sensorchannel.update({id:e.id,mask:!e.mask},function(){e.mask=!e.mask})},n.OnMaskAll=function(e){confirm("是否确定"+(e?"屏蔽":"启用")+"所有通道？")&&angular.forEach(n.viewOfSensor,function(n){angular.forEach(n.channels,function(n){i.sensorchannel.update({id:n.id,mask:e},function(){n.mask=e})})})},n.OnSyncAll=function(){confirm("是否确定同步所有数据异常的智能仪表？")&&i.sensorchannel.syncdata({project:e.Project.selected._id},function(){s.success("同步完成"),n.OnSearch()})},n.onRemove=function(e){i.sensorchannel.delete({id:e.id},function(){n.OnSearch()},s.error)},n.OnSensorAttribute=function(n){o.open({templateUrl:"sensorAttribute.html",controller:"sensorAttribute",size:"lg",resolve:{SensorSUID:function(){var e=r(n.id);return e?e.buildingID+e.gatewayID+e.addrID+e.meterID:null},ProjectID:function(){return e.Project.selected._id}}}).result.then(function(){},function(){})},n.importSensor=function(){var t=n,c=!1;o.open({templateUrl:"importSensor.html",size:"md",controller:["$scope","$timeout","$uibModalInstance","project","building","customer",function(n,o,r,l,u,a){n.wifi={show:!1,equipments:""},n.actionURL="/api/import/equipments",n.project=l,n.building=u,n.customer=a,n.ok=function(){r.close(),n.wifi.show?i.project.bindequipment({projectid:e.Project.selected._id,equipments:n.wifi.equipments},function(){t.OnSearch()}):c&&t.OnSearch()},n.OnUploadComplete=function(e){return e.code?s.error(e.result,e.message):(c=!0,s.success("导入成功")),!1},n.cancel=r.dismiss}],resolve:{project:function(){return e.Project.selected._id},building:function(){return n.buildings.selected},customer:function(){return n.customer.selected}}})},n.exportSensor=function(){delete n.downloadFile,i.export.equipments({projectid:e.Project.selected._id},function(t){t.result.fn&&(n.downloadFile=t.result.fn,n.downloadName=e.Project.selected.title+"_"+c.$current.data.title)})},n.accountChange=function(n,t){var c={title:"titleChange.html",tag:"tagChange.html",comi:"comiChange.html"};o.open({size:"sm",templateUrl:c[t],controller:["$scope","$uibModalInstance",function(t,o){t.sensor=angular.copy(n),t.sensor.did=t.sensor.id,t.title=t.sensor.title,t.tag=t.sensor.tag,t.comi=t.sensor.comi,t.ok=function(){t.sensor.projectid=e.Project.selected._id,i.sensor.update(t.sensor,function(){angular.extend(n,t.sensor),s.success("更新成功")},s.error),t.OnCancel=o.dismiss("cancel")},t.cancel=function(){t.OnCancel=o.dismiss("cancel")}}]})},n.popIsOpen=function(){angular.forEach(n.viewOfSensor,function(e){delete e.titleIsOpen,delete e.tagIsOpen,delete e.comiIsOpen})},n.popover={url:{title:"titleChange.html",tag:"tagChange.html",comi:"comiChange.html"},title:{title:"仪表名称修改",tag:"仪表编码修改",comi:"倍率修改"},ok:function(t,o,c){var r=o+"IsOpen";"comi"==o?c.comi.match(/^(d\*)[1-9][0-9]{0,}/)?(t[r]=!1,n.sensor=angular.copy(t),n.sensor.projectid=e.Project.selected._id,n.sensor.did=n.sensor.id,n.sensor[o]=c[o],i.sensor.update(n.sensor,function(){t[o]=c[o],s.success("更新成功")},s.error)):s.warning('请以"d*"开头并以不小于1的整数结尾'):(t[r]=!1,n.sensor=angular.copy(t),n.sensor.projectid=e.Project.selected._id,n.sensor.did=n.sensor.id,n.sensor[o]=c[o],i.sensor.update(n.sensor,function(){t[o]=c[o],s.success("更新成功")},s.error))},cancel:function(e,n){e[n+"IsOpen"]=!1}}}]);