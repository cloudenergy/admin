"use strict";angular.module("app").controller("SensorIndex",["$rootScope","$scope","$q","$api","$uibModal","SweetAlert","$state",function(l,o,e,a,c,u,n){var t="sensor_index_search",i="sensor_building_selected";o.OnSearch=function(){o.multiCheck.all=!1,a.business.monitor({devicetype:o.DeviceTypes.selected||void 0,building:!o.customer.enable&&o.buildings.selected||void 0,project:l.Project.selected._id,key:o.searchKey||void 0,mode:"SENSOR",usesocity:o.customer.enable||void 0,socitynode:o.customer.enable&&o.customer.selected||void 0,pageindex:o.currentPage||1,pagesize:o.pageSize},function(e){e=e.result[l.Project.selected._id],angular.forEach(e.detail,function(e){this.push(e)},o.viewOfSensor=[]),o.itemsTotal=e.paging.count})},o.multiCheck=function(e){"all"===e?(o.multiCheck.all&&(o.showButton=!0),o.multiCheck.all||(o.showButton=!1),angular.forEach(o.viewOfSensor,function(e){e.isSelected=o.multiCheck.all})):(o.multiCheck.all=!0,o.showButton=!1,angular.forEach(o.viewOfSensor,function(e){e.isSelected||delete o.multiCheck.all,e.isSelected&&(o.showButton=!0)}))},o.multiIds=function(){var n=[];return angular.forEach(o.viewOfSensor,function(e){e.isSelected&&n.push(e.id)}),n},o.DoRemove=function(){var i=o;c.open({size:"md",templateUrl:"sensorDelete.html",controller:["$scope","$uibModalInstance","$api",function(e,n,t){e.cancel=function(){n.dismiss()},e.ok=function(){n.dismiss(),t.sensor.delete({dids:i.multiIds(),projectid:l.Project.selected._id,ctrlcode:(new window.Hashes.SHA1).hex(e.ctrlcode).toUpperCase()},function(){i.OnSearch()},u.error)}}]})},o.currentPage=1,o.pageSize=15,o.searchKey=sessionStorage[t],o.customer={enable:!angular.isDefined(o.customer)||o.customer.enable},e.all([a.customer.info({project:l.Project.selected._id,onlynode:1},function(e){o.customer={enable:o.customer.enable,selected:"ROOT",core:{data:[{id:"ROOT",parent:"#",text:"全部树形结构",state:{selected:!0,opened:!0},icon:"glyphicon glyphicon-th-list"}]},conditionalselect:function(e){return o.customer.selected=e.id,o.OnSearch(),!0},plugins:["search","conditionalselect"]},function n(e,t){angular.forEach(e,function(e){e.parent=t,e.text=e.title,Object.keys(e.child).length?e.icon="glyphicon glyphicon-th-list":e.icon="glyphicon glyphicon-file",n(e.child,e.id),o.customer.core.data.push(e)})}(e.result,"ROOT")},function(){o.customer={enable:o.customer.enable,selected:"ROOT",core:{data:[{id:"ROOT",parent:"#",text:"全部树形结构",state:{selected:!0,opened:!0},icon:"glyphicon glyphicon-th-list"}]},plugins:["search","conditionalselect"]}}).$promise,a.building.info({project:l.Project.selected._id},function(e){var n=sessionStorage[i];o.buildings=[],angular.forEach(e.result.detail,function(e){this.push(e)},o.buildings),o.buildings.select=function(){sessionStorage[i]=o.buildings.selected,o.OnSearch()},angular.forEach(o.buildings,function(e){e.id===n&&(o.buildings.selected=e.id)}),o.buildings.selected=o.buildings.selected||(o.buildings[0]||{}).id},function(){o.buildings=[]}).$promise,a.device.type({project:l.Project.selected._id},function(e){o.DeviceTypes=[{id:void 0,title:"全部设备"}],angular.forEach(e.result,function(e){this.push({id:e.id,title:e.name})},o.DeviceTypes),o.DeviceTypes.selected=o.DeviceTypes.selected||(o.DeviceTypes[0]||{}).id,o.DeviceTypes.select=function(){o.OnSearch()}},function(){o.DeviceTypes=[{id:void 0,title:"全部设备"}]}).$promise]).then(o.OnSearch,function(){o.viewOfSensor=[],o.itemsTotal=0}),o.$watch("currentPage",function(){o.viewOfSensor&&o.OnSearch()}),o.$watch("customer.enable",function(){o.viewOfSensor&&o.OnSearch()}),o.$watch("searchKey",function(e){angular.isDefined(e)&&(sessionStorage[t]=e)}),o.OnMask=function(e){a.sensorchannel.update({id:e.id,mask:!e.mask},function(){e.mask=!e.mask})},o.OnMaskAll=function(n){confirm("是否确定"+(n?"屏蔽":"启用")+"所有通道？")&&angular.forEach(o.viewOfSensor,function(e){angular.forEach(e.channels,function(e){a.sensorchannel.update({id:e.id,mask:n},function(){e.mask=n})})})},o.OnSyncAll=function(){confirm("是否确定同步所有数据异常的智能仪表？")&&a.sensorchannel.syncdata({project:l.Project.selected._id},function(){u.success("同步完成"),o.OnSearch()})},o.OnSensorAttribute=function(n){c.open({templateUrl:"sensorAttribute.html",controller:"sensorAttribute",size:"lg",resolve:{SensorSUID:function(){var e=function(t){if(!t||!t.length)return null;var i={};return _.map({buildingID:10,gatewayID:2,addrID:12,meterID:3,funcID:2},function(e,n){i[n]=t.substr(0,e),t=t.substr(e)}),i}(n.id);return e?e.buildingID+e.gatewayID+e.addrID+e.meterID:null},ProjectID:function(){return l.Project.selected._id}}}).result.then(function(){},function(){})},o.importSensor=function(){var s=o,r=!1;c.open({templateUrl:"importSensor.html",size:"md",controller:["$scope","$timeout","$uibModalInstance","project","building","customer",function(e,n,t,i,o,c){e.wifi={show:!1,equipments:""},e.actionURL="/api/import/equipments",e.project=i,e.building=o,e.customer=c,e.ok=function(){t.close(),e.wifi.show?a.project.bindequipment({projectid:l.Project.selected._id,equipments:e.wifi.equipments},function(){s.OnSearch()}):r&&s.OnSearch()},e.OnUploadComplete=function(e){return e.code?u.error(e.result,e.message):(r=!0,u.success("导入成功")),!1},e.cancel=t.dismiss}],resolve:{project:function(){return l.Project.selected._id},building:function(){return o.buildings.selected},customer:function(){return o.customer.selected}}})},o.exportSensor=function(){delete o.downloadFile,a.export.equipments({projectid:l.Project.selected._id},function(e){e.result.fn&&(o.downloadFile=e.result.fn,o.downloadName=l.Project.selected.title+"_"+n.$current.data.title)})},o.accountChange=function(t,e){c.open({size:"sm",templateUrl:{title:"titleChange.html",tag:"tagChange.html",comi:"comiChange.html"}[e],controller:["$scope","$uibModalInstance",function(e,n){e.sensor=angular.copy(t),e.sensor.did=e.sensor.id,e.title=e.sensor.title,e.tag=e.sensor.tag,e.comi=e.sensor.comi,e.ok=function(){e.sensor.projectid=l.Project.selected._id,a.sensor.update(e.sensor,function(){angular.extend(t,e.sensor),u.success("更新成功")},u.error),e.OnCancel=n.dismiss("cancel")},e.cancel=function(){e.OnCancel=n.dismiss("cancel")}}]})},o.popIsOpen=function(){angular.forEach(o.viewOfSensor,function(e){delete e.titleIsOpen,delete e.tagIsOpen,delete e.comiIsOpen})},o.popover={url:{title:"titleChange.html",tag:"tagChange.html",comi:"comiChange.html"},title:{title:"仪表名称修改",tag:"仪表编码修改",comi:"倍率修改"},ok:function(e,n,t){var i=n+"IsOpen";"comi"==n?t.comi.match(/^(d\*)[1-9][0-9]{0,}$/)?(e[i]=!1,o.sensor=angular.copy(e),o.sensor.projectid=l.Project.selected._id,o.sensor.did=o.sensor.id,o.sensor[n]=t[n],a.sensor.update(o.sensor,function(){e[n]=t[n],u.success("更新成功")},u.error)):u.warning('请以"d*"开头并以不小于1的整数结尾'):(e[i]=!1,o.sensor=angular.copy(e),o.sensor.projectid=l.Project.selected._id,o.sensor.did=o.sensor.id,o.sensor[n]=t[n],a.sensor.update(o.sensor,function(){e[n]=t[n],u.success("更新成功")},u.error))},cancel:function(e,n){e[n+"IsOpen"]=!1}}}]);