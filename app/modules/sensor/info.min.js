"use strict";angular.module("app").controller("SensorIndex",["$rootScope","$scope","$q","$api","$uibModal","$localStorage","UI",function(e,n,t,i,c,o,r){function s(){return i.customer.info({project:e.Project.selected._id,onlynode:1},function(e){n.customer={enable:n.customer.enable,selected:"ROOT",core:{data:[{id:"ROOT",parent:"#",text:"全部社会属性",state:{selected:!0,opened:!0},icon:"glyphicon glyphicon-th-list"}]},conditionalselect:function(e){return n.customer.selected=e.id,n.OnSearch(),!0},plugins:["search","conditionalselect"]},function e(t,i){angular.forEach(t,function(t){t.parent=i,t.text=t.title,Object.keys(t.child).length?t.icon="glyphicon glyphicon-th-list":t.icon="glyphicon glyphicon-file",e(t.child,t.id),n.customer.core.data.push(t)})}(e.result,"ROOT")},function(){n.customer={enable:n.customer.enable,selected:"ROOT",core:{data:[{id:"ROOT",parent:"#",text:"全部社会属性",state:{selected:!0,opened:!0},icon:"glyphicon glyphicon-th-list"}]},plugins:["search","conditionalselect"]}}).$promise}function l(){return i.building.info({project:e.Project.selected._id},function(e){var t=o[f];n.buildings=[],angular.forEach(e.result,function(e){this.push(e)},n.buildings),n.buildings.select=function(){o[f]=n.buildings.selected,n.OnSearch()},angular.forEach(n.buildings,function(e){e._id===t&&(n.buildings.selected=e._id)}),n.buildings.selected=n.buildings.selected||(n.buildings[0]||{})._id}).$promise}function u(){return i.device.type({project:e.Project.selected._id},function(e){n.DeviceTypes=[{id:void 0,title:"全部设备"}],angular.forEach(e.result,function(e){this.push({id:e.id,title:e.name})},n.DeviceTypes),n.DeviceTypes.selected=n.DeviceTypes.selected||(n.DeviceTypes[0]||{}).id,n.DeviceTypes.select=function(){n.OnSearch()}},function(){n.DeviceTypes=[{id:void 0,title:"全部设备"}]}).$promise}function a(e){if(!e||!e.length)return null;var n={};return _.map({buildingID:10,gatewayID:2,addrID:12,meterID:3,funcID:2},function(t,i){n[i]=e.substr(0,t),e=e.substr(t)}),n}var d="sensor_index_search",f="sensor_building_selected";n.OnSearch=function(){i.business.monitor({devicetype:n.DeviceTypes.selected||void 0,building:!n.customer.enable&&n.buildings.selected||void 0,project:e.Project.selected._id,key:n.searchKey||void 0,mode:"SENSOR",usesocity:n.customer.enable||void 0,socitynode:n.customer.enable&&n.customer.selected||void 0,pageindex:n.currentPage||1,pagesize:n.pageSize},function(t){t=t.result[e.Project.selected._id],angular.forEach(t.detail,function(e){this.push(e)},n.viewOfSensor=[]),n.itemsTotal=t.paging.count})},n.currentPage=1,n.pageSize=15,n.searchKey=o[d],n.$watch("$root.Project.selected",function(){n.customer=angular.isDefined(n.customer)?{enable:n.customer.enable}:{enable:!0},n.buildings=[],n.DeviceTypes=[],t.all([s(),l(),u()]).then(n.OnSearch,function(){n.viewOfSensor=[],n.itemsTotal=0})}),n.$watch("currentPage",function(){n.viewOfSensor&&n.OnSearch()}),n.$watch("customer.enable",function(){n.viewOfSensor&&n.OnSearch()}),n.$watch("searchKey",function(e){o[d]=e}),n.OnMask=function(e){i.sensorchannel.update({id:e.id,mask:!e.mask},function(){e.mask=!e.mask})},n.OnMaskAll=function(e){confirm("是否确定"+(e?"屏蔽":"启用")+"所有通道？")&&angular.forEach(n.viewOfSensor,function(n){angular.forEach(n.channels,function(n){i.sensorchannel.update({id:n.id,mask:e},function(){n.mask=e})})})},n.OnSyncAll=function(){confirm("是否确定同步所有数据异常的智能仪表？")&&i.sensorchannel.syncdata({project:e.Project.selected._id},function(){r.AlertSuccess(" ","同步完成"),n.OnSearch()})},n.onRemove=function(e){i.sensorchannel.delete({id:e.id},function(){n.OnSearch()},r.AlertError)},n.OnSensorAttribute=function(n){var t=c.open({templateUrl:"sensorAttribute.html",controller:"sensorAttribute",size:"lg",resolve:{SensorSUID:function(){var e=a(n.id);return e?e.buildingID+e.gatewayID+e.addrID+e.meterID:null},ProjectID:function(){return e.Project.selected._id}}});t.result.then(function(){},function(){})},n.importSensor=function(){var t=n,i=!1;c.open({templateUrl:"importSensor.html",size:"md",controller:["$scope","$timeout","$uibModalInstance","project","building","customer",function(e,n,c,o,s,l){e.actionURL="/api/import/importsensorchannel",e.project=o,e.building=s,e.customer=l,e.ok=function(){c.close(),i&&t.OnSearch()},e.OnUploadComplete=function(e){return e.code?r.AlertError(e.result||" ",e.message):(i=!0,r.AlertSuccess("导入成功")),!1},e.cancel=c.dismiss}],resolve:{project:function(){return e.Project.selected._id},building:function(){return n.buildings.selected},customer:function(){return n.customer.selected}}})},n.AlertInfo=function(){r.AlertInfo.apply(r,arguments)}}]);