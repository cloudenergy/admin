"use strict";angular.module("app").controller("SensorIndex",["$rootScope","$scope","$q","$api","$uibModal","UI",function(e,n,t,i,c,o){function r(){return i.customer.info({project:e.Project.selected._id,onlynode:1},function(e){n.customer={enable:n.customer.enable,selected:"ROOT",core:{data:[{id:"ROOT",parent:"#",text:"全部社会属性",state:{selected:!0,opened:!0},icon:"glyphicon glyphicon-th-list"}]},conditionalselect:function(e){return n.customer.selected=e.id,n.OnSearch(),!0},plugins:["search","conditionalselect"]},function e(t,i){angular.forEach(t,function(t){t.parent=i,t.text=t.title,Object.keys(t.child).length?t.icon="glyphicon glyphicon-th-list":t.icon="glyphicon glyphicon-file",e(t.child,t.id),n.customer.core.data.push(t)})}(e.result,"ROOT")}).$promise}function s(){return i.building.info({project:e.Project.selected._id},function(e){var t="sensor.building",i=o.GetPageItem(t);n.buildings=[],angular.forEach(e.result,function(e){this.push(e)},n.buildings),n.buildings.select=function(){o.PutPageItem(t,n.buildings.selected),n.OnSearch()},angular.forEach(n.buildings,function(e){e._id===i&&(n.buildings.selected=e._id)}),n.buildings.selected=n.buildings.selected||(n.buildings[0]||{})._id}).$promise}function u(){return i.device.type({project:e.Project.selected._id},function(e){n.DeviceTypes=[{id:void 0,title:"全部设备"}],angular.forEach(e.result,function(e){this.push({id:e.id,title:e.name})},n.DeviceTypes),n.DeviceTypes.selected=n.DeviceTypes.selected||(n.DeviceTypes[0]||{}).id,n.DeviceTypes.select=function(){n.OnSearch()}}).$promise}function l(){i.business.monitor({devicetype:n.DeviceTypes.selected||void 0,building:!n.customer.enable&&n.buildings.selected||void 0,project:e.Project.selected._id,key:o.GetPageItem(d)||void 0,mode:"SENSOR",usesocity:n.customer.enable||void 0,socitynode:n.customer.enable&&n.customer.selected||void 0,pageindex:n.currentPage,pagesize:n.pageSize},function(t){t=t.result[e.Project.selected._id],angular.forEach(t.detail,function(e){this.push(e)},n.viewOfSensor=[]),n.itemsTotal=t.paging.count})}function a(e){if(!e||!e.length)return null;var n={};return _.map({buildingID:10,gatewayID:2,addrID:12,meterID:3,funcID:2},function(t,i){n[i]=e.substr(0,t),e=e.substr(t)}),n}var d="sensor_index_search";n.currentPage=o.GetPageIndex(),n.pageSize=15,n.$watch("$root.Project.selected",function(){n.customer=angular.isDefined(n.customer)?{enable:n.customer.enable}:{enable:!0},n.buildings=[],n.DeviceTypes=[],t.all([r(),s(),u()]).then(n.OnSearch)}),n.$watch("currentPage",function(e){return void 0==e?void(n.currentPage=o.GetPageIndex()):(o.PutPageIndex(void 0,n.currentPage),void(n.viewOfSensor&&n.OnSearch()))}),n.$watch("customer.enable",function(){n.viewOfSensor&&n.OnSearch()}),n.OnSearch=function(){o.PutPageItem(d,n.searchKey),l()},n.OnMask=function(e){i.sensorchannel.update({id:e.id,mask:!e.mask},function(){e.mask=!e.mask})},n.OnMaskAll=function(e){confirm("是否确定"+(e?"屏蔽":"启用")+"所有通道？")&&angular.forEach(n.viewOfSensor,function(n){angular.forEach(n.channels,function(n){i.sensorchannel.update({id:n.id,mask:e},function(){n.mask=e})})})},n.OnSyncAll=function(){confirm("是否确定同步所有数据异常的传感器？")&&i.sensorchannel.syncdata({project:e.Project.selected._id},function(){o.AlertSuccess(" ","同步完成"),n.OnSearch()})},n.onRemove=function(e,n){i.sensorchannel.delete({id:e.id},function(){delete n.channels[e.funcid]},function(e){o.AlertError(e.message)})},n.OnSensorAttribute=function(n){var t=c.open({templateUrl:"sensorAttribute.html",controller:"sensorAttribute",size:"lg",resolve:{SensorSUID:function(){var e=a(n.id);return e?e.buildingID+e.gatewayID+e.addrID+e.meterID:null},ProjectID:function(){return e.Project.selected._id}}});t.result.then(function(){},function(){})},n.importSensor=function(){var t=n,i=!1;c.open({templateUrl:"importSensor.html",size:"md",controller:["$scope","$timeout","$uibModalInstance","project","building","customer",function(e,n,c,r,s,u){e.actionURL="/api/import/importsensorchannel",e.project=r,e.building=s,e.customer=u,e.ok=function(){c.close(),i&&t.OnSearch()},e.OnUploadComplete=function(e){return e.code?o.AlertError(e.result||" ",e.message):(i=!0,o.AlertSuccess("导入成功")),!1},e.cancel=c.dismiss}],resolve:{project:function(){return e.Project.selected._id},building:function(){return n.buildings.selected},customer:function(){return n.customer.selected}}})},n.AlertInfo=function(){o.AlertInfo.apply(o,arguments)}}]);