"use strict";angular.module("app").controller("accountroleres",["$rootScope","$scope","$stateParams","$q","$uibModal","$state","$api","SweetAlert",function(t,o,e,r,s,i,c,n){var u=e.id;o.askingRemoveID=null,r.all([c.account.info({id:t.User.data._id}).$promise,c.account.info({id:u}).$promise]).then(function(e){o.adminUser=e[0].result,o.editUser=e[1].result,o.editUser&&(o.editUser.resource||(o.editUser.resource={project:[],sensor:[],building:[],customer:[]}),o.roleResOfProject=t.Project,o.editUser.resource&&o.editUser.resource.project&&(o.viewOfEditUserProject=[],_.each(o.editUser.resource.project,function(r){var e=_.find(t.Project,function(e){return e._id==r});e&&o.viewOfEditUserProject.push(e)})))}),o.SaveRoleRes=function(){o.editUser.resource.project.length?(_.map(o.editUser.resource,function(e,r){_.isEmpty(e)&&(o.editUser.resource[r]="*")}),o.editUser.resource.empty=!1):o.editUser.resource={empty:!0},c.account.update({id:o.editUser._id,resource:o.editUser.resource},function(){n.success("权限修改成功"),i.go("admin.account.info")},function(e){n.error(e).then(function(){i.reload()})})},o.AddProject=function(){s.open({templateUrl:"projectSelect.html",controller:"ProjectSelect",size:"md",resolve:{Projects:function(){return o.roleResOfProject},ProjectIDs:function(){return o.editUser.resource&&o.editUser.resource.project||[]}}}).result.then(function(e){_.isArray(e)?(o.viewOfEditUserProject&&o.viewOfEditUserProject.length?o.viewOfEditUserProject=_.union(o.viewOfEditUserProject,e):o.viewOfEditUserProject=e,o.editUser.resource.project=[],_.each(o.viewOfEditUserProject,function(e){o.editUser.resource.project.push(e._id)})):("*"==e._id&&(o.viewOfEditUserProject=[]),o.editUser.resource.project=o.adminUser.resource.project,o.viewOfEditUserProject=o.roleResOfProject)},function(){})},o.AddBuildings=function(e,t){e.preventDefault(),s.open({templateUrl:"buildingSelect.html",controller:"BuildingSelect",size:"md",resolve:{ProjectID:function(){return t},BuildingIDs:function(){return o.editUser.resource&&o.editUser.resource.building||[]}}}).result.then(function(e){if("*"==e.select){var r=[];_.each(o.editUser.resource.building,function(e){-1==e.indexOf(t)&&r.push(e)}),o.editUser.resource.building=r}else o.editUser.resource.building=_.difference(o.editUser.resource.building,e.unselect),o.editUser.resource.building=_.union(o.editUser.resource.building,e.select)})},o.AddSensors=function(e,t){e.preventDefault(),s.open({templateUrl:"sensorSelect.html",controller:"SensorSelect",size:"lg",resolve:{ProjectID:function(){return t},SensorIDs:function(){return o.editUser.resource&&o.editUser.resource.sensor||[]}}}).result.then(function(e){if("*"==e.select){var r=[];_.each(o.editUser.resource.sensor,function(e){-1==e.indexOf(t)&&r.push(e)}),o.editUser.resource.sensor=r}else o.editUser.resource.sensor=_.difference(o.editUser.resource.sensor,e.unselect),o.editUser.resource.sensor=_.union(o.editUser.resource.sensor,e.select)},function(){})},o.DoRemove=function(e,r,t){e.preventDefault(),o.editUser.resource.project=_.without(o.editUser.resource.project,r),o.viewOfEditUserProject.splice(t,1),o.editUser.resource.project=_.without(o.editUser.resource.project,r),o.askingRemoveID=null,angular.forEach(o.roleResOfProject,function(e){o.editUser.resource.project.indexOf(e._id)&&(e.isEnable=!1)})},o.AskForRemove=function(e,r){e.preventDefault(),o.askingRemoveID=r},o.CancelRemove=function(e,r){e.preventDefault(),o.askingRemoveID=void 0}}]);