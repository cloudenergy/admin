"use strict";angular.module("app").controller("accountroleres",["$scope","$stateParams","$q","$uibModal","$cookies","$state","$api","Auth",function(e,r,t,o,s,i,c,n){var u;n.Check(function(){e.askingRemoveID=null;var n=s.user,d=r.id;void 0!=n&&null!=n&&t.all([c.account.info({id:n}).$promise,c.account.info({id:d}).$promise]).then(function(r){e.adminUser=r[0].result,e.editUser=r[1].result,e.editUser&&(e.editUser.resource||(e.editUser.resource={project:[],sensor:[],building:[],customer:[]}),u=e.editUser.resource.project||[],e.roleResOfProject=e.Project,e.editUser.resource&&e.editUser.resource.project&&(e.viewOfEditUserProject=[],_.each(e.editUser.resource.project,function(r){var t=_.find(e.Project,function(e){return e._id==r});t&&e.viewOfEditUserProject.push(t)})))}),e.SaveRoleRes=function(){_.difference(e.editUser.resource.project,_.intersection(u,e.editUser.resource.project)),_.difference(u,_.intersection(e.editUser.resource.project,u));e.editUser.resource.project.length?(_.map(e.editUser.resource,function(r,t){_.isEmpty(r)&&(e.editUser.resource[t]="*")}),e.editUser.resource.empty=!1):e.editUser.resource={empty:!0},c.account.update({id:e.editUser._id,resource:e.editUser.resource},function(){i.go("admin.account.info")})},e.AddProject=function(){o.open({templateUrl:"projectSelect.html",controller:"ProjectSelect",size:"md",resolve:{Projects:function(){return e.roleResOfProject},ProjectIDs:function(){return e.editUser.resource&&e.editUser.resource.project||[]}}}).result.then(function(r){_.isArray(r)?(e.viewOfEditUserProject&&e.viewOfEditUserProject.length?e.viewOfEditUserProject=_.union(e.viewOfEditUserProject,r):e.viewOfEditUserProject=r,e.editUser.resource.project=[],_.each(e.viewOfEditUserProject,function(r){e.editUser.resource.project.push(r._id)})):("*"==r._id&&(e.viewOfEditUserProject=[]),e.editUser.resource.project=e.adminUser.resource.project,e.viewOfEditUserProject=e.roleResOfProject)},function(){})},e.AddBuildings=function(r,t){r.preventDefault(),o.open({templateUrl:"buildingSelect.html",controller:"BuildingSelect",size:"md",resolve:{ProjectID:function(){return t},BuildingIDs:function(){return e.editUser.resource&&e.editUser.resource.building||[]}}}).result.then(function(r){if("*"==r.select){var o=[];_.each(e.editUser.resource.building,function(e){e.indexOf(t)==-1&&o.push(e)}),e.editUser.resource.building=o}else e.editUser.resource.building=_.difference(e.editUser.resource.building,r.unselect),e.editUser.resource.building=_.union(e.editUser.resource.building,r.select)},function(){})},e.AddSensors=function(r,t){r.preventDefault(),o.open({templateUrl:"sensorSelect.html",controller:"SensorSelect",size:"lg",resolve:{ProjectID:function(){return t},SensorIDs:function(){return e.editUser.resource&&e.editUser.resource.sensor||[]}}}).result.then(function(r){if("*"==r.select){var o=[];_.each(e.editUser.resource.sensor,function(e){e.indexOf(t)==-1&&o.push(e)}),e.editUser.resource.sensor=o}else e.editUser.resource.sensor=_.difference(e.editUser.resource.sensor,r.unselect),e.editUser.resource.sensor=_.union(e.editUser.resource.sensor,r.select)},function(){})},e.DoRemove=function(r,t,o){r.preventDefault(),e.editUser.resource.project=_.without(e.editUser.resource.project,t),e.viewOfEditUserProject.splice(o,1),e.editUser.resource.project=_.without(e.editUser.resource.project,t),e.askingRemoveID=null},e.AskForRemove=function(r,t){r.preventDefault(),e.askingRemoveID=t},e.CancelRemove=function(r,t){r.preventDefault(),e.askingRemoveID=void 0}})}]);