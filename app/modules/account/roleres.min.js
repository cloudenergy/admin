"use strict";angular.module("app").controller("accountroleres",["$rootScope","$scope","$stateParams","$q","$uibModal","$cookies","$state","$api",function(e,r,t,o,s,i,c,n){var u,d=i.user,l=t.id;r.askingRemoveID=null,void 0!=d&&null!=d&&o.all([n.account.info({id:d}).$promise,n.account.info({id:l}).$promise]).then(function(t){r.adminUser=t[0].result,r.editUser=t[1].result,r.editUser&&(r.editUser.resource||(r.editUser.resource={project:[],sensor:[],building:[],customer:[]}),u=r.editUser.resource.project||[],r.roleResOfProject=e.Project,r.editUser.resource&&r.editUser.resource.project&&(r.viewOfEditUserProject=[],_.each(r.editUser.resource.project,function(t){var o=_.find(e.Project,function(e){return e._id==t});o&&r.viewOfEditUserProject.push(o)})))}),r.SaveRoleRes=function(){_.difference(r.editUser.resource.project,_.intersection(u,r.editUser.resource.project)),_.difference(u,_.intersection(r.editUser.resource.project,u));r.editUser.resource.project.length?(_.map(r.editUser.resource,function(e,t){_.isEmpty(e)&&(r.editUser.resource[t]="*")}),r.editUser.resource.empty=!1):r.editUser.resource={empty:!0},n.account.update({id:r.editUser._id,resource:r.editUser.resource},function(){c.go("admin.account.info")})},r.AddProject=function(){s.open({templateUrl:"projectSelect.html",controller:"ProjectSelect",size:"md",resolve:{Projects:function(){return r.roleResOfProject},ProjectIDs:function(){return r.editUser.resource&&r.editUser.resource.project||[]}}}).result.then(function(e){_.isArray(e)?(r.viewOfEditUserProject&&r.viewOfEditUserProject.length?r.viewOfEditUserProject=_.union(r.viewOfEditUserProject,e):r.viewOfEditUserProject=e,r.editUser.resource.project=[],_.each(r.viewOfEditUserProject,function(e){r.editUser.resource.project.push(e._id)})):("*"==e._id&&(r.viewOfEditUserProject=[]),r.editUser.resource.project=r.adminUser.resource.project,r.viewOfEditUserProject=r.roleResOfProject)},function(){})},r.AddBuildings=function(e,t){e.preventDefault(),s.open({templateUrl:"buildingSelect.html",controller:"BuildingSelect",size:"md",resolve:{ProjectID:function(){return t},BuildingIDs:function(){return r.editUser.resource&&r.editUser.resource.building||[]}}}).result.then(function(e){if("*"==e.select){var o=[];_.each(r.editUser.resource.building,function(e){e.indexOf(t)==-1&&o.push(e)}),r.editUser.resource.building=o}else r.editUser.resource.building=_.difference(r.editUser.resource.building,e.unselect),r.editUser.resource.building=_.union(r.editUser.resource.building,e.select)},function(){})},r.AddSensors=function(e,t){e.preventDefault(),s.open({templateUrl:"sensorSelect.html",controller:"SensorSelect",size:"lg",resolve:{ProjectID:function(){return t},SensorIDs:function(){return r.editUser.resource&&r.editUser.resource.sensor||[]}}}).result.then(function(e){if("*"==e.select){var o=[];_.each(r.editUser.resource.sensor,function(e){e.indexOf(t)==-1&&o.push(e)}),r.editUser.resource.sensor=o}else r.editUser.resource.sensor=_.difference(r.editUser.resource.sensor,e.unselect),r.editUser.resource.sensor=_.union(r.editUser.resource.sensor,e.select)},function(){})},r.DoRemove=function(e,t,o){e.preventDefault(),r.editUser.resource.project=_.without(r.editUser.resource.project,t),r.viewOfEditUserProject.splice(o,1),r.editUser.resource.project=_.without(r.editUser.resource.project,t),r.askingRemoveID=null},r.AskForRemove=function(e,t){e.preventDefault(),r.askingRemoveID=t},r.CancelRemove=function(e,t){e.preventDefault(),r.askingRemoveID=void 0}}]);