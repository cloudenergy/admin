"use strict";angular.module("app").component("analyticAttribute",{templateUrl:"app/modules/byitem/index.html?rev=d58fd1f753",controller:["$rootScope","$api","$uibModal","$stateParams","$timeout","SweetAlert",function(a,e,t,i,n,o){var r=this;r.changeSensor=function(n){t.open({backdrop:"static",component:"sensor",size:"lg",resolve:{projectid:function(){return a.Project.selected._id},selected:function(){return n.key}}}).result.then(function(t){r.addsensor=function(){e.eca.update({projectid:a.Project.selected._id,node:{id:n.id,key:t,title:n.title,parent:n.parent,variables:{AREA:n.formula.variables.AREA,PERSON:n.formula.variables.PERSON},formula:"",type:i.type},method:"UPDATE"},function(){r.originData=angular.copy(r.itemData),r.loadData().finally(function(){angular.forEach(r.itemData,function(a){angular.forEach(r.originData,function(e){e.showChildren&&a.id==e.id&&(a.showChildren=e.showChildren)})})})})},n.key=t,n.id&&r.addsensor(),!n.id&&r.save("child",n,"ADD")})},r.loadData=function(){return e.eca.info({projectid:a.Project.selected._id,type:i.type},function(t){r.itemData=t.result,!r.sensor&&e.sensor.info({project:a.Project.selected._id,SHOWALL:!0},function(a){angular.forEach(r.itemData,function(e){e.childArray=[],angular.forEach(e.child,function(t){e.childArray.push(t),angular.forEach(r.sensor=a.result.detail,function(a){a.did==t.key&&(t.sensorName=a.title)})})})}),r.sensor&&angular.forEach(r.itemData,function(a){a.childArray=[],angular.forEach(a.child,function(e){a.childArray.push(e),angular.forEach(r.sensor,function(a){a.did==e.key&&(e.sensorName=a.title)})})})},function(a){r.itemData=a.result}).$promise},r.loadData(),r.addnode=function(a,e){"root"==a?r.itemData.push({title:"",type:i.type,formula:{formula:"",variables:{AREA:"",PERSON:""}}}):e.childArray.push({title:"",type:i.type,parent:e.id,formula:{formula:"",variables:{AREA:"",PERSON:""}}})},r.cancel=function(a,e){a.splice(e,1)},r.delete=function(t,i){e.eca.update({projectid:a.Project.selected._id,node:{id:t.id},method:"REMOVE"},function(){r.originData=angular.copy(r.itemData),r.loadData().finally(function(){angular.forEach(r.itemData,function(a){angular.forEach(r.originData,function(e){e.showChildren&&a.id==e.id&&(a.showChildren=e.showChildren)})})})})},r.save=function(t,n,l){e.eca.update({projectid:a.Project.selected._id,node:{id:n.id,key:n.key,title:n.title,parent:"child"==t&&n.parent||void 0,variables:{AREA:n.formula.variables.AREA,PERSON:n.formula.variables.PERSON},formula:"child"!=t&&n.formula.formula||"",type:i.type},method:l},function(){r.originData=angular.copy(r.itemData),r.loadData().finally(function(){angular.forEach(r.itemData,function(a){angular.forEach(r.originData,function(e){e.showChildren&&a.id==e.id&&(a.showChildren=e.showChildren)})})})},function(){o.info("请填写完整参数")}).finally(function(){n.key&&r.addsensor(n)})}}]});