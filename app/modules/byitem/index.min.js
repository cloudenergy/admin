"use strict";angular.module("app").component("analyticAttribute",{templateUrl:"app/modules/byitem/index.html?rev=2db341baab",controller:["$rootScope","$api","$uibModal","$stateParams","$timeout","SweetAlert",function(a,e,t,n,i,o){var r=this;r.type=n.type,r.changeSensor=function(i){t.open({backdrop:"static",component:"sensor",size:"lg",resolve:{projectid:function(){return a.Project.selected._id},selected:function(){return angular.equals(i.child,{})&&i||i.child}}}).result.then(function(t){console.log(t),r.addsensor=function(){1==t.removeItems.length&&1==t.addItems.length&&e.eca.update({projectid:a.Project.selected._id,node:{id:i.id,key:t.addItems.did,title:i.title,parent:i.parent,formula:{variables:{AREA:i.formula.variables.AREA,PERSON:i.formula.variables.PERSON},formula:i.formula.formula},type:n.type},method:"UPDATE"},function(){r.originData=angular.copy(r.itemData),r.loadData().finally(function(){angular.forEach(r.itemData,function(a){angular.forEach(r.originData,function(e){e.showChildren&&a.id==e.id&&(a.showChildren=e.showChildren)})})})}),t.addItems.length>=1&&1!=t.removeItems.length&&angular.forEach(t.addItems,function(a){r.add(a,a.title,i.id)}),t.removeItems.length>=1&&1!=t.addItems.length&&angular.forEach(t.removeItems,function(a){angular.forEach(i.child,function(e){e.key==a.did&&r.delete(e)})})},i.id&&r.addsensor(),!i.id&&r.save("child",i,"ADD")})},r.loadData=function(){return e.eca.info({projectid:a.Project.selected._id,type:n.type},function(a){r.itemData=a.result,angular.forEach(r.itemData,function(a){a.childArray=[],angular.forEach(a.child,function(e){e.addrid=e.key.substring(12,24),a.childArray.push(e)})})},function(a){r.itemData=a.result}).$promise},r.loadData(),r.addnode=function(a,e){"root"==a?r.itemData.push({title:"",type:n.type,formula:{formula:"",variables:{AREA:"",PERSON:""}}}):e.childArray.push({title:"",type:n.type,parent:e.id,formula:{formula:"",variables:{AREA:"",PERSON:""}}})},r.cancel=function(a,e){a.splice(e,1)},r.delete=function(t,n){e.eca.update({projectid:a.Project.selected._id,node:{id:t.id},method:"REMOVE"},function(){r.originData=angular.copy(r.itemData),r.loadData().finally(function(){angular.forEach(r.itemData,function(a){angular.forEach(r.originData,function(e){e.showChildren&&a.id==e.id&&(a.showChildren=e.showChildren)})})})})},r.refresh=function(){e.eca.refresh({projectid:a.Project.selected._id,type:n.type},function(){r.loadData()})},r.save=function(t,i,l,d){e.eca.update({projectid:a.Project.selected._id,node:{id:i.id,key:i.key,title:i.title,parent:"child"==t&&i.parent||void 0,formula:{variables:{AREA:i.formula.variables&&i.formula.variables.AREA,PERSON:i.formula.variables&&i.formula.variables.PERSON},formula:i.formula.formula||""},enable:angular.isUndefined(d)&&i.enable||d,type:n.type},method:l},function(){r.originData=angular.copy(r.itemData),r.loadData().finally(function(){angular.forEach(r.itemData,function(a){angular.forEach(r.originData,function(e){e.showChildren&&a.id==e.id&&(a.showChildren=e.showChildren)})})})},function(){o.info("请填写完整参数")}).$promise.finally(function(){})},r.add=function(t,i,l){console.log(t,i,l),e.eca.update({projectid:a.Project.selected._id,node:{title:i,key:t.did,parent:l,type:n.type},method:"ADD"},function(){r.originData=angular.copy(r.itemData),r.loadData().finally(function(){angular.forEach(r.itemData,function(a){angular.forEach(r.originData,function(e){e.showChildren&&a.id==e.id&&(a.showChildren=e.showChildren)})})})},function(){o.info("请填写完整参数")}).$promise.finally(function(){})}}]});