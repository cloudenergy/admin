"use strict";angular.module("app").controller("Property.withdraw",["$scope","$filter","$api","$timeout","$uibModal","UI",function(t,e,n,c,a,o){function u(){n.business.accountbalance({project:EMAPP.Project.selected._id},function(t){r.accountbalance=t.result,r.accountbalance.total=e("number")(r.accountbalance.cash+r.accountbalance.frozen,2),r.accountbalance.cash=e("number")(r.accountbalance.cash,2),r.accountbalance.frozen=e("number")(r.accountbalance.frozen,2),r.accountbalance.earning=e("number")(r.accountbalance.earning,2),r.accountbalance.withdraw=e("number")(r.accountbalance.withdraw,2)}),n.channelaccount.info({project:EMAPP.Project.selected._id,all:!0,flow:"EXPENSE",status:"SUCCESS"},function(t){r.cardData=t.result})}var l,r=this;r.cardSelected=null,r.calAmount=function(){l&&c.cancel(l),l=c(function(){r.amount=r.amount&&e("number")(1*r.amount,2)||r.amount},666)},r.inject=function(){return r.amount&&(r.amount=e("number")(1*r.amount,2)),!(!r.cardSelected||!r.amount)&&void n.payment.handlingcharge({channelaccount:r.cardSelected.id,amount:r.amount},function(t){r.fee=t.result.amount,a.open({templateUrl:"withdraw_request_confirmation.html",controllerAs:"self",controller:["$uibModalInstance","data",function(t,e){this.submit=function(){t.close(this.detail)},this.cancel=function(){t.dismiss("cancel")},this.detail=e,this.detail.timecreate=moment().unix(),this.detail.applicant=EMAPP.Account._id}],resolve:{data:function(){return{card:r.cardSelected,amount:r.amount,fee:r.fee,project:EMAPP.Project.selected._id}}},size:"md"}).result.then(function(t){n.withdraw.apply({project:t.project,amount:t.amount,channelaccount:t.card.id},function(){delete r.amount,delete r.cardSelected,o.AlertSuccess("已提交成功"),u()},function(t){o.AlertError(t.message)})})})},t.$watch("Project.selected",u)}]);