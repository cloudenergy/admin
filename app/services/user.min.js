"use strict";angular.module("app").service("User",["$rootScope","$q","$localStorage","$api","$storage","MENUCONFIG",function(e,t,r,o,n,c){var u={};angular.extend(e.User=this,{data:void 0,$account:function(r){var a=t.defer();return o.account.info(r||{id:n.get("uid")},function(t){angular.extend(u,e.Account=t.result),function t(r,o,n){angular.forEach(r,function(r,c){"leaf"!==c&&(r.leaf?(o[c]=!0,e.Rule.$state[n.concat([c]).join(".")]=!0):(n.length>1&&(e.Rule.$state[n.concat([c]).join(".")]=!0),t(r,o[c]=o[c]||{},n.concat([c]))))})}(e.Account.character.rule["/"],e.Rule={$state:{}},[]),angular.forEach(c,function(t){(t.ignore||e.Rule.$state[t.state])&&this.push(t)},e.Menu=[]),a.resolve(e.Account)},a.reject),a.promise},$project:function(c){var u=t.defer();return o.project.info(c||{},function(t){var c=n.get("uid")+"_root_project_selected";!e.Project&&e.$watch("$root.Project.selected",function(e){e&&(r[c]=e._id)}),angular.forEach(e.Project=angular.isArray(t.result)?t.result:[t.result],function(t){e.Project[t._id]=t}),e.Project.selected=e.Project[r[c]]||e.Project[0],o.auth.restree({projectid:e.Project.selected._id}),u.resolve(e.Project)},u.reject),u.promise},$userinfo:function(){return t.all([e.User.$account(),e.User.$project()]).then(function(){e.User.data=u})},$login:function(r){r=r||{};var c=t.defer(),a=Object.keys(r).length,i=r.remember;return delete r.remember,o.auth.login(r,function(t){u=t.result,a&&n.set(u,i),e.User.$userinfo().then(function(){c.resolve(u)},function(e){n.set(null),c.reject(e)})},c.reject),c.promise},$logout:function(t){return o.auth.logout(t||{},function(){delete e.User.data,n.set(null)}).$promise}})}]);