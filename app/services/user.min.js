"use strict";angular.module("app").service("User",["$rootScope","$q","$state","$api","$fundebug","$storage","MENUCONFIG",function(e,t,r,n,o,a,u){var c,s={};e.$watch("$root.Project.selected",function(t){c&&t&&(localStorage[c]=t._id,e.Rule&&e.User.$resource().then(function(){r.reload()}))}),angular.extend(e.User=this,{data:void 0,$account:function(r){var o=t.defer();return n.account.info(r||{id:a.get("uid")},function(t){t.result&&Object.keys(t.result).length?(angular.extend(s,e.Account=t.result),o.resolve(e.Account)):o.reject(t)},o.reject),o.promise},$project:function(r){var o=t.defer();return n.project.info(r||{},function(t){t.result&&Object.keys(t.result).length?(c=a.get("uid")+"_root_project_selected",angular.forEach(e.Project=angular.isArray(t.result)?t.result:[t.result],function(t){e.Project[t._id]=t}),e.Project.selected=e.Project[localStorage[c]]||e.Project[0],e.User.$resource().then(function(){o.resolve(e.Project)},o.reject)):o.reject(t)},o.reject),o.promise},$resource:function(){return n.auth.resource({projectid:e.Project.selected._id},function(t){!function t(r,n,o){angular.forEach(r,function(r,a){"leaf"!==a&&(r.leaf?(n[a]=!0,e.Rule.$state[o.concat([a]).join(".")]=!0):(o.length>1&&(e.Rule.$state[o.concat([a]).join(".")]=!0),t(r,n[a]=n[a]||{},o.concat([a]))))})}(t.result,e.Rule={$state:{}},[]),angular.forEach(u,function(t){t.ignore||e.Rule.$state[t.state]?(this.push(t),this[t.state]=t):e.Rule.$state["admin.byitem.index"]&&'admin.byitem.index({type:"BYITEM"})'==t.state?(this.push(t),this[t.state]=t):e.Rule.$state["admin.bycategory.index"]&&'admin.bycategory.index({type:"BYCATEGORY"})'==t.state?(this.push(t),this[t.state]=t):e.Rule.$state["admin.byapart.index"]&&'admin.byapart.index({type:"BYAPART"})'==t.state&&(this.push(t),this[t.state]=t)},e.Menu=[])}).$promise},$userinfo:function(){return t.all([e.User.$account(),e.User.$project()]).then(function(){e.User.data=s;var t=angular.copy(s);delete t.character.rule,o.metaData({UserData:t})})},$login:function(r){r=r||{};var o=t.defer(),u=Object.keys(r).length,c=r.remember;return delete r.remember,n.auth.login(r,function(t){s=t.result,u&&a.set(s,c),e.User.$userinfo().then(function(){o.resolve(s)},function(e){a.set(null),o.reject(e)})},o.reject),o.promise},$logout:function(t){return n.auth.logout(t||{},function(){delete e.User.data,delete e.Project,delete e.Rule,delete e.Menu,a.set(null)}).$promise}})}]);