"use strict";angular.module("app").service("User",["$rootScope","$q","$state","$localStorage","$api","$storage","MENUCONFIG",function(e,t,r,n,o,c,u){var a={};angular.extend(e.User=this,{data:void 0,$account:function(r){var n=t.defer();return o.account.info(r||{id:c.get("uid")},function(t){angular.extend(a,e.Account=t.result),n.resolve(e.Account)},n.reject),n.promise},$project:function(u){var a=t.defer();return o.project.info(u||{},function(t){var o=c.get("uid")+"_root_project_selected";!e.Project&&e.$watch("$root.Project.selected",function(t){t&&(n[o]=t._id,e.Rule&&e.User.$resource().then(function(){r.reload()}))}),angular.forEach(e.Project=angular.isArray(t.result)?t.result:[t.result],function(t){e.Project[t._id]=t}),e.Project.selected=e.Project[n[o]]||e.Project[0],e.User.$resource().then(function(){a.resolve(e.Project)},a.reject)},a.reject),a.promise},$resource:function(){return o.auth.resource({projectid:e.Project.selected._id},function(t){!function t(r,n,o){angular.forEach(r,function(r,c){"leaf"!==c&&(r.leaf?(n[c]=!0,e.Rule.$state[o.concat([c]).join(".")]=!0):(o.length>1&&(e.Rule.$state[o.concat([c]).join(".")]=!0),t(r,n[c]=n[c]||{},o.concat([c]))))})}(t.result,e.Rule={$state:{}},[]),angular.forEach(u,function(t){(t.ignore||e.Rule.$state[t.state])&&(this.push(t),this[t.state]=t)},e.Menu=[])}).$promise},$userinfo:function(){return t.all([e.User.$account(),e.User.$project()]).then(function(){e.User.data=a})},$login:function(r){r=r||{};var n=t.defer(),u=Object.keys(r).length,s=r.remember;return delete r.remember,o.auth.login(r,function(t){a=t.result,u&&c.set(a,s),e.User.$userinfo().then(function(){n.resolve(a)},function(e){c.set(null),n.reject(e)})},n.reject),n.promise},$logout:function(t){return o.auth.logout(t||{},function(){delete e.User.data,c.set(null)}).$promise}})}]);