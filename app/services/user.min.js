"use strict";angular.module("app").service("User",["$rootScope","$q","$cookies","$localStorage","$api","MENUCONFIG",function(e,t,o,r,n,a){var c={},u=/cloudenergy\.me/.test(location.hostname)?".cloudenergy.me":location.hostname;angular.extend(e.User=this,{data:void 0,$account:function(o){var r=t.defer();return n.account.info(o||{id:c.uid},function(t){angular.extend(c,e.Account=t.result),function t(o,r,n){angular.forEach(o,function(o,a){"leaf"!==a&&(o.leaf?(r[a]=!0,e.Rule.$state[n.concat([a]).join(".")]=!0):(n.length>1&&(e.Rule.$state[n.concat([a]).join(".")]=!0),t(o,r[a]=r[a]||{},n.concat([a]))))})}(e.Account.character.rule["/"].admin,e.Rule={$state:{}},["admin"]),angular.forEach(a,function(t){(t.ignore||e.Rule.$state[t.state])&&this.push(t)},e.Menu=[]),r.resolve(e.Account)},r.reject),r.promise},$project:function(o){var a=t.defer();return n.project.info(o||{},function(t){var o=c.uid+"_root_project_selected";!e.Project&&e.$watch("$root.Project.selected",function(e){e&&(r[o]=e._id)}),angular.forEach(e.Project=angular.isArray(t.result)?t.result:[t.result],function(t){e.Project[t._id]=t}),e.Project.selected=e.Project[r[o]]||e.Project[0],a.resolve(e.Project)},a.reject),a.promise},$login:function(r){r=r||{};var a=t.defer(),i=Object.keys(r).length,l=r.remember;return delete r.remember,n.auth.login(r,function(r){c=r.result,i&&angular.forEach(["token","uid","user"],function(e){c[e]&&o.put(e,c[e]||!1,{path:"/",domain:u,expires:l&&moment().add(1,"months")._d||void 0})}),t.all([e.User.$account(),e.User.$project()]).then(function(){a.resolve(e.User.data=c)},a.reject)},a.reject),a.promise},$logout:function(r){var a=t.defer();return n.auth.logout(r||{},function(){delete e.User.data,angular.forEach(["token","uid","user"],function(e){o.remove(e,{path:"/",domain:u}),o.remove(e,{path:"/",domain:"admin"+u}),o.remove(e,{path:"/",domain:".admin"+u})}),a.resolve()},a.reject),a.promise}})}]);