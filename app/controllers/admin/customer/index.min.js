angular.module("app").controller("CustomerIndex",["$scope","$q","$api","$uibModal","Auth","UI",function(e,t,i,n,o,r){o.Check(function(){function o(e,t,i){var n=[];return t&&(angular.forEach(t,function(t){t.originid=t.id,t.origintitle=t.title,t.id=t.id,t.title=t.title,t.acreage=t.acreage||0,t.level=i,t.nodes=o(t,t.child,i+1),t.parent=e,n.push(t)}),n.sort(function(e,t){return e.index>t.index?1:-1})),n}function l(){i.customer.info({project:e.Project.selected._id},function(t){t.result?e.viewOfCustomer=[{level:0,type:"NODE",title:"社会属性",nodes:o(null,t.result,1)}]:e.viewOfCustomer=[{level:0,type:"NODE",title:"社会属性",nodes:[]}]},function(e){r.AlertError(e.data.message)})}e.$watch("Project.selected",l),e.newNode=function(e){e.nodes.push({enable:!0,editing:!0,title:"",origintitle:"",acreage:0,level:e.level+1,type:"NODE",parent:e,nodes:[]})},e.saveNode=function(t){return t.title?(delete t.editing,t.origintitle=t.originid?t.origintitle:t.title,void i.customer.update({node:{id:t.id||void 0,title:t.title,type:t.id?t.type:"NODE",parent:t.parent.id},method:t.id?"UPDATE":"ADD",project:e.Project.selected._id},function(e){r.AlertSuccess(t.id?"更新成功":"添加成功"),t.id||(t.id=t.originid=e.result.id,t.origintitle=t.title)})):(r.AlertWarning("请输入名称"),!1)},e.editNode=function(e){e.origintitle=e.title,e.editing=!0},e.cancelEdit=function(e){e.id?e.title=e.origintitle:angular.forEach(e.parent.nodes,function(t){t.$$hashKey!==e.$$hashKey&&this.push(t)},e.parent.nodes=[]),delete e.editing},e.deleteNode=function(t,n){i.customer.update({node:{id:t.id},method:"REMOVE",project:e.Project.selected._id},function(e){r.AlertSuccess("删除成功"),n.remove()})},e.sensor=function(o){n.open({templateUrl:"sensorSelect.html",controller:"SensorSelect",resolve:{ProjectID:function(){return e.Project.selected._id},SelectKEY:function(){return function e(t,i){return angular.forEach(t,function(t){"DEV"===t.type?i[t.key]=1:e(t.nodes,i)}),i}(o.nodes,{})}}}).result.then(function(n){var r=[],l={};!function t(o){angular.forEach(o,function(o){"DEV"===o.type?0===n[o.key]&&r.push(i.customer.update({node:{id:o.id},method:"REMOVE",project:e.Project.selected._id},function(){l[o.id]=!0}).$promise):t(o.nodes)})}(o.nodes),angular.forEach(n,function(t,n){t&&angular.isString(t)&&r.push(i.customer.update({node:{type:"DEV",title:t,key:n,parent:o.id},method:"ADD",project:e.Project.selected._id},function(e){o.nodes.push({originid:e.result.id,origintitle:e.result.title,id:e.result.id,title:e.result.title,acreage:0,level:o.level+1,type:"DEV",key:e.result.key,parent:o,nodes:[]})}).$promise)}),t.all(r).then(function(){!function e(t){angular.forEach(t.nodes,function(t){!l[t.id]&&this.push(t),t.nodes.length&&e(t)},t.nodes=[])}(o)})})}})}]);
//# sourceMappingURL=index.min.js.map
