angular.module("app").controller("Property.index",["$scope","$api","$uibModal",function(e,t,n){function a(){t.business.accountbalance({project:EMAPP.Project.selected._id},function(e){r.accountbalance=e.result||{},r.accountbalance.total=Math.round(100*(r.accountbalance.cash+r.accountbalance.frozen))/100,r.accountbalance.cash=Math.round(100*r.accountbalance.cash)/100,r.accountbalance.frozen=Math.round(100*r.accountbalance.frozen)/100,r.accountbalance.earning=Math.round(100*r.accountbalance.earning)/100,r.accountbalance.withdraw=Math.round(100*r.accountbalance.withdraw)/100})}function c(){t.channelaccount.info({project:EMAPP.Project.selected._id,all:!0,flow:"EXPENSE"},function(e){r.cardInfo=e.result&&e.result[0]||{},r.cardInfo.timecreate=r.cardInfo.timecreate&&moment(1e3*r.cardInfo.timecreate).format("YYYY-M-DD H:mm:ss")||"",r.cardInfo.timeenable=r.cardInfo.timeenable&&moment(1e3*r.cardInfo.timeenable).format("YYYY-M-DD H:mm:ss")||"",r.cardInfo.timeexpire=r.cardInfo.timeexpire&&moment(1e3*r.cardInfo.timeexpire).format("YYYY-M-DD H:mm:ss")||"",r.cardInfo.tail=(r.cardInfo.account||"").replace(/\d+(\d{4})$/,"$1")})}function i(){t.business.projectfundflowstatistic({time:r.viewDate.replace(/\-/g,""),project:EMAPP.Project.selected._id},function(e){e=e.result||{},e.earning&&angular.forEach(e.earning.category,function(e,t){this.push(angular.extend(e,{name:t}))},e.earning.category=[]),e.expenses&&angular.forEach(e.expenses.category,function(e,t){this.push(angular.extend(e,{category:t}))},e.expenses.category=[]),e.consumption&&angular.forEach(e.consumption.category,function(e,t){this.push(angular.extend(e,{category:t}))},e.consumption.category=[]),r.fundflowstatistic=e})}function o(){t.business.fundflow({project:EMAPP.Project.selected._id,from:r.viewDate.replace(/\-/g,"")+"01",to:moment(r.viewDate.replace(/\-/g,"")+"01","YYYYMMDD").add(1,"month").subtract(1,"day").format("YYYYMMDD"),pageindex:1,pagesize:6},function(e){r.fundflow=e.result.detail,angular.forEach(r.fundflow,function(e){e.channelaccount&&e.channelaccount.account&&(e.channelaccount.tail=e.channelaccount.account.replace(/\d+(\d{4})$/,"$1")),e.timecreate=e.timecreate&&moment(1e3*e.timecreate).format("YYYY-M-DD H:mm:ss")||"",e.timecheck=e.timecheck&&moment(1e3*e.timecheck).format("YYYY-M-DD H:mm:ss")||"",e.timepaid=e.timepaid&&moment(1e3*e.timepaid).format("YYYY-M-DD H:mm:ss")||""})})}var r=this;r.deviceType=[{key:"ELECTRICITYMETER",title:"电表",icon:"emfinance finance-electricity text-warning"},{key:"COLDWATERMETER",title:"冷水表",icon:"emfinance finance-water text-info"},{key:"HOTWATERMETER",title:"热水表",icon:"emfinance finance-water text-danger"},{key:"ENERGYMETER",title:"能量表",icon:"emfinance finance-power text-danger"},{key:"TEMPRATURECONTROL",title:"温控器",icon:"emfinance finance-temprature text-info"}],angular.forEach(r.deviceType,function(e){this[e.key]=e},r.deviceType),r.category=[{key:"RECHARGING",title:"充值"},{key:"PAYFEES",title:"缴费"},{key:"HANDLINGCHARGE",title:"手续费"},{key:"WITHDRAW",icon:"emfinance finance-withdraw text-danger",title:"提现"},{key:"HANDLINGCHARGERCG",icon:"emfinance finance-serve text-warning",title:"充值服务费"},{key:"HANDLINGCHARGEWTD",icon:"emfinance finance-serve text-warning",title:"提现服务费"},{key:"alipay",icon:"emfinance finance-alipay text-info",title:"支付宝手机支付"},{key:"wx",icon:"emfinance finance-wechat text-success",title:"微信支付"},{key:"wx_pub",icon:"emfinance finance-wechat-official text-success",title:"微信公众号支付"},{key:"bankcard",icon:"emfinance finance-unionpay text-primary",title:"银行卡支付"}],angular.forEach(r.category,function(e){this[e.key]=e},r.category),r.format="YYYY-MM",r.viewDate=moment().format(r.format),e.$watch("self.viewDate",function(e){r.fundflow&&(i(),o())}),e.$watch("Project.selected",function(e){a(),c(),i(),o()}),r.getCard=function(e){t.bank.info(function(t){n.open({templateUrl:"modal-property-card.html",controllerAs:"self",controller:["$api","$uibModalInstance",function(n,a){this.bankData=t.result,this.card=e&&angular.copy(e)||{},this.card.locate=angular.isString(this.card.locate)&&JSON.parse(this.card.locate||null)||this.card.locate||{province:"浙江省",city:"杭州市",district:"西湖区"},angular.forEach(this.bankData,$.proxy(function(e){this.bankData[e.id]=e,this.card.origin===e.title&&(this.card.origin=e.id)},this)),this.submit=function(){n.channelaccount.add({id:this.card.id||void 0,flow:this.card.flow||"EXPENSE",belongto:this.card.belongto?void 0:EMAPP.Project.selected._id,name:this.card.name,account:this.card.account,type:this.card.origin,origin:this.bankData[this.card.origin].title,subbranch:this.card.subbranch,locate:this.card.locate},a.close)},this.cancel=function(){a.dismiss("cancel")}}]}).result.then(c)})},r.removeCard=function(e){swal({title:"确认删除此项吗？",text:"卡号："+e.account,type:"warning",showCancelButton:!0,cancelButtonText:"取消",confirmButtonText:"确认",confirmButtonColor:"#ec6c62"},function(){t.channelaccount["delete"]({id:e.id},c)})}}]);
//# sourceMappingURL=index.min.js.map
