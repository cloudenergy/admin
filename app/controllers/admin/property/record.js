angular.module("app").controller("Property.record",["$scope","$api","$filter","$state","$stateParams","$timeout","$q","uiGridConstants",function(e,t,i,a,n,l,s,d){var r=this,o=new Date;r.tab=n.tab||"all",r.projectid=n.projectid,r.searchText="",r.startDate=i("date")(o,"yyyy-MM-01"),r.endDate=i("date")(o,"yyyy-MM-dd"),$("#start_date,#end_date").bind("dp.change",function(e){l(function(){e.date&&e.oldDate&&r.list()})}),r.status=[{key:"CHECKING",title:"等待审核","class":"primary"},{key:"CHECKFAILED",title:"审核失败","class":"warning"},{key:"PROCESSING",title:"正在处理","class":"info"},{key:"FAILED",title:"处理失败","class":"danger"},{key:"SUCCESS",title:"完成","class":"success"}],angular.forEach(r.status,function(e){this[e.key]={title:e.title,"class":e["class"]}},r.status),t.project.info({id:r.projectid},function(e){r.projectname=e.result.title,a.$current.parent.data.title="物业财务 - "+e.result.title}),r.filter=function(){r.gridOptions.enableFiltering=!r.gridOptions.enableFiltering,r.gridApi.core.notifyDataChange(d.dataChange.COLUMN)},r["export"]=function(){r.gridOptions.exporterCsvFilename=(r.projectname?r.projectname+"_":"")+{all:"收支明细","in":"收入",out:"支出"}[r.tab]+"_"+r.startDate.replace(/\-/g,"")+"_"+r.endDate.replace(/\-/g,"")+".csv",r.gridApi.exporter.csvExport("visible","visible",angular.element(document.querySelectorAll(".subContent")))},r.list=function(e){if(!(e&&r.gridOptions.paging&&r.gridOptions.paging.count<=r.gridOptions.paging.pageindex*r.gridOptions.paging.pagesize)){var a={project:r.projectid||void 0,key:r.searchText||void 0,from:r.startDate.replace(/\-/g,""),to:r.endDate.replace(/\-/g,""),pageindex:(e&&r.gridOptions.paging?r.gridOptions.paging.pageindex:0)+1,pagesize:100};return"in"==r.tab&&(a.flow="EARNING",r.gridOptions.columnDefs=p),"all"==r.tab&&(r.gridOptions.columnDefs=p),"out"==r.tab&&(a.flow="EXPENSE",r.gridOptions.columnDefs=c),r.status.selected&&(a.status=r.status.selected),t.business.fundflow(a,function(t){return t=t.result||{},angular.forEach(t.detail,function(e){e.timepaid=e.timepaid&&i("date")(1e3*e.timepaid,"yyyy-M-dd H:mm:ss")||"",e.timecreate=e.timecreate&&i("date")(1e3*e.timecreate,"yyyy-M-dd H:mm:ss")||""}),e?r.gridOptions.data=r.gridOptions.data.concat(t.detail||[]):(r.gridOptions.data=t.detail||[],r.gridOptions.data.length&&l(function(){r.gridApi.core.scrollTo(r.gridOptions.data[0],r.gridOptions.columnDefs[0])})),r.gridOptions.paging=t.paging,l(function(){r.paneHeight=90}),r.gridApi.grid.element.height("auto"),t}).$promise}};var c=[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">序号</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"交易金额 ¥",name:"amount",width:"*",minWidth:120,cellTemplate:'<div class="ui-grid-cell-contents" ng-class="{\'text-danger\': COL_FIELD>0, \'text-success\': COL_FIELD<0}" ng-if="COL_FIELD" ng-bind="COL_FIELD"></div>'},{displayName:"交易类型",name:"category",width:"*",minWidth:100,enableColumnMenu:!1},{displayName:"交易状态",name:"status",width:"*",minWidth:100,enableColumnMenu:!1,cellTemplate:'<div class="ui-grid-cell-contents text-{{grid.appScope.self.status[COL_FIELD].class}}" ng-bind="grid.appScope.self.status[COL_FIELD].title"></div>'},{displayName:"到账时间",name:"timepaid",width:"*",minWidth:200},{displayName:"操作帐号",name:"operator",minWidth:100},{displayName:"操作后余额",name:"balance",minWidth:100,cellTemplate:"<div class=\"ui-grid-cell-contents\">{{COL_FIELD||'-'}}</div>"},{displayName:"提交时间",name:"timecreate",width:"*",minWidth:200,enableColumnMenu:!1},{displayName:"跟踪",name:"operation",cellTemplate:'<a href="">查看详情</a>'}],p=[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">序号</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"交易金额 ¥",name:"amount",width:"*",minWidth:120,headerCellTemplate:function(){var e=EMAPP.templateCache.get("ui-grid/uiGridHeaderCell");return"in"!==r.tab?e:e.replace('</sub></span></div><div role="button" tabindex="0"','</sub></span><div class="text-info">合计：{{grid.appScope.self.sum.amount}}</div></div><div role="button" tabindex="0"')},cellTemplate:'<div class="ui-grid-cell-contents" ng-class="{\'text-danger\': COL_FIELD<0, \'text-success\': COL_FIELD>0}" ng-if="COL_FIELD" ng-bind="COL_FIELD"></div>'},{displayName:"操作后余额",name:"balance",cellTemplate:"<div class=\"ui-grid-cell-contents\">{{COL_FIELD||'-'}}</div>"},{displayName:"交易类型",name:"category",width:"*",minWidth:100,enableColumnMenu:!1},{displayName:"交易状态",name:"status",width:"*",minWidth:100,enableColumnMenu:!1,cellTemplate:'<div class="ui-grid-cell-contents text-{{grid.appScope.self.status[COL_FIELD].class}}" ng-bind="grid.appScope.self.status[COL_FIELD].title"></div>'},{displayName:"提交时间",name:"timecreate",width:"*",minWidth:200,enableColumnMenu:!1}];r.gridRowChanged=function(){r.sum={amount:0,balance:0},angular.forEach(r.gridApi.core.getVisibleRows(r.gridApi.grid),function(e){"SUCCESS"===e.entity.status&&(r.sum.amount=Math.round(100*(r.sum.amount+e.entity.amount))/100,r.sum.balance=Math.round(100*(r.sum.balance+e.entity.balance))/100)})},r.gridOptions={onRegisterApi:function(t){t.core.on.rowsRendered(e,r.gridRowChanged),t.infiniteScroll.on.needLoadMoreData(e,function(){var e=s.defer(),i=e.resolve,a=function(){t.infiniteScroll.dataLoaded(),e.reject()};return function(e){e?e.then(function(){t.infiniteScroll.saveScrollPercentage(),t.infiniteScroll.dataLoaded(!1,!0).then(i,a)},a):a()}(r.list(!0)),e.promise}),r.gridApi=t},infiniteScrollDown:!0,enableColumnResizing:!0,exporterOlderExcelCompatibility:!0,exporterFieldCallback:function(e,t,i,a){return/status/.test(i.field)&&(a=r.status[a]&&r.status[a].title||""),0===a?0:'="'+(a||"")+'"'},columnDefs:c},r.list()}]);