angular.module("app").controller("Property.index",["$api","$filter","$location","$state","$stateParams","$uibModal","UI",function(t,c,a,e,n,o,r){function i(){t.business.fundflow({project:s.projects.selected||void 0,from:moment().subtract(7,"day").format("YYYYMMDD"),to:moment().format("YYYYMMDD"),pageindex:1,pagesize:10},function(t){s.fundflows=t.result.detail})}var s=this;s.projectid=n.projectid,s.projects=[],s.projects.select=function(){e.go(e.current.name,{projectid:s.projects.selected},{reload:!0})},s.getCardList=function(){t.channelaccount.info({project:s.projects.selected,all:!0,flow:"EXPENSE"},function(t){s.cardData=t.result||[]})},s.getCard=function(c){t.bank.info(function(t){o.open({templateUrl:"modal-property-card.html",controllerAs:"self",controller:["$api","$uibModalInstance","UI",function(a,e,n){this.bankData=t.result,this.card=c||{},this.card.locate=angular.isString(this.card.locate)&&JSON.parse(this.card.locate||null)||this.card.locate||{province:"浙江省",city:"杭州市",district:"西湖区"},angular.forEach(this.bankData,$.proxy(function(t){this.bankData[t.id]=t,this.card.origin===t.title&&(this.card.origin=t.id)},this)),this.submit=function(){a.channelaccount.add({id:this.card.id||void 0,flow:this.card.flow||"EXPENSE",belongto:this.card.belongto?void 0:s.projects.selected,name:this.card.name,account:this.card.account,origin:this.bankData[this.card.origin].title,subbranch:this.card.subbranch,locate:this.card.locate},e.close)},this.cancel=function(){e.dismiss("cancel")}}]}).result.then(s.getCardList)})},s.removeCard=function(c){swal({title:"确认删除此项吗？",text:"卡号："+c.account,type:"warning",showCancelButton:!0,cancelButtonText:"取消",confirmButtonText:"确认",confirmButtonColor:"#ec6c62"},function(){t.channelaccount["delete"]({id:c.id},s.getCardList)})},t.project.info(function(c){c.result=angular.isArray(c.result)?c.result:[c.result],angular.forEach(c.result,function(t){this.push(t),this[t._id]=t},s.projects),s.projects.length&&(angular.forEach(s.projects,function(t){t._id===s.projectid&&(s.projects.selected=t._id)}),s.projects.selected=s.projects.selected||s.projects[0]._id,e.$current.data.title="物业财务 - "+s.projects[s.projects.selected].title,s.getCardList(),i(),t.business.accountbalance({project:s.projects.selected},function(t){s.accountbalance=t.result||{},s.accountbalance.total=Math.round(100*(s.accountbalance.cash+s.accountbalance.frozen))/100,s.accountbalance.cash=Math.round(100*s.accountbalance.cash)/100,s.accountbalance.frozen=Math.round(100*s.accountbalance.frozen)/100,s.accountbalance.earning=Math.round(100*s.accountbalance.earning)/100,s.accountbalance.withdraw=Math.round(100*s.accountbalance.withdraw)/100}))})}]);