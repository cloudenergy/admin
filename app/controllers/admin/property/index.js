angular.module("app").controller("Property.index",["$scope","$api","$filter","$state","$stateParams","$uibModal",function(e,t,c,n,a,i){function o(){t.business.accountbalance({project:u.projects.selected},function(e){u.accountbalance=e.result||{},u.accountbalance.total=Math.round(100*(u.accountbalance.cash+u.accountbalance.frozen))/100,u.accountbalance.cash=Math.round(100*u.accountbalance.cash)/100,u.accountbalance.frozen=Math.round(100*u.accountbalance.frozen)/100,u.accountbalance.earning=Math.round(100*u.accountbalance.earning)/100,u.accountbalance.withdraw=Math.round(100*u.accountbalance.withdraw)/100})}function r(){t.channelaccount.info({project:u.projects.selected,all:!0,flow:"EXPENSE"},function(e){u.cardInfo=e.result&&e.result[0]||{},u.cardInfo.tail=(u.cardInfo.account||"").replace(/\d+(\d{4})$/,"$1")})}function l(){t.business.projectfundflowstatistic({time:u.viewDate.replace(/\-/g,""),project:u.projects.selected},function(e){e=e.result||{},angular.forEach(e.earning.category,function(e,t){this.push(angular.extend(e,{name:t}))},e.earning.category=[]),angular.forEach(e.expenses.category,function(e,t){this.push(angular.extend(e,{category:t}))},e.expenses.category=[]),angular.forEach(e.consumption.category,function(e,t){this.push(angular.extend(e,{category:t}))},e.consumption.category=[]),u.fundflowstatistic=e})}function s(){t.business.fundflow({project:u.projects.selected,from:u.viewDate.replace(/\-/g,"")+"01",to:moment(u.viewDate.replace(/\-/g,"")+"01","YYYYMMDD").add(1,"month").subtract(1,"day").format("YYYYMMDD"),pageindex:1,pagesize:6},function(e){u.fundflow=e.result.detail,angular.forEach(u.fundflow,function(e){e.channelaccount&&e.channelaccount.account&&(e.channelaccount.tail=e.channelaccount.account.replace(/\d+(\d{4})$/,"$1")),e.timecreate=e.timecreate&&c("date")(1e3*e.timecreate,"yyyy-M-dd H:mm:ss")||"",e.timecheck=e.timecheck&&c("date")(1e3*e.timecheck,"yyyy-M-dd H:mm:ss")||"",e.timepaid=e.timepaid&&c("date")(1e3*e.timepaid,"yyyy-M-dd H:mm:ss")||""})})}var u=this,d=EMAPP.Account._id+"_property_index_projectid";u.projectid=a.projectid,u.deviceType=[{key:"ELECTRICITYMETER",title:"电表",icon:"emfinance finance-electricity text-warning"},{key:"COLDWATERMETER",title:"冷水表",icon:"emfinance finance-water text-info"},{key:"HOTWATERMETER",title:"热水表",icon:"emfinance finance-water text-danger"},{key:"ENERGYMETER",title:"能量表",icon:"emfinance finance-power text-danger"},{key:"TEMPRATURECONTROL",title:"温控器",icon:"emfinance finance-temprature text-info"}],angular.forEach(u.deviceType,function(e){this[e.key]=e},u.deviceType),u.category=[{key:"RECHARGING",title:"充值"},{key:"PAYFEES",title:"缴费"},{key:"HANDLINGCHARGE",title:"手续费"},{key:"WITHDRAW",icon:"emfinance finance-withdraw text-danger",title:"提现"},{key:"HANDLINGCHARGERCG",icon:"emfinance finance-serve text-warning",title:"充值服务费"},{key:"HANDLINGCHARGEWTD",icon:"emfinance finance-serve text-warning",title:"提现服务费"},{key:"alipay",icon:"emfinance finance-alipay text-info",title:"支付宝手机支付"},{key:"wx",icon:"emfinance finance-wechat text-success",title:"微信支付"},{key:"wx_pub",icon:"emfinance finance-wechat-official text-success",title:"微信公众号支付"},{key:"bankcard",icon:"emfinance finance-unionpay text-primary",title:"银行卡支付"}],angular.forEach(u.category,function(e){this[e.key]=e},u.category),u.format="YYYY-MM",u.viewDate=moment().format(u.format),e.$watch(function(){return u.viewDate},function(e){u.projects.length&&(l(),s())}),u.projects=[],u.projects.select=function(){localStorage.setItem(d,u.projects.selected),n.go(n.current.name,{projectid:u.projects.selected},{reload:!0})},t.project.info(function(e){e.result=angular.isArray(e.result)?e.result:[e.result],angular.forEach(e.result,function(e){this.push(e),this[e._id]=e},u.projects),u.projects.length&&(!u.projectid&&u.projects.length>1&&localStorage.getItem(d)&&(u.projectid=localStorage.getItem(d)),angular.forEach(u.projects,function(e){e._id===u.projectid&&(u.projects.selected=e._id)}),u.projects.selected=u.projects.selected||u.projects[0]._id,n.$current.data.title="物业财务 - "+u.projects[u.projects.selected].title,o(),r(),l(),s())}),u.getCard=function(e){t.bank.info(function(t){i.open({templateUrl:"modal-property-card.html",controllerAs:"self",controller:["$api","$uibModalInstance",function(c,n){this.bankData=t.result,this.card=e&&angular.copy(e)||{},this.card.locate=angular.isString(this.card.locate)&&JSON.parse(this.card.locate||null)||this.card.locate||{province:"浙江省",city:"杭州市",district:"西湖区"},angular.forEach(this.bankData,$.proxy(function(e){this.bankData[e.id]=e,this.card.origin===e.title&&(this.card.origin=e.id)},this)),this.submit=function(){c.channelaccount.add({id:this.card.id||void 0,flow:this.card.flow||"EXPENSE",belongto:this.card.belongto?void 0:u.projects.selected,name:this.card.name,account:this.card.account,type:this.card.origin,origin:this.bankData[this.card.origin].title,subbranch:this.card.subbranch,locate:this.card.locate},n.close)},this.cancel=function(){n.dismiss("cancel")}}]}).result.then(r)})},u.removeCard=function(e){swal({title:"确认删除此项吗？",text:"卡号："+e.account,type:"warning",showCancelButton:!0,cancelButtonText:"取消",confirmButtonText:"确认",confirmButtonColor:"#ec6c62"},function(){t.channelaccount["delete"]({id:e.id},r)})}}]);