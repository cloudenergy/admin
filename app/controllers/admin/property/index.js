angular.module("app").controller("Property.index",["$scope","$api","$state","$stateParams","$uibModal",function(e,t,n,c,a){function o(){t.business.accountbalance({project:s.projects.selected},function(e){s.accountbalance=e.result||{},s.accountbalance.total=Math.round(100*(s.accountbalance.cash+s.accountbalance.frozen))/100,s.accountbalance.cash=Math.round(100*s.accountbalance.cash)/100,s.accountbalance.frozen=Math.round(100*s.accountbalance.frozen)/100,s.accountbalance.earning=Math.round(100*s.accountbalance.earning)/100,s.accountbalance.withdraw=Math.round(100*s.accountbalance.withdraw)/100})}function i(){t.channelaccount.info({project:s.projects.selected,all:!0,flow:"EXPENSE"},function(e){s.cardInfo=e.result&&e.result[0]||{},s.cardInfo.timecreate=s.cardInfo.timecreate&&moment(1e3*s.cardInfo.timecreate).format("YYYY-M-DD H:mm:ss")||"",s.cardInfo.timeenable=s.cardInfo.timeenable&&moment(1e3*s.cardInfo.timeenable).format("YYYY-M-DD H:mm:ss")||"",s.cardInfo.timeexpire=s.cardInfo.timeexpire&&moment(1e3*s.cardInfo.timeexpire).format("YYYY-M-DD H:mm:ss")||"",s.cardInfo.tail=(s.cardInfo.account||"").replace(/\d+(\d{4})$/,"$1")})}function r(){t.business.projectfundflowstatistic({time:s.viewDate.replace(/\-/g,""),project:s.projects.selected},function(e){e=e.result||{},angular.forEach(e.earning.category,function(e,t){this.push(angular.extend(e,{name:t}))},e.earning.category=[]),angular.forEach(e.expenses.category,function(e,t){this.push(angular.extend(e,{category:t}))},e.expenses.category=[]),angular.forEach(e.consumption.category,function(e,t){this.push(angular.extend(e,{category:t}))},e.consumption.category=[]),s.fundflowstatistic=e})}function l(){t.business.fundflow({project:s.projects.selected,from:s.viewDate.replace(/\-/g,"")+"01",to:moment(s.viewDate.replace(/\-/g,"")+"01","YYYYMMDD").add(1,"month").subtract(1,"day").format("YYYYMMDD"),pageindex:1,pagesize:6},function(e){s.fundflow=e.result.detail,angular.forEach(s.fundflow,function(e){e.channelaccount&&e.channelaccount.account&&(e.channelaccount.tail=e.channelaccount.account.replace(/\d+(\d{4})$/,"$1")),e.timecreate=e.timecreate&&moment(1e3*e.timecreate).format("YYYY-M-DD H:mm:ss")||"",e.timecheck=e.timecheck&&moment(1e3*e.timecheck).format("YYYY-M-DD H:mm:ss")||"",e.timepaid=e.timepaid&&moment(1e3*e.timepaid).format("YYYY-M-DD H:mm:ss")||""})})}var s=this,u=EMAPP.Account._id+"_property_index_projectid";s.projectid=c.projectid,s.deviceType=[{key:"ELECTRICITYMETER",title:"电表",icon:"emfinance finance-electricity text-warning"},{key:"COLDWATERMETER",title:"冷水表",icon:"emfinance finance-water text-info"},{key:"HOTWATERMETER",title:"热水表",icon:"emfinance finance-water text-danger"},{key:"ENERGYMETER",title:"能量表",icon:"emfinance finance-power text-danger"},{key:"TEMPRATURECONTROL",title:"温控器",icon:"emfinance finance-temprature text-info"}],angular.forEach(s.deviceType,function(e){this[e.key]=e},s.deviceType),s.category=[{key:"RECHARGING",title:"充值"},{key:"PAYFEES",title:"缴费"},{key:"HANDLINGCHARGE",title:"手续费"},{key:"WITHDRAW",icon:"emfinance finance-withdraw text-danger",title:"提现"},{key:"HANDLINGCHARGERCG",icon:"emfinance finance-serve text-warning",title:"充值服务费"},{key:"HANDLINGCHARGEWTD",icon:"emfinance finance-serve text-warning",title:"提现服务费"},{key:"alipay",icon:"emfinance finance-alipay text-info",title:"支付宝手机支付"},{key:"wx",icon:"emfinance finance-wechat text-success",title:"微信支付"},{key:"wx_pub",icon:"emfinance finance-wechat-official text-success",title:"微信公众号支付"},{key:"bankcard",icon:"emfinance finance-unionpay text-primary",title:"银行卡支付"}],angular.forEach(s.category,function(e){this[e.key]=e},s.category),s.format="YYYY-MM",s.viewDate=moment().format(s.format),e.$watch(function(){return s.viewDate},function(e){s.projects.length&&(r(),l())}),s.projects=[],s.projects.select=function(){localStorage.setItem(u,s.projects.selected),n.go(n.current.name,{projectid:s.projects.selected},{reload:!0})},t.project.info(function(e){e.result=angular.isArray(e.result)?e.result:[e.result],angular.forEach(e.result,function(e){this.push(e),this[e._id]=e},s.projects),s.projects.length&&(!s.projectid&&s.projects.length>1&&localStorage.getItem(u)&&(s.projectid=localStorage.getItem(u)),angular.forEach(s.projects,function(e){e._id===s.projectid&&(s.projects.selected=e._id)}),s.projects.selected=s.projects.selected||s.projects[0]._id,n.$current.data.title="物业财务 - "+s.projects[s.projects.selected].title,o(),i(),r(),l())}),s.getCard=function(e){t.bank.info(function(t){a.open({templateUrl:"modal-property-card.html",controllerAs:"self",controller:["$api","$uibModalInstance",function(n,c){this.bankData=t.result,this.card=e&&angular.copy(e)||{},this.card.locate=angular.isString(this.card.locate)&&JSON.parse(this.card.locate||null)||this.card.locate||{province:"浙江省",city:"杭州市",district:"西湖区"},angular.forEach(this.bankData,$.proxy(function(e){this.bankData[e.id]=e,this.card.origin===e.title&&(this.card.origin=e.id)},this)),this.submit=function(){n.channelaccount.add({id:this.card.id||void 0,flow:this.card.flow||"EXPENSE",belongto:this.card.belongto?void 0:s.projects.selected,name:this.card.name,account:this.card.account,type:this.card.origin,origin:this.bankData[this.card.origin].title,subbranch:this.card.subbranch,locate:this.card.locate},c.close)},this.cancel=function(){c.dismiss("cancel")}}]}).result.then(i)})},s.removeCard=function(e){swal({title:"确认删除此项吗？",text:"卡号："+e.account,type:"warning",showCancelButton:!0,cancelButtonText:"取消",confirmButtonText:"确认",confirmButtonColor:"#ec6c62"},function(){t.channelaccount["delete"]({id:e.id},i)})}}]);