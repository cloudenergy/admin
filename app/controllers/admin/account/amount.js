angular.module("app").controller("accountamount",["$scope","$stateParams","Account","API","Auth","UI","BillingAccount","Log","Payment","channels",function(n,c,e,t,o,r,a,u,i,l){n.channels=l.result,n.AccountID=c.account,n.Redirect=decodeURIComponent(c.redirect||"/admin/account/info"),o.Check(function(){function o(){t.Query(e.info,{id:n.AccountID},function(c){c.err||(n.account=c.result,n.account.billingAccount.cash=Math.round(100*n.account.billingAccount.cash)/100,n.account.billingAccount.frozen=Math.round(100*n.account.billingAccount.frozen)/100,n.account.billingAccount.expire?(n.expire=moment(n.account.billingAccount.expire),n.expire=n.expire.format("YYYY年MM月DD日")):n.expire="无限制")})}function l(){t.Query(u.charge,{uid:n.AccountID,channel:"manual"},function(c){c.err||(n.chargeLog=c.result)})}o(),l(),n.OnCharge=function(){if(!n.cash)return r.AlertWarning(" ","请输入充值金额");if(!n.channels.selected)return r.AlertWarning(" ","请选择充值方式");var e={uid:n.account._id,channel:"Manual",amount:parseFloat(n.cash),channelaccountid:n.channels.selected,project:c.project,subject:"商户项目充值",body:"充值项目: "+c.project,metadata:{operator:EMAPP.Account._id}};t.Query(i.charge,e,function(c){c.code?r.AlertError(" ","充值出错"):(o(),l(),n.cash=0,c.result.fn&&(n.downloadLink="/download/"+c.result.fn,window.open(n.downloadLink)))})},n.OnReverse=function(n){t.Query(i.reversal,{id:n._id,time:moment(n.timecreate).unix(),type:"CHARGE"},function(n){n.err?r.AlertError(" ","冲正出错: "+n.err.message):(o(),l())})},n.OnSaveAlerthreshold=function(){var c={account:n.account.billingAccount._id,alerthreshold:n.account.billingAccount.alerthreshold};t.Query(a.update,c,function(n){})}})}]);