EMAPP.register.controller("accountamount",["$scope","$cookies","$stateParams","Account","API","Auth","BillingAccount","Log","Payment","channels",function(n,e,c,o,t,r,a,u,i,l){n.channels=l.result,n.AccountID=c.account,n.Redirect=decodeURIComponent(c.redirect||"/admin/account/info"),r.Check(function(){function r(){t.Query(o.info,{id:n.AccountID},function(e){e.err||(n.account=e.result,n.account.billingAccount.cash=Math.round(100*n.account.billingAccount.cash)/100,n.account.billingAccount.frozen=Math.round(100*n.account.billingAccount.frozen)/100,n.account.billingAccount.expire?(n.expire=moment(n.account.billingAccount.expire),n.expire=n.expire.format("YYYY年MM月DD日")):n.expire="无限制")})}function l(){t.Query(u.charge,{uid:n.AccountID,channel:"manual"},function(e){e.err||(n.chargeLog=e.result)})}r(),l(),n.OnCharge=function(){if(!n.selectedChannel)return alert("请选择充值渠道");var o=parseFloat(n.cash),a={uid:n.account._id,channel:"Manual",amount:o,channelaccountid:n.selectedChannel,project:c.project,subject:"商户项目充值",body:"充值项目: "+c.project,metadata:{operator:e.get("user")}};t.Query(i.charge,a,function(e){e.code?swal("错误","充值出错","error"):(r(),l(),n.cash=0,e.result.fn&&(n.downloadLink="/download/"+e.result.fn,window.open(n.downloadLink)))})},n.OnReverse=function(n){t.Query(i.reversal,{id:n._id,time:moment(n.timecreate).unix(),type:"CHARGE"},function(n){n.err?swal("错误","冲正出错: "+n.err.message,"error"):(r(),l())})},n.OnSaveAlerthreshold=function(){var e={account:n.account.billingAccount._id,alerthreshold:n.account.billingAccount.alerthreshold};t.Query(a.update,e,function(n){})}})}]);