angular.module("app").controller("EnergyIndex",["$scope","$q","$uibModal","Energy","API","Auth","Project","UI","Energycategory","base64","Sensor",function(e,t,n,i,r,o,c,l,u,d,s){var a="energy.project",g={},f={};o.Check(function(){function o(e){return d.encode(e)}function y(e,t){return e&&e.id&&e.id.length?e.id+"|"+o(t):o(t)}function p(e,t,n){if(t){var i=[];return _.each(t,function(t){t.childrens?t.ischild=!1:t.ischild=!0,t.originid=t.id,t.origintitle=t.title,t.parent=e,t.level=n,t.nodes=p(t,t.childrens,n+1),i.push(t)}),i.sort(function(e,t){return e.title>t.title?1:-1}),i}}function h(t){g={},f={},e.projects.selected=t,r.Query(i.info,{project:t},function(t){if(t.err);else{var n=t.result.energy;n||(n={}),_.each(e.energycategory,function(e){n[e._id]||(n[e._id]={id:e._id,childrens:[],ischild:!1});var t=n[e._id];t.unit=e.unit,t.standcol=e.standcol,t.title=e.title}),e.energycategory.sort(function(e,t){return e.title>t.title?1:-1});var i=p(null,n,1);e.viewOfEnergy=[{nodes:i,title:"能耗分类",level:0}]}},v)}function v(e){l.AlertError(e.data.message)}e.doSaveEnergy=function(t){t.preventDefault();var n=function(e,t){var i={};return _.each(t,function(e){var t={id:e.id,title:e.title};e.originid&&e.originid!=e.id&&(f[e.originid]=e.id);var r=n(t,e.nodes);_.isEmpty(r)||(t.childrens=r),i[t.id]=t}),i},o=n(null,e.viewOfEnergy[0].nodes),c={};_.each(o,function(e){e.childrens&&(c[e.id]=e)}),o=c;var u={energy:o,_id:e.projects.selected};r.Query(i.update,u,function(t){t.err&&v(err),_.each(g,function(e){var t={query:{energyPath:e.id},queryoperate:{set:{energy:"",energyPath:""}}};r.Query(s.update,t,function(e){})}),_.map(f,function(t,n){var i={energy:r.RootEnergycategory(n),energyPath:n,project:e.projects.selected},o={set:{energy:r.RootEnergycategory(t),energyPath:t}};r.Query(s.update,{query:i,queryoperate:o},function(e){})}),h(e.projects.selected),l.AlertSuccess("保存成功")})},t.all([r.QueryPromise(c.info,{}).$promise,r.QueryPromise(u.info,{}).$promise]).then(function(t){if(t[0].err||t[1].err);else{e.projects=angular.isArray(t[0].result)?t[0].result:[t[0].result];var n=l.GetPageItem(a);n?(n=_.find(e.projects,function(e){return e._id==n}),e.projects.selected=n._id):e.projects.length>0&&(e.projects.selected=e.projects[0]._id),e.energycategory=t[1].result}}),e.$watch("projects.selected",function(e){e&&(l.PutPageItem(a,e),h(e))}),e.deleteNode=function(e,t){var n=function(e){e&&(_.each(e.nodes,function(t){n(t),e.originid&&(g[t.originid]=t)}),e.originid&&(g[e.originid]=e))};n(t),e.remove()},e.enable=function(e){e.enable=!e.enable},e.toggle=function(e){e.toggle()},e.newSubItem=function(e,t){var n=e.node;n.nodes||(n.nodes=[]),n.nodes.push({id:"",enable:!0,editing:!0,title:"",origintitle:"",level:n.level+1,parent:t,nodes:[]})},e.edit=function(e){e.editing=!0},e.cancelEditing=function(t,n){n.title.length||n.origintitle.length?(n.editing=!1,n.title=n.origintitle):e.deleteNode(t,n)},e.save=function(e){if(!e.title.length)return alert("请输入分类名称"),!1;if(e.parent){var t=_.find(e.parent.nodes,function(t){return t.id&&t.id.length&&!t.editing?t.title==e.title?(alert("已有相同名称，请确认"),!0):!1:void 0});if(t)return!1}e.editing=!1,e.originid||(e.origintitle=e.title);var n=function(e){e.id=y(e.parent,e.title),g[e.id]&&(g[e.id]=null),_.each(e.nodes,function(e){n(e)})};n(e)},e.sensor=function(t,i){var r=n.open({templateUrl:"sensorSelect.html",controller:"SensorSelect",size:"lg",resolve:{ProjectID:function(){return e.projects.selected},EnergycategoryID:function(){return t.id}}});r.result.then(function(e){},function(){})},e.switchUnitPriceType=function(e){e.unitprice.isnormal=!e.unitprice.isnormal}})}]);
//# sourceMappingURL=index.min.js.map
