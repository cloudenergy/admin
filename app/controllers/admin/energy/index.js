angular.module("app").controller("EnergyIndex",["$scope","SettingMenu","$q","$modal","Energy","API","Auth","Project","UI","Energycategory","base64","Sensor",function(e,n,t,i,r,o,l,c,u,d,a,g){var s="energy.project",f={},y={};l.Check(function(){function l(e){return a.encode(e)}function p(e,n){return e&&e.id&&e.id.length?e.id+"|"+l(n):l(n)}function h(e,n,t){if(n){var i=[];return _.each(n,function(n){n.childrens?n.ischild=!1:n.ischild=!0,n.originid=n.id,n.origintitle=n.title,n.parent=e,n.level=t,n.nodes=h(n,n.childrens,t+1),i.push(n)}),i.sort(function(e,n){return e.title>n.title?1:-1}),i}}function v(n){f={},y={},e.projectSelected=n,o.Query(r.info,{project:n},function(n){if(n.err);else{console.log(n.result);var t=n.result.energy;t||(t={}),_.each(e.energycategory,function(e){t[e._id]||(t[e._id]={id:e._id,childrens:[],ischild:!1});var n=t[e._id];n.unit=e.unit,n.standcol=e.standcol,n.title=e.title}),e.energycategory.sort(function(e,n){return e.title>n.title?1:-1});var i=h(null,t,1);e.viewOfEnergy=[{nodes:i,title:"能耗分类",level:0}]}},m)}function m(e){u.AlertError(e.data.message)}n(function(n){e.menu=n}),e.doSaveEnergy=function(n){n.preventDefault();var t=function(e,n){var i={};return _.each(n,function(e){var n={id:e.id,title:e.title};e.originid&&e.originid!=e.id&&(y[e.originid]=e.id);var r=t(n,e.nodes);_.isEmpty(r)||(n.childrens=r),i[n.id]=n}),i},i=t(null,e.viewOfEnergy[0].nodes),l={};_.each(i,function(e){e.childrens&&(l[e.id]=e)}),i=l,console.log(i);var c={energy:i,_id:e.projectSelected};o.Query(r.update,c,function(n){console.log(n),n.err&&m(err),_.each(f,function(e){var n={query:{energyPath:e.id},queryoperate:{set:{energy:"",energyPath:""}}};o.Query(g.update,n,function(e){e.err||console.log(e)})}),_.map(y,function(n,t){var i={energy:o.RootEnergycategory(t),energyPath:t,project:e.projectSelected},r={set:{energy:o.RootEnergycategory(n),energyPath:n}};console.log(i,r),o.Query(g.update,{query:i,queryoperate:r},function(e){})}),v(e.projectSelected),u.AlertSuccess("保存成功")})},t.all([o.QueryPromise(c.info,{}).$promise,o.QueryPromise(d.info,{}).$promise]).then(function(n){if(n[0].err||n[1].err);else{e.projects=angular.isArray(n[0].result)?n[0].result:[n[0].result];var t=u.GetPageItem(s);t?(t=_.find(e.projects,function(e){return e._id==t}),e.projectSelected=t._id):e.projects.length>0&&(e.projectSelected=e.projects[0]._id),e.energycategory=n[1].result}}),e.$watch("projectSelected",function(e){e&&(u.PutPageItem(s,e),v(e))}),e.deleteNode=function(e,n){var t=function(e){e&&(_.each(e.nodes,function(n){t(n),e.originid&&(f[n.originid]=n)}),e.originid&&(f[e.originid]=e))};t(n),console.log(f),e.remove()},e.enable=function(e){e.enable=!e.enable},e.toggle=function(e){e.toggle()},e.newSubItem=function(e,n){var t=e.node;t.nodes||(t.nodes=[]),t.nodes.push({id:"",enable:!0,editing:!0,title:"",origintitle:"",level:t.level+1,parent:n,nodes:[]})},e.edit=function(e){e.editing=!0},e.cancelEditing=function(n,t){t.title.length||t.origintitle.length?(t.editing=!1,t.title=t.origintitle):e.deleteNode(n,t)},e.save=function(e){if(!e.title.length)return alert("请输入分类名称"),!1;if(e.parent){var n=_.find(e.parent.nodes,function(n){return n.id&&n.id.length&&!n.editing?n.title==e.title?(alert("已有相同名称，请确认"),!0):!1:void 0});if(n)return!1}e.editing=!1,e.originid||(e.origintitle=e.title);var t=function(e){e.id=p(e.parent,e.title),f[e.id]&&(f[e.id]=null),_.each(e.nodes,function(e){t(e)})};t(e),console.log(e,f)},e.sensor=function(n,t){console.log(n,t);var r=i.open({templateUrl:"sensorSelect.html",controller:"SensorSelect",size:"lg",resolve:{ProjectID:function(){return e.projectSelected},EnergycategoryID:function(){return n.id}}});r.result.then(function(e){},function(){})},e.switchUnitPriceType=function(e){e.unitprice.isnormal=!e.unitprice.isnormal}})}]);