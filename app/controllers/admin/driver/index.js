angular.module("app").controller("DriverIndex",["$scope","SettingMenu","$q","$modal","Energy","API","Auth","Project","UI","Customer","base64","Sensor","Driver",function(e,r,t,n,i,o,l,c,u,s,d,a,f){var v="customer.project",p={},g={};l.Check(function(){function i(e,r,t){if(r){var n=[];return _.each(r,function(r){e?r.id=e.id+"/"+r.name:r.id=r.name,r.title=r.name,r.level=t,r.nodes=i(r,r.driver,t+1),r.childrens=null,r.parent=e,n.push(r)}),n.sort(function(e,r){return e.index>r.index?1:-1}),n}}function l(r){p={},g={},e.projectSelected=r,o.Query(s.info,{project:r},function(r){if(r.err);else{var t=r.result;if(t){var n=i(null,t.socities,1);e.viewOfDriver=[{nodes:n,title:"社会属性",level:0}],console.log(e.viewOfDriver)}else e.viewOfDriver=[{nodes:[],title:"社会属性",level:0}]}},d)}function d(e){u.AlertError(e.data.message)}r(function(r){e.menu=r}),e.doSaveCustomer=function(r){r.preventDefault();var t=function(e,r){var n={};return _.each(r,function(e,r){var i={id:e.id,title:e.title,acreage:e.acreage||0,index:r};e.originid&&e.originid!=e.id&&(g[e.originid]=e.id);var o=t(i,e.nodes);o&&(i.childrens=o),n[e.id]=i}),n},n=t(null,e.viewOfDriver[0].nodes);console.log(n,p,g);var i={socities:n,project:e.projectSelected};console.log(i),o.Query(s.update,i,function(r){console.log(r),r.err?d(r.err):o.Query(a.info,{project:e.projectSelected},function(r){r.err||(UpdateSensorSocities(),l(e.projectSelected))})})},t.all([o.QueryPromise(c.info,{}).$promise,o.QueryPromise(f["enum"],{}).$promise]).then(function(r){e.projects=angular.isArray(r[0].result)?r[0].result:[r[0].result];var t=u.GetPageItem(v);t?(t=_.find(e.projects,function(e){return e._id==t}),e.projectSelected=t._id):e.projects.length>0&&(e.projectSelected=e.projects[0]._id),e.Drivers=r[1].result;var n=i(null,e.Drivers,1);e.viewOfDriver=[{nodes:n,title:"驱动列表",level:0}],console.log(e.viewOfDriver)}),e.$watch("projectSelected",function(r){r&&(u.PutPageItem(v,r),e.projectSelected=r)}),e.save=function(e){if(!e.title.length)return alert("请输入分类名称"),!1;if(e.parent){var r=_.find(e.parent.nodes,function(r){return r.id&&r.id.length&&!r.editing?r.title==e.title?(alert("已有相同名称，请确认"),!0):!1:void 0});if(r)return!1}e.editing=!1,e.originid||(e.origintitle=e.title);var t=function(e){e.id=GenereateID(e.parent,e.title),p[e.id]&&(p[e.id]=null),_.each(e.nodes,function(e){t(e)})};t(e),console.log(e,p)},e.OnSelectSensor=function(r){console.log(r);var t=n.open({templateUrl:"sensorSelect.html",controller:"SensorSelect",size:"lg",resolve:{ProjectID:function(){return e.projectSelected},Driver:function(){return r.id}}});t.result.then(function(e){},function(){})}})}]);