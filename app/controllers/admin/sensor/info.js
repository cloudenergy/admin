angular.module("app").controller("SensorIndex",["$scope","$q","$api","$uibModal","Building","API","Auth","UI",function(e,t,n,c,r,s,o,i){e.operateStatus={create:{isEnable:!1,url:"/create"},"delete":{isEnable:!1,url:"/delete"},edit:{isEnable:!1,url:"/edit"},sync:{isEnable:!0,url:"/syncdata"},mask:{isEnable:!1,url:"/mask"}};var l=EMAPP.Account._id+"_sensor_index_search",u=EMAPP.Account._id+"_sensor_index_projectid";o.Check(e.operateStatus,function(){function r(){return e.projects.selected&&n.customer.info({project:e.projects.selected,onlynode:1},function(t){e.customer={enable:e.customer.enable,selected:"ROOT",core:{data:[{id:"ROOT",parent:"#",text:"全部社会属性",state:{selected:!0,opened:!0},icon:"glyphicon glyphicon-th-list"}]},conditionalselect:function(t,n){return e.customer.selected=t.id,e.OnSearch(),!0},plugins:["search","conditionalselect"]},function n(t,c){angular.forEach(t,function(t,r){t.parent=c,t.text=t.title,Object.keys(t.child).length?t.icon="glyphicon glyphicon-th-list":t.icon="glyphicon glyphicon-file",n(t.child,t.id),e.customer.core.data.push(t)})}(t.result,"ROOT")}).$promise}function o(){return e.projects.selected&&n.building.info({project:e.projects.selected},function(t){var n="sensor.building",c=i.GetPageItem(n);e.buildings=[],angular.forEach(t.result,function(e){this.push(e)},e.buildings),e.buildings.select=function(){i.PutPageItem(n,e.buildings.selected),e.OnSearch()},angular.forEach(e.buildings,function(t){t._id===c&&(e.buildings.selected=t._id)}),e.buildings.selected=e.buildings.selected||(e.buildings[0]||{})._id}).$promise}function a(){return e.projects.selected&&n.device.type({project:e.projects.selected},function(t){e.DeviceTypes=[{id:void 0,title:"全部设备"}],angular.forEach(t.result,function(e){this.push({id:e.id,title:e.name})},e.DeviceTypes),e.DeviceTypes.selected=e.DeviceTypes.selected||(e.DeviceTypes[0]||{}).id,e.DeviceTypes.select=function(){e.OnSearch()}}).$promise}function d(){n.business.monitor({devicetype:e.DeviceTypes.selected||void 0,building:!e.customer.enable&&e.buildings.selected||void 0,project:e.projects.selected,key:i.GetPageItem(l)||void 0,mode:"SENSOR",usesocity:e.customer.enable||void 0,socitynode:e.customer.enable&&e.customer.selected||void 0,pageindex:e.currentPage,pagesize:15},function(t){t=t.result[e.projects.selected],angular.forEach(t.detail,function(e){this.push(e)},e.viewOfSensor=[]),e.pageSize=t.paging.pagesize,e.itemsTotal=t.paging.count})}e.currentPage=i.GetPageIndex(),n.project.info(function(n){n.selected=localStorage.getItem(u),e.projects=angular.isArray(n.result)?n.result:n.result&&[n.result]||[],e.projects.select=function(){e.projects.selected&&(localStorage.setItem(u,e.projects.selected),e.customer=e.customer?{enable:e.customer.enable}:{enable:!0},e.buildings=[],e.DeviceTypes=[],t.all([r(),o(),a()]).then(e.OnSearch))},angular.forEach(e.projects,function(t){t._id===n.selected&&(e.projects.selected=t._id)}),e.projects.selected=e.projects.selected||(e.projects[0]||{})._id,e.projects.select()}),e.$watch("currentPage",function(t){return void 0==t?void(e.currentPage=i.GetPageIndex()):(i.PutPageIndex(void 0,e.currentPage),void(e.viewOfSensor&&e.OnSearch()))}),e.$watch("customer.enable",function(t){e.viewOfSensor&&e.OnSearch()}),e.OnSearch=function(){i.PutPageItem(l,e.searchKey),d()},e.OnMask=function(e){n.sensorchannel.update({id:e.id,mask:!e.mask},function(t){t.err||(e.mask=!e.mask)})},e.OnMaskAll=function(t){confirm("是否确定"+(t?"屏蔽":"启用")+"所有通道？")&&angular.forEach(e.viewOfSensor,function(e){angular.forEach(e.channels,function(e){n.sensorchannel.update({id:e.id,mask:t},function(){e.mask=t})})})},e.OnSync=function(t,n){t.title=n.title;var r=c.open({templateUrl:"sensorSync.html",controller:"SensorSync",size:"lg",resolve:{SensorIns:function(){return t}}});r.result.then(function(t){e.editUser.resource.sensor||(e.editUser.resource.sensor=[]),e.editUser.resource.sensor=_.difference(e.editUser.resource.sensor,t.unselect),e.editUser.resource.sensor=_.union(e.editUser.resource.sensor,t.select)},function(){})},e.OnSyncAll=function(){confirm("是否确定同步所有数据异常的传感器？")&&n.sensorchannel.syncdata({project:e.projects.selected},function(t){t.err?console.error(t):(alert("同步完成"),e.OnSearch())})},e.onRemove=function(e,t){n.sensorchannel["delete"]({id:e.id},function(n){delete t.channels[e.funcid]},function(e){i.AlertError(e.data.message)})},e.OnSensorAttribute=function(t){var n=c.open({templateUrl:"sensorAttribute.html",controller:"sensorAttribute",size:"lg",resolve:{SensorSUID:function(){var e=s.ParseSensorID(t.id);return e?e.buildingID+e.gatewayID+e.addrID+e.meterID:null},ProjectID:function(){return e.projects.selected}}});n.result.then(function(){},function(){})}}),e.importSensor=function(){var t=e,n=!1;c.open({templateUrl:"importSensor.html",size:"md",controller:["$scope","$timeout","$modalInstance","project","building","customer",function(e,c,r,s,o,l){e.actionURL="/api/import/importsensorchannel",e.project=s,e.building=o,e.customer=l,e.ok=function(){r.close(),n&&t.OnSearch()},e.OnUploadComplete=function(e){return e.code?i.AlertError(e.result,e.message):(n=!0,i.AlertSuccess("导入成功")),!1},e.cancel=r.dismiss}],resolve:{project:function(){return e.projects.selected},building:function(){return e.buildings.selected},customer:function(){return e.customer.selected}}})}}]);