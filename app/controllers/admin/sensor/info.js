EMAPP.register.controller("SensorIndex",["$scope","$rootScope","$q","$api","$uibModal","Building","API","Auth","UI",function(e,n,t,r,s,c,o,i,l){e.operateStatus={create:{isEnable:!1,url:"/create"},"delete":{isEnable:!1,url:"/delete"},edit:{isEnable:!1,url:"/edit"},sync:{isEnable:!0,url:"/syncdata"},mask:{isEnable:!1,url:"/mask"}};var u="sensor.searchKey";i.Check(e.operateStatus,function(){function n(){return e.projects.selected&&r.customer.info({project:e.projects.selected,onlynode:1},function(n){e.customer={enable:e.customer.enable,core:{data:[{id:"ROOT",parent:"#",text:"全部社会属性",state:{opened:!0},icon:"glyphicon glyphicon-th-list"}]},conditionalselect:function(n,t){return e.customer.selected=n.id,e.OnSearch(),!0},plugins:["search","conditionalselect"]},function t(n,r){angular.forEach(n,function(n,s){n.parent=r,n.text=n.title,"ROOT"===r&&0===s&&(n.state={selected:!0,opened:!0}),Object.keys(n.child).length?n.icon="glyphicon glyphicon-th-list":n.icon="glyphicon glyphicon-file",t(n.child,n.id),e.customer.core.data.push(n)})}(n.result,"ROOT")}).$promise}function c(){return e.projects.selected&&r.building.info({project:e.projects.selected},function(n){var t="sensor.building",r=l.GetPageItem(t);e.buildings=[],angular.forEach(n.result,function(e){this.push(e)},e.buildings),e.buildings.select=function(){l.PutPageItem(t,e.buildings.selected._id),e.OnSearch()},e.buildings.selected=e.buildings[0],angular.forEach(e.buildings,function(n){n._id===r&&(e.buildings.selected=n)})}).$promise}function i(){return e.projects.selected&&r.device.type({project:e.projects.selected},function(n){e.DeviceTypes=[{id:void 0,title:"全部设备"}],angular.forEach(n.result,function(e){this.push({id:e.id,title:e.name})},e.DeviceTypes),e.DeviceTypes.selected=e.DeviceTypes[0].id,e.DeviceTypes.select=function(){e.OnSearch()}}).$promise}function a(){r.business.monitor({devicetype:e.DeviceTypes.selected||void 0,building:!e.customer.enable&&e.buildings.selected._id||void 0,project:e.projects.selected,key:l.GetPageItem(u)||void 0,mode:"SENSOR",usesocity:e.customer.enable||void 0,socitynode:e.customer.enable&&e.customer.selected||void 0,pageindex:e.currentPage,pagesize:15},function(n){n=n.result[e.projects.selected],angular.forEach(n.detail,function(e){this.push(e)},e.viewOfSensor=[]),e.pageSize=n.paging.pagesize,e.itemsTotal=n.paging.count})}e.currentPage=l.GetPageIndex(),r.project.info(function(r){var s="sensor.project";e.projects=angular.isArray(r.result)?r.result:[r.result],e.projects.select=function(){l.PutPageItem(s,e.projects.selected),e.customer=e.customer?{enable:e.customer.enable}:{enable:!0},e.buildings=[],e.DeviceTypes=[],t.all([n(),c(),i()]).then(e.OnSearch)},e.projects.selected=l.GetPageItem(s)||(e.projects[0]||{})._id,e.projects.select()}),e.$watch("currentPage",function(n){return void 0==n?void(e.currentPage=l.GetPageIndex()):(l.PutPageIndex(void 0,e.currentPage),void(e.viewOfSensor&&e.OnSearch()))}),e.$watch("customer.enable",function(n){e.viewOfSensor&&e.OnSearch()}),e.OnSearch=function(){l.PutPageItem(u,e.searchKey),a()},e.OnMask=function(e){r.sensorchannel.update({id:e.id,mask:!e.mask},function(n){n.err||(e.mask=!e.mask)})},e.OnMaskAll=function(n){confirm("是否确定"+(n?"屏蔽":"启用")+"所有通道？")&&angular.forEach(e.viewOfSensor,function(e){angular.forEach(e.channels,function(e){r.sensorchannel.update({id:e.id,mask:n},function(){e.mask=n})})})},e.OnSync=function(n,t){n.title=t.title;var r=s.open({templateUrl:"sensorSync.html",controller:"SensorSync",size:"lg",resolve:{SensorIns:function(){return n}}});r.result.then(function(n){e.editUser.resource.sensor||(e.editUser.resource.sensor=[]),e.editUser.resource.sensor=_.difference(e.editUser.resource.sensor,n.unselect),e.editUser.resource.sensor=_.union(e.editUser.resource.sensor,n.select)},function(){})},e.OnSyncAll=function(){confirm("是否确定同步所有数据异常的传感器？")&&r.sensorchannel.syncdata({project:e.projects.selected},function(n){n.err?console.error(n):(alert("同步完成"),e.OnSearch())})},e.onRemove=function(e,n){r.sensorchannel["delete"]({id:e.id},function(t){delete n.channels[e.funcid]},function(e){l.AlertError(e.data.message)})},e.OnSensorAttribute=function(n){var t=s.open({templateUrl:"sensorAttribute.html",controller:"sensorAttribute",size:"lg",resolve:{SensorSUID:function(){var e=o.ParseSensorID(n.id);return e?e.buildingID+e.gatewayID+e.addrID+e.meterID:null},ProjectID:function(){return e.projects.selected}}});t.result.then(function(){},function(){})}}),e.importSensor=function(){var n=e,t=!1;s.open({templateUrl:"importSensor.html",size:"md",controller:["$scope","$timeout","$modalInstance","project","building","customer",function(e,r,s,c,o,i){e.actionURL="/api/import/importsensorchannel",e.project=c,e.building=o,e.customer=i,e.ok=function(){s.close(),t&&n.OnSearch()},e.OnUploadComplete=function(e){return e.code?l.AlertError(e.result,e.message):(t=!0,l.AlertSuccess("导入成功")),!1},e.cancel=s.dismiss}],resolve:{project:function(){return e.projects.selected},building:function(){return e.buildings.selected._id},customer:function(){return e.customer.selected}}})}}]);