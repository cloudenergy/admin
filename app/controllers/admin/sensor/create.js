EMAPP.register.controller("SensorCreate",["$scope","$location","SettingMenu","Sensor","Collector","Energy","Customer","Building","API","Auth","UI","$stateParams",function(e,n,i,s,t,o,r,c,l,u,a,d){u.Check(function(){function t(e,n,i){if(n){var s=[];return _.each(n,function(n){n.childrens?n.ischild=!1:n.ischild=!0,n.parent=e,n.level=i,n.nodes=t(n,n.childrens,i+1),s.push(n)}),s.sort(function(e,n){return e.title>n.title?1:-1}),s}}function r(n){e.alertError(n.data.message)}i(function(n){e.menu=n}),e.sensor={mask:!1,comi:"d*1"},e.buildingID=d.building;var u,f=d.page;e.submit=function(i){var t=angular.copy(e.sensor);if(!u)return void alert("请选择传感器能耗类型");t.project=e.sensor.building.project._id,t.building=e.buildingID,u&&(t.energy=l.RootEnergycategory(u.id),t.energyPath=u.id);var o=[],c=function(e){e&&e.nodes&&_.each(e.nodes,function(e){e.isSelect&&o.push(e.id),c(e)})};c(e.viewOfCustomer[0]),t.socity=o,l.Query(s.info,{sids:[t.sid]},function(i){return console.log(i),i.result&&i.result.length>0?void(e.alert={type:"danger",msg:"标识已经存在"}):void l.Query(s.add,t,function(i){i.code?a.AlertError(i.message):n.path("/admin/sensor/info").search({page:f,building:e.buildingID})},r)},function(e){console.log(e)})},l.Query(c.info,{id:e.buildingID},function(n){n.err||(e.building=n.result,e.building&&(e.sensor.building=e.building),l.Query(o.info,{project:e.building.project._id},function(n){if(console.log(n),n.err);else{var i=n.result;if(i){var s=t(null,i.energy,1);e.viewOfEnergy=[{nodes:s,title:"能耗分类",level:0}]}else e.viewOfEnergy=[{nodes:[],title:"能耗分类",level:0}]}}))},r),e.addSocity=function(n){e.socities=_.reject(e.socities,function(e){return e._id==n._id}),e.sensorsocities.push(n)},e.removeSocity=function(n){e.sensorsocities=_.reject(e.sensorsocities,function(e){return e._id==n._id}),e.socities.push(n)},e.SwitchSocity=function(e,n){e.preventDefault(),n.isEnable=!n.isEnable,n.isEnable?n.isEnable=!1:n.isEnable=!0},e.sensorsocities=[],e.onChoice=function(e){e.isSelect=!e.isSelect;var n=function(e,i){e&&e.nodes&&e.nodes.length&&(_.each(e.nodes,function(e){n(e,i),e.isSelect=i}),e.isSelect=i)};n(e,e.isSelect)},e.onEnergyChoice=function(e){e.nodes||(console.log(e),u&&(u.isSelect=!1),u=e,u.isSelect=!0)},e.OnCollapsePayStatus=function(){e.sensor.paystatus&&"NONE"!=e.sensor.paystatus?e.sensor.paystatus="NONE":e.sensor.paystatus="BYSELF"},e.OnSelectPayMode=function(n,i){n.preventDefault(),e.sensor.paystatus=i}})}]);