EMAPP.register.controller("SensorCreate",["$scope","$location","SettingMenu","Sensor","Collector","Energy","Customer","Building","API","Auth","UI","$stateParams",function(e,i,n,t,s,o,r,l,c,u,a,d){u.Check(function(){function s(e,i,n){if(i){var t=[];return _.each(i,function(i){i.originid=i.id,i.origintitle=i.title,i.id=i.id,i.title=i.title,i.acreage=i.acreage||0,i.level=n,i.nodes=s(i,i.childrens,n+1),i.childrens=null,i.parent=e,i.isSelect=!1,t.push(i)}),t.sort(function(e,i){return e.title>i.title?1:-1}),t}}function u(e,i,n){if(i){var t=[];return _.each(i,function(i){i.childrens?i.ischild=!1:i.ischild=!0,i.parent=e,i.level=n,i.nodes=u(i,i.childrens,n+1),t.push(i)}),t.sort(function(e,i){return e.title>i.title?1:-1}),t}}function f(i){e.alertError(i.data.message)}n(function(i){e.menu=i}),e.sensor={mask:!1,comi:"d*1"},e.buildingID=d.building;var g,p=d.page;e.submit=function(n){var s=angular.copy(e.sensor);if(!g)return void alert("请选择传感器能耗类型");s.project=e.sensor.building.project._id,s.building=e.buildingID,g&&(s.energy=c.RootEnergycategory(g.id),s.energyPath=g.id);var o=[],r=function(e){e&&e.nodes&&_.each(e.nodes,function(e){e.isSelect&&o.push(e.id),r(e)})};r(e.viewOfCustomer[0]),s.socity=o,c.Query(t.info,{sids:[s.sid]},function(n){return console.log(n),n.result&&n.result.length>0?void(e.alert={type:"danger",msg:"标识已经存在"}):void c.Query(t.add,s,function(n){n.code?a.AlertError(n.message):i.path("/admin/sensor/info").search({page:p,building:e.buildingID})},f)},function(e){console.log(e)})},c.Query(l.info,{id:e.buildingID},function(i){i.err||(e.building=i.result,e.building&&(e.sensor.building=e.building),c.Query(o.info,{project:e.building.project._id},function(i){if(console.log(i),i.err);else{var n=i.result;if(n){var t=u(null,n.energy,1);e.viewOfEnergy=[{nodes:t,title:"能耗分类",level:0}]}else e.viewOfEnergy=[{nodes:[],title:"能耗分类",level:0}]}}),c.Query(r.info,{project:e.building.project._id},function(i){if(i.err);else{var n=i.result;if(n){var t=s(null,n.socities,1);e.viewOfCustomer=[{nodes:t,title:"社会属性",level:0}]}else e.viewOfCustomer=[{nodes:[],title:"社会属性",level:0}]}}))},f),e.addSocity=function(i){e.socities=_.reject(e.socities,function(e){return e._id==i._id}),e.sensorsocities.push(i)},e.removeSocity=function(i){e.sensorsocities=_.reject(e.sensorsocities,function(e){return e._id==i._id}),e.socities.push(i)},e.SwitchSocity=function(e,i){e.preventDefault(),i.isEnable=!i.isEnable,i.isEnable?i.isEnable=!1:i.isEnable=!0},e.sensorsocities=[],e.onChoice=function(e){e.isSelect=!e.isSelect;var i=function(e,n){e&&e.nodes&&e.nodes.length&&(_.each(e.nodes,function(e){i(e,n),e.isSelect=n}),e.isSelect=n)};i(e,e.isSelect)},e.onEnergyChoice=function(e){e.nodes||(console.log(e),g&&(g.isSelect=!1),g=e,g.isSelect=!0)},e.OnCollapsePayStatus=function(){e.sensor.paystatus&&"NONE"!=e.sensor.paystatus?e.sensor.paystatus="NONE":e.sensor.paystatus="BYSELF"},e.OnSelectPayMode=function(i,n){i.preventDefault(),e.sensor.paystatus=n}})}]);