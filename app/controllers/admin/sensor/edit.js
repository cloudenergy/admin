EMAPP.register.controller("SensorEdit",["$scope","$stateParams","$location","SettingMenu","Sensor","Collector","Energy","Customer","Building","API","Auth","UI",function(e,n,i,t,s,o,r,l,c,u,a,d){a.Check(function(){function o(e,n,i){if(n){var t=[];return _.each(n,function(n){n.originid=n.id,n.origintitle=n.title,n.id=n.id,n.title=n.title,n.acreage=n.acreage||0,n.level=i,n.nodes=o(n,n.childrens,i+1),n.childrens=null,n.parent=e,n.isSelect=n.isSelect,t.push(n)}),t.sort(function(e,n){return e.title>n.title?1:-1}),t}}function a(e,n,i){if(n){var t=[];return _.each(n,function(n){n.childrens?n.ischild=!1:n.ischild=!0,n.parent=e,n.level=i,n.nodes=a(n,n.childrens,i+1),t.push(n)}),t.sort(function(e,n){return e.title>n.title?1:-1}),t}}t(function(n){e.menu=n});var d,f=n.page;e.submit=function(n){var t=angular.copy(e.sensor);t.project=e.sensor.building.project._id,t.building=e.sensor.building._id,d?(t.energy=u.RootEnergycategory(d.id),t.energyPath=d.id):(t.energy="",t.energyPath="");var o=t.building,r=function(){console.log(t),u.Query(s.update,t,function(e){e.err||(f?i.path("/admin/sensor/info").search({page:f,building:o}):i.path("/admin/sensor/info").search({building:o}))})},l=[],c=function(e){e&&e.nodes&&_.each(e.nodes,function(e){e.isSelect&&l.push(e.id),c(e)})};c(e.viewOfCustomer&&e.viewOfCustomer[0]||null),t.socity=l,e.sid!=t.sid?u.Query(s.info,{sids:[t.sid]},function(e){return console.log(e),e.result&&e.result.length>0?void alert("传感器标识已经存在"):void r()},function(e){console.log(e)}):r()},u.Query(s.channelinfo,{id:n.id},function(n){n.err||(e.sensor=n.result[0],console.log(e.sensor),e.sid=e.sensor.sid,e.building=e.sensor.building,u.Query(c.info,{id:e.sensor.building.id},function(n){n.err||(u.Query(r.info,{project:e.building.project},function(n){if(n.err);else{var i=n.result;if(e.sensor.energyPath){var t,s=e.sensor.energyPath.split("|"),o=i.energy;_.each(s,function(e){o&&(t?t+="|"+e:t=e,o=o[t],o&&(o&&!o.childrens?(o.isSelect=!0,d=o):o=o.childrens))})}if(i){var r=a(null,i.energy,1);e.viewOfEnergy=[{nodes:r,title:"能耗分类",level:0}]}else e.viewOfEnergy=[{nodes:[],title:"能耗分类",level:0}]}}),u.Query(l.info,{project:e.building.project},function(n){if(n.err);else{if(!n||!n.result)return;var i=n.result;if(i.socities){_.each(e.sensor.socity,function(e){var n,t=e.split("|")||[e],s=i.socities;_.each(t,function(e){s&&(n?n+="|"+e:n=e,s=s[n],s&&(s.isSelect=!0,s=s.childrens))})});var t=o(null,i.socities,1);e.viewOfCustomer=[{nodes:t,title:"社会属性",level:0}],console.log(e.viewOfCustomer)}else e.viewOfCustomer=[{nodes:[],title:"社会属性",level:0}]}}))}))}),e.onChoice=function(e){e.isSelect=!e.isSelect;var n=function(e,i){e&&e.nodes&&e.nodes.length&&(_.each(e.nodes,function(e){n(e,i),e.isSelect=i}),e.isSelect=i)};n(e,e.isSelect)},e.onEnergyChoice=function(e){e.nodes||(console.log(e),d&&(d.isSelect=!1),d=e,d.isSelect=!0)},e.OnCollapsePayStatus=function(){e.sensor.paystatus&&"NONE"!=e.sensor.paystatus?e.sensor.paystatus="NONE":e.sensor.paystatus="BYSELF"},e.OnSelectPayMode=function(n,i){n.preventDefault(),e.sensor.paystatus=i}})}]);