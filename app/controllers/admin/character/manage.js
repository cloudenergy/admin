EMAPP.register.controller("characterManage",["$scope","$stateParams","$location","SettingMenu","UrlPath","$cookies","Account","$q","Project","Building","Customer","Collector","Sensor","Auth","API","UI","Character",function(e,n,r,o,t,c,a,i,l,u,s,d,f,h,v,g,p){var A={},y=n.id;h.Check(function(){function n(){var n=i.defer(),r=function(e){var n=function(e,r){_.map(e,function(e,o){e.leaf?A[r+"/"+o]=!0:n(e,"/"==o?"":r+"/"+o)})};n(e,"")};return y?v.Query(p.info,{id:y},function(o){o.err?n.reject(o.err):(e.character=o.result,r(o.result.rule),n.resolve())}):n.resolve(),n.promise}e.OnSave=function(n){function o(e,n){"/"!=e._id&&(n+=e._id),e.select&&t.push(n),void 0!=e.nodes&&e.nodes.length>0&&_.each(e.nodes,function(e){o(e,n+"/")})}n.preventDefault();var t=new Array;o(e.urlpath[0],""),console.log(t);var c={};_.each(t,function(e){var n=e.split("/"),r=c;_.each(n,function(e,o){""==e&&(e="/");var t=!1;o==n.length-1&&(t=!0),r[e]||(r[e]={}),r[e].leaf=t,r=r[e]})}),console.log(c),e.character.rule=c;var a=function(){r.path("/admin/character/info")};y?v.Query(p.update,e.character,function(e){return e.code?void g.AlertError(e.message):void a()}):v.Query(p.add,e.character,function(e){return console.log(e),e.code?void g.AlertError(e.message):void a()})},n().then(function(){v.Query(t.info,{},function(n){if(n.err);else{var r={_id:"/",nodes:new Array};_.each(n.result,function(e){var n=e._id.split("/"),o=r;_.each(n,function(r,t){if(""!=r){var c=n.length==t+1,a=_.find(o.nodes,function(e){return e._id==r});void 0==a&&(c?(a={_id:r,url:e,desc:e.desc||"",enable:e.enable,select:!1,nodes:new Array},a.select=!!A[e._id]):a={_id:r,desc:e.desc||"",select:!1,nodes:new Array},o.nodes.push(a)),o=a}})}),console.log(r),e.urlpath=[r]}})}),e.enable=function(e){e.select=!e.select},e.toggle=function(e){console.log(e),e.toggle()},e.EnableSubNode=function(e,n){console.log(e);var r=function(e){e&&_.each(e.nodes,function(e){return e.select=n,r(e)})};r(e)}})}]);